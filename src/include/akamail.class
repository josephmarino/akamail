<?
///
// +--------------------------------------------------------------------------------------------------------+
// | AKA Mail - Revision 1.0                                                                                |
// | Copyright (c) 2003 AKA Link Communications Corporation, Joseph P. Marino, Jonathan Fortin              |
// +--------------------------------------------------------------------------------------------------------+
// | Authors: Joseph P. Marino <joseph@marino.net> and Jonathan Fortin <jonathan@fortin.com>                |
// +--------------------------------------------------------------------------------------------------------+
// | AGPLv3 License                                                                                         |
// |                                                                                                        |
// | This file is part of AKA Mail.                                                                         |
// |                                                                                                        |
// | AKA Mail is free software: you can redistribute it and/or modify it under the terms of the             |
// | GNU Affero General Public License as published by the Free Software Foundation, either version 3       |
// | of the License, or (at your option) any later version.                                                 |
// |                                                                                                        |
// | AKA Mail is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even     |
// | the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                           |
// |                                                                                                        |
// | See the GNU Affero General Public License for more details.                                            |
// |                                                                                                        |
// | You should have received a copy of the GNU Affero General Public License along with AKA Mail.          |
// | If not, see <https://www.gnu.org/licenses/>.                                                           |
// +--------------------------------------------------------------------------------------------------------+
///

class Mail {
	
	var $server		= array(
					'main'		=> 'mail.akalink.com',
					'ip'		=> '64.23.80.202',
					'port'		=> 110,
					'socket'	=> FALSE,
					'eof'		=> 0,
					'appletlicense' => 1744433878,
				);
				
	var $tpl		= array(
					'php'		=> '/home/www/akalink.com/mail.akalink.com/include/tpl/php',
					'html'		=> '/home/www/akalink.com//mail.akalink.com/include/tpl/html'
				);
				
	var $path		= array(
					'data'		=> '/usr/local/akld/www/mail.akalink.com/data',
					'vpopdomain'	=> '/usr/local/vpopmail/domains'
				);
				
	var $bin		= array(
					'autorpd'	=> '/usr/local/bin/autoresponder',
					'antivrs'	=> '/usr/local/bin/uvscan',
					'aspell'	=> '/usr/local/bin/aspell',
					'vpasswd'	=> '/usr/local/vpopmail/bin/vpasswd'
				);
				
	var $errorcode		= array(
					'01'		=> 'Please contact technical support $techsupport.',
					'02'		=> 'Please contact technical support $techsupport.',
					'03'		=> 'Invalid username.',
					'04'		=> 'New password confirmation failed.',
					'05'		=> 'New password must be in between 4 to 16 characters long.',
					'06'		=> 'Your credentials have been successfully restored.',
					'07'		=> 'Folder $folder successfully created.',
					'08'		=> 'Invalid folder $folder name.',
					'09'		=> 'Folder $folder already existant.',
					'10'		=> 'Selected e-mail message(s) successfully deleted.',
					'11'		=> 'Please select a message to delete.',
					'12'		=> '$cntmsg message(s) in your $folder folder were successfully deleted.',
					'13'		=> '$cntblock message(s) blocked.',
					'14'		=> 'Please select an e-mail message to block.',
					'15'		=> 'Selected e-mail messages successfully moved to $folder.',
					'16'		=> 'Please select an e-mail messages to move.',
					'17'		=> 'Mail folder does not exist.',
					'18'		=> 'Selected e-mail messages already exist in this folder.',
					'19'		=> 'Please select a folder to move your e-mail messages to.',
					'20'		=> 'Status of selected e-mail messages have been successfully updated.',
					'21'		=> 'Please select e-mail messages.',
					'22'		=> '$cntmsg new e-mail(s) received.',
					'23'		=> '$folder is currently being used by one of your e-mail accounts.',
					'24'		=> 'Selected folders successfully deleted.',
					'25'		=> 'Please select a folder to delete.',
					'26'		=> 'Please select a folder name in between 1 to 10 characters long containing no spaces.',
					'27'		=> 'Folders successfully renamed.',
					'28'		=> 'Sorry, your primary e-mail account can not be deleted.',
					'29'		=> 'E-mail account(s) successfully deleted.',
					'30'		=> '$host is currently unavailable or does not exist.',
					'31'		=> 'Your login credentials are incorrect.',
					'32'		=> 'Required information is missing or is invalid.',
					'33'		=> 'Mail acccount \'$nick\' successfully updated.',
					'34'		=> 'Your hostname and login may not be duplicated.',
					'35'		=> 'Mail acccount \'$nick\' successfully added.',
					'36'		=> 'Mail account ID unexistant.',
					'37'		=> 'Contact information succesfully updated.',
					'38'		=> 'Your password has successfully been updated.',
					'39'		=> 'Your current password is invalid.',
					'40'		=> 'New Password confirmation failed.',
					'41'		=> 'New password must in between 4 to 16 characters.',
					'42'		=> 'E-Signature successfully deleted.',
					'43'		=> 'Existant E-signature required.',
					'44'		=> 'Invalid signature name.',
					'45'		=> 'Your E-Signature must contain more than two characters.',
					'46'		=> 'E-signature $name name successfully registered.',
					'47'		=> 'E-signature $name name successfully updated.',
					'48'		=> 'Thank You for your Feedback about AKAMail.',
					'49'		=> 'We already have received your feedback, Thank You.',
					'50'		=> 'Please provide us with a little bit more feedback.',
					'51'		=> 'Please make a selection.',
					'52'		=> 'General preferences successfully updated.',
					'53'		=> 'Spam filtering options successfully updated.',
					'54'		=> '$cntrm mail filter(s) successfully deleted.',
					'55'		=> 'Select a blocked e-mail address to delete.',
					'56'		=> 'Invalid domain name or e-mail address.',
					'57'		=> 'E-mail filter already existant.',
					'58'		=> 'E-mail filter text matches an existant e-mail account.',
					'59'		=> 'E-mail filter may not filter akalink.com.',
					'60'		=> 'Incoming mail filter activated for \'$text\'.',
					'61'		=> 'Subject must be between 1 to 64 characters long.',
					'62'		=> 'Message must be between 1 to 10240 characters long.',
					'63'		=> 'Please select a valid date.',
					'64'		=> 'Auto responder successfully enabled.',
					'65'		=> 'Auto responder successfully disabled.',
					'66'		=> 'Sorry, your Express Book can only hold 5 e-mail addresses.',
					'67'		=> '$cnt Attachment(s) successfully deleted.',
					'68'		=> 'Please select an attachment to delete.',
					'69'		=> 'Your e-mail has been successfully sent to $email.',
					'70'		=> 'Your e-mail has been successfully sent to $recptcnt recipients.',
					'71'		=> 'You have exceeded your $send_cnt e-mail per day quota.',
					'72'		=> 'Your e-mail has been successfully saved to $folder.',
					'73'		=> 'You have exceeded your Inbox quota, please delete some e-mail messages to free up space or <a href="http://my.akalink.com" target="_blank">click here</a> to purchase a larger Inbox with more space.',
					'74'		=> 'Please select a file to attach.',
					'75'		=> '$totalgood file(s) successfully attached to your e-mail.',
					'76'		=> 'You cannot exceed a total size of $file_size MB of file attachments.',
					'77'		=> 'You cannot exceed $file_cnt file(s) attachments.',
					'78'		=> 'Mail message ID unexistant.',
					'79'		=> 'Please select a Contact ID.',
					'80'		=> 'Quick contact successfully added.',
					'81'		=> 'Selected contacts successfully deleted.',
					'82'		=> 'Please select a contact to delete.',
					'83'		=> 'Selected group(s) successfully deleted.',
					'84'		=> 'Please select a group to delete.',
					'85'		=> 'Please select a group name in between 1 to 10 characters long containing no spaces.',
					'86'		=> '$group is already existant in your addressbook.',
					'87'		=> 'Group $group registered.',
					'88'		=> 'Selected contact(s) successfully moved.',
					'89'		=> 'Select a contact to move.',
					'90'		=> 'Please enter a valid search keyword.',
					'91'		=> '$bookcnt results found containing \'$keyword\'.',
					'92'		=> 'No results found containing \'$keyword\'.',
					'93'		=> 'A person in your address book already has that e-mail address ($email).',
					'94'		=> 'Your address book is currently empty.',
					'95'		=> 'Invalid export format selected.',
					'96'		=> 'AKAMail could not read the format of the file you are trying to import.',
					'97'		=> '$count contacts successfully imported.',
					'98'		=> 'Invalid file.',
					'99'		=> 'Invalid CSV file format.',
					'100'		=> '$group is unexistant in your address book.',
					'101'		=> 'Your address book is currently empty.',
					'102'		=> 'There is currently no contacts in your addressbook matching your selected options.',
					'103'		=> 'Please enter a personal contact information for this person.',
					'104'		=> 'Contact ID unexistant.',
					'105'		=> 'Personal contact information successfully updated.',
					'106'		=> 'Personal contact information successfully added.',
					'107'		=> 'Please enter a business contact information for this person.',
					'108'		=> 'Business contact information successfully updated.',
					'109'		=> 'Business contact information successfully added.',
					'110'		=> 'Existant Contact ID required.',
					'111'		=> 'Contact notes successfully updated.',
					'112'		=> 'Contact notes may not exceed 10240 characters.',
					'113'		=> 'Maximum folder creation limit exceeded.',
					'114'		=> 'Maximum Address Book group creation limit exceeded.',
					'115'		=> '$cnt message(s) successfully recovered to your Inbox.',
					'116'		=> 'Please select an e-mail message to recover.'
					
				);	
	
	var $tel                = array(
                                        'billing'       => '1888-333-LINK',
                                        'sales'         => '1888-123-LINK',
                                        'techsupport'   => '1888-555-LINK'
                                        );

	var $error 		= array(
					'result'	=> '',
					'fatal'		=> '',
					'xmark' 	=> '<img src="/img/xmark.gif" width="12" height="16">'
					);
					
	var $email		= array(
					'defaultfrom'	=> 'postmaster@akalink.com',
					'feedback'	=> 'support@akalink.com',
					'spambounce'	=> 'MAILER-DAEMON@akalink.com',
					'ceo'		=> 'ceo@akalink.com',
					'support'	=> 'support@akalink.com'
				);
	
	var $timeout		= array(
					'connect'	=> 5,
					'func_cache'	=> 86400	
				);
	
	var $limit		= array(
					'login'			=> 64,
					'min_passwd'		=> 4,
					'max_passwd'		=> 16,
					'readbuffer'		=> 512,
					'min_maiden'		=> 2,
					'max_maiden'		=> 20,
					'bdate'			=> 10,
					'max_msg_size'		=> 10485760,
					'page_wait_sec'		=> 900,
					'folderlen'		=> 10,
					'bookgrouplen'		=> 10,
					'signlen'		=> 32,
					'send_cnt'		=> 100,
					'inbox_size'		=> 20971520,
					'file_cnt'		=> 10,
					'file_size'		=> 10485760,
					'max_folder'		=> 128,
					'max_book_group'	=> 128
				);
	
	var $gc			= array(
					'feedback'		=> 2592000,
					'receipt'		=> 604800,
					'stat'			=> 2592000
				);
				
	var $db			= array(
					'ip'		=> 'localhost',
					'name'		=> 'akamail',
					'user'		=> 'root',
					'passwd'	=> 'b4l00g4',
					'link'		=> FALSE
				);
	
	var $addrbook		= array(
					'sort'		=> 'pfname ASC',
					'max_xprs'	=> 5
				);
	
	var $compose		= array(
					'max_msg_size'	=> 1048576,
					'wordwrap'	=> 75
				);
	
	var $addrindexarr	= array(
					'country'	=> array('US' => 0,'CA' => 1,'AF' => 2,'AL' => 3,'DZ' => 4,'AS' => 5,'AD' => 6,'AO' => 7,'AI' => 8,'AQ' => 9,'AG' => 10,'AR' => 11,'AM' => 12,'AW' => 13,'AU' => 14,'AT' => 15,'AZ' => 16,'BS' => 17,'BH' => 18,'BD' => 19,'BB' => 20,'BY' => 21,'BE' => 22,'BZ' => 23,'BJ' => 24,'BM' => 25,'BT' => 26,'BO' => 27,'BA' => 28,'BW' => 29,'BV' => 30,'BR' => 31,'IO' => 32,'BN' => 33,'BG' => 34,'BF' => 35,'BI' => 36,'KH' => 37,'CM' => 38,'CV' => 39,'KY' => 40,'CF' => 41,'TD' => 42,'CL' => 43,'CN' => 44,'CX' => 45,'CC' => 46,'CO' => 47,'KM' => 48,'CG' => 49,'CD' => 50,'CK' => 51,'CR' => 52,'CI' => 53,'HR' => 54,'CU' => 55,'CY' => 56,'CZ' => 57,'DK' => 58,'DJ' => 59,'DM' => 60,'DO' => 61,'TP' => 62,'EC' => 63,'EG' => 64,'SV' => 65,'GQ' => 66,'ER' => 67,'EE' => 68,'ET' => 69,'FK' => 70,'FO' => 71,'FJ' => 72,'FI' => 73,'FR' => 74,'FX' => 75,'GF' => 76,'PF' => 77,'TF' => 78,'GA' => 79,'GM' => 80,'GE' => 81,'DE' => 82,'GH' => 83,'GI' => 84,'GR' => 85,'GL' => 86,'GD' => 87,'GP' => 88,'GU' => 89,'GT' => 90,'GN' => 91,'GW' => 92,'GY' => 93,'HT' => 94,'HM' => 95,'VA' => 96,'HN' => 97,'HK' => 98,'HU' => 99,'IS' => 100,'IN' => 101,'ID' => 102,'IR' => 103,'IQ' => 104,'IE' => 105,'IL' => 106,'IT' => 107,'JM' => 108,'JP' => 109,'JO' => 110,'KZ' => 111,'KE' => 112,'KI' => 113,'KP' => 114,'ti' => 115,'KR' => 116,'KW' => 117,'KG' => 118,'LA' => 119,'ti' => 120,'LV' => 121,'LB' => 122,'LS' => 123,'LR' => 124,'LY' => 125,'LI' => 126,'LT' => 127,'LU' => 128,'MO' => 129,'MK' => 130,'ti' => 131,'MG' => 132,'MW' => 133,'MY' => 134,'MV' => 135,'ML' => 136,'MT' => 137,'MH' => 138,'MQ' => 139,'MR' => 140,'MU' => 141,'YT' => 142,'MX' => 143,'FM' => 144,'MD' => 145,'MC' => 146,'MN' => 147,'MS' => 148,'MA' => 149,'MZ' => 150,'MM' => 151,'NA' => 152,'NR' => 153,'NP' => 154,'NL' => 155,'AN' => 156,'NC' => 157,'NZ' => 158,'NI' => 159,'NE' => 160,'NG' => 161,'NU' => 162,'NF' => 163,'MP' => 164,'NO' => 165,'OM' => 166,'PK' => 167,'PW' => 168,'PA' => 169,'PG' => 170,'PY' => 171,'PE' => 172,'PH' => 173,'PN' => 174,'PL' => 175,'PT' => 176,'PR' => 177,'QA' => 178,'RE' => 179,'RO' => 180,'RU' => 181,'RW' => 182,'KN' => 183,'LC' => 184,'VC' => 185,'WS' => 186,'SM' => 187,'ST' => 188,'SA' => 189,'SN' => 190,'SC' => 191,'SL' => 192,'SG' => 193,'SK' => 194,'SI' => 195,'SB' => 196,'SO' => 197,'ZA' => 198,'GS' => 199,'s<' => 200,'ES' => 201,'LK' => 202,'SH' => 203,'PM' => 204,'SD' => 205,'SR' => 206,'SJ' => 207,'SZ' => 208,'SE' => 209,'CH' => 210,'SY' => 211,'TW' => 212,'TJ' => 213,'TZ' => 214,'TH' => 215,'TG' => 216,'TK' => 217,'TO' => 218,'TT' => 219,'TN' => 220,'TR' => 221,'TM' => 222,'TC' => 223,'TV' => 224,'UG' => 225,'UA' => 226,'AE' => 227,'GB' => 228,'UM' => 229,'UY' => 230,'UZ' => 231,'VU' => 232,'VE' => 233,'VN' => 234,'VG' => 235,'VI' => 236,'WF' => 237,'EH' => 238,'YE' => 239,'YU' => 240,'ZM' => 241,'ZW' => 242),
	 				'state'		=> array('AL' => 0,'AK' => 1,'AZ' => 2,'AR' => 3,'CA' => 4,'CO' => 5,'CT' => 6,'DE' => 7,'DC' => 8,'FL' => 9,'GA' => 10,'HI' => 11,'ID' => 12,'IL' => 13,'IN' => 14,'IA' => 15,'KS' => 16,'KY' => 17,'LA' => 18,'ME' => 19,'MD' => 20,'MA' => 21,'MI' => 22,'MN' => 23,'MS' => 24,'MO' => 25,'MT' => 26,'NE' => 27,'NV' => 28,'NH' => 29,'NJ' => 30,'NM' => 31,'NY' => 32,'NC' => 33,'ND' => 34,'OH' => 35,'OK' => 36,'OR' => 37,'PA' => 38,'RI' => 39,'SC' => 40,'SD' => 41,'TN' => 42,'TX' => 43,'UT' => 44,'VT' => 45,'VA' => 46,'WA' => 47,'WV' => 48,'WI' => 49,'WY' => 50),
					'province'	=> array('AB' => 0,'BC' => 1,'MB' => 2,'NF' => 3,'NB' => 4,'NT' => 5,'NS' => 6,'NU' => 7,'ON' => 8,'PE' => 9,'QC' => 10,'SK' => 11,'YT' => 12)
					);
	
					
function MailErrorXmarkPrint($var) {
	
	if( isset($var) ) {
				
		print($this->error['xmark']);
	}
}

function MailErrorPrint() {
	
	if( !empty($this->error['fatal']) ) {
		
		print($this->error['fatal']);	
				
	} elseif( !empty($this->error['result']) ) {
			
		print($this->error['result']);
	}
}
	
function MailPageNoCache() {
	
	header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
	header('Expires: ' . gmdate('D, d M Y H:i:s') . ' GMT');
	header('Cache-Control: no-store, no-cache, must-revalidate'); 
	header('Cache-Control: post-check=0, pre-check=0', false);
	header('Pragma: no-cache');	
}

function MailPageForceSSL() {

	if( !isset($_SERVER['HTTPS']) ) {

		header('Location: https://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']);
		exit();
	}
}			
function MailLoginConnect($host, $port) {
	
 	if( ($this->server['socket'] = @fsockopen($host,$port,$errno,$errstr,$this->timeout['connect'])) !== FALSE ) {
        
       		return TRUE;

        } else {

                $this->error['result'] = $errstr . '.';
        }
}

function MailLoginSignIn($login, $passwd, $autolog = 0, $cookie = 0, $action = '') {
	
	if( isset($cookie['login']) ) {
		
		$login  = $cookie['login'];
		$passwd = $cookie['passwd'];
		$cookie = 1;
	}

	$this->error['result'] = $this->errorcode['03'];
	return;

	$login	= strtolower(trim($login));
	$passwd	= trim($passwd);
	
	if( $this->MailFormatEmail($login) && ($cookie == 1 || $this->MailFormatPasswd($passwd)) ) {
			
		if( $this->DBQuery("SELECT mbox,passwd,status FROM maillogin WHERE mbox='" . $login . "'") ) {
				
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
					
					if( $cookie == 1 ) {
													
						if( $passwd != md5($row['passwd']) ) {
							
							$this->error['result'] = $this->errorcode['03'];
							return;
						}
						
						$passwd = $row['passwd'];
						
					} else {
						
						if( $passwd != $row['passwd'] ) {
							
							$this->error['result'] = $this->errorcode['03'];
							return;
						}
					}
					
					if( $this->MailLogin($login,$passwd,$this->server['ip'],$this->server['port']) ) {
			
						$this->MailQuit();		
											
						switch($row['status']) {
							
							case 0:
								$this->error['result'] = $this->errorcode['03'];
								break;
							
							case 1:
								session_unset();
									
								if( $autolog == 1 ) { 
			
									setcookie("login[login]",$login,time() + 2592000,'/',$this->server['main'],0);
									setcookie("login[passwd]",md5($passwd),time() + 2592000,'/',$this->server['main'],0);
								}
									
								$_SESSION['login']['login']	= $login;
								$_SESSION['login']['passwd']	= $passwd;
								$_SESSION['login']['timeout']	= time();
								$this->MailLoginRecord($login);
								$this->MailStatUpdate($login,'login');
								
								if( !$this->MailEntityIs($login) ) {
								
									header('Location: https://' . $this->server['main'] . '/account_setup');
									exit();
									
								} else {
									
									$this->MailAccountClean($login);
									
									if( isset($_SERVER['HTTPS']) ) {
										
										if( empty($action) ) {
											
											header('Location: https://' . $this->server['main'] . '/login/inbox');
											
											
										} else {
											
											header('Location: https://' . $this->server['main'] . '/' . $action);
											
										}
										
									} else {
										
										if( empty($action) ) {
											
											header('Location: http://' . $this->server['main'] . '/login/inbox');
											
											
										} else {
											
											header('Location: http://' . $this->server['main'] . '/' . $action);
											
										}
									}
								}
								
								exit();
								break;		
							
							case 2:
								$this->error['result'] = $this->errorcode['02'];
								break;
						}
					}
				}
			}
		}
	}
	
	$this->error['result'] = $this->errorcode['03'];	
}
		
function MailLogin($login, $passwd, $host, $port) {

	$accountarr = array();

	if( $this->DBQuery("SELECT id, nick FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' AND login='" . $login . "' AND passwd='" . $passwd . "'") ) {

		if( mysql_num_rows($this->db['result']) == 1 ) {
	
			if( $row = mysql_fetch_array($this->db['result'], MYSQL_ASSOC) ) {

				$accountarr = $row;
				$accountarr['nick'] = '<a href="https://' . $this->server['main'] . '/login/othermail/manage/?mid=' . $row['id'] . '">' . $row['nick'] . '</a>';
			}
		}
	}
	
        if( strlen($login) > 0 && strlen($login) <= $this->limit['login'] && strlen($passwd) > 0 && strlen($passwd) <= $this->limit['max_passwd'] ) {
		
                if( $this->MailLoginConnect($host,$port) ) {
			
                        $this->MailReadSocket($this->server['socket']);
                        fputs($this->server['socket'],'USER ' . $login . "\r\n");
                        $this->MailReadSocket($this->server['socket']);
                        fputs($this->server['socket'],'PASS ' . $passwd . "\r\n");
                        $this->MailReadSocket($this->server['socket']);
				
                        if( trim(substr($this->server['reply'], 0, 3)) != '+OK' ) {

                                $this->error['result'] = 'Invalid Account - ' . $accountarr['nick'] . '. Please check to see if your information is up to date.';
                                $this->MailQuit();

                        } else {

                                return TRUE;
                        }
                }
        } else {
        	
                $this->error['result'] = 'Invalid Account - ' . $accountarr['nick'] . '. Please check to see if your information is up to date.';
        }
}
function MailLimitRegister() {
	
	$queryarr		= array();
	$queryarr['mbox']	= $this->lp['login'];
	$queryarr['send_cnt']	= $this->limit['send_cnt'];
	$queryarr['send_cur']	= 0;
	$queryarr['inbox_size']	= $this->limit['inbox_size'];
	$queryarr['file_cnt']	= $this->limit['file_cnt'];
	$queryarr['file_size']	= $this->limit['file_size'];
	
	if( $this->DBInsert('maillimit',$queryarr) ) {
		
		if( mysql_affected_rows($this->db['link']) == 1 ) {
			
			return TRUE;
		}
	}
}
function MailLimitList() {
			
	if( $this->DBQuery("SELECT * FROM maillimit WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
					
				$this->mail_limit_list 	= $row;
				return TRUE;
			}
		}
	} 
}

function MailMsgHeaderRecvFix($buffer) {
	
	 $eof = 0;
	 $epos = 0;
	 $recvbuffer = '';
	 	 
	 while( $eof != 1 ) {
						 	
		if( ($spos = @strpos(strtolower($buffer),'received',$epos)) !== FALSE ) {
					
			if( ($epos = strpos(strtolower($buffer),"\r\n",$spos)) !== FALSE ) {
						
				$epos += 2;		
				
				if( strstr(substr($buffer,$spos,$epos - $spos),'qmail') ) {
					
					continue;
				}
				 	
				$recvbuffer .= substr($buffer,$spos,$epos - $spos);
				
			} else {
				
				$epos = $spos + strlen('received');
			}
		} else {
					 		
			 $eof = 1;		
		}
	}
	
	return $recvbuffer;
}

function MailFilterBounce($sender,$recipient) {

	$sender		= str_replace('@',' at ',$sender);
	$recipient	= str_replace('@',' at ',$recipient);
	
	if( !strstr($this->mail_account_address_list,strtolower(trim($sender))) ) {
		
		include($this->tpl['php'] . '/filter_bounce_email_msg.tpl');
		include($this->tpl['php'] . '/filter_bounce_email_subject.tpl');
		mail($sender,$subject,$template,"From: " . $this->email['spambounce'] . "\r\nReturn-path: <" . $this->email['spambounce'] . ">\r\n");	
	}
}

function MailFilterCountry($iparr) {
		
	if( sizeof($iparr) > 0 ) {
		
		foreach($iparr as $ip) {
				
			$iplong = sprintf("%u",ip2long($ip));
			
			if( $this->DBQuery("SELECT country_code FROM ipcountry WHERE ip_from <= " . $iplong . " AND ip_to >= " . $iplong) ) {
		
				if( mysql_num_rows($this->db['result']) == 1 ) {
			
					if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
						
						switch($row['country_code']) {
							
							case 'US': case 'CA': case 'UK':
							case 'FR': case 'JP': case 'DE':
							case 'SE': case 'IN': case 'NO':
								break; 	

							default:
								return TRUE;
								break;
						}
					}
				}
			}
		}
	}											
}
	
function MailFilterSpamcube() {
			
	$mheader	= strtolower($this->mail_msg_parse['mheader']);				
	$mmsg 		= strtolower($this->mail_msg_parse['mmsg']);
	$iparr		= array();
	
	if( !$this->MailFormatEmail($this->mail_msg_parse['mfrom']) ) {
			
		return TRUE;	
	
	} elseif( strlen($this->mail_email_match) > 64 ) {
		
		return TRUE;	
	} 
	
	list($user,$domain)	= explode('@',$this->mail_email_match);
	$user			= strtolower($user);
		
	if( strlen($user) > 32 ) {
		
		return TRUE;
	
	} elseif( strlen($user) > 18 ) {
			
		if( strstr($user,'reply') !== FALSE || strstr($user,'return') !== FALSE || strstr($user,'bounce') !== FALSE ) {
				
			return TRUE;
		}
	}
			
	if( isset($this->mail_msg_parse['to']) ) {
		
		$delim = (strpos($this->mail_msg_parse['to'],';')) ? ';' : ',';
		$toarr = explode($delim,$this->mail_msg_parse['to']);
		
		if( sizeof($toarr) > 20 ) {
			
			return TRUE;
		}
		
	} elseif( isset($this->mail_msg_parse['cc']) ) {
		
		$delim = (strpos($this->mail_msg_parse['cc'],';')) ? ';' : ',';
		$ccarr = explode($delim,$this->mail_msg_parse['cc']);
		
		if( sizeof($ccarr) > 40 ) {
		
			return TRUE;
		}
			
	} 
	
	if( $this->mail_msg_parse['mdate'] == 0 ) {
		
		return TRUE;
		
	 } elseif( isset($this->mail_msg_parse['inreplyto']) && !$this->MailFormatEmail($this->mail_msg_parse['inreplyto']) ) {
		
		return TRUE;
		
	} elseif( isset($this->mail_msg_parse['replyto']) && !$this->MailFormatEmail($this->mail_msg_parse['replyto']) ) {
		
		return TRUE;
		
	} elseif( isset($this->mail_msg_parse['returnpath']) && stristr($this->mail_msg_parse['returnpath'],'root@') !== FALSE ) {
		
		return TRUE;		
	
	} elseif( strlen($this->mail_msg_parse['msubject']) > 96 || strstr($this->mail_msg_parse['msubject'],"\x20\x20\x20\x20") !== FALSE ) {
		
		return TRUE;
	
	} elseif( stristr($mheader,'added fake') !== FALSE || stristr($mheader,'x-complaints-to') !== FALSE || stristr($mheader,'boundary.1111') !== FALSE || stristr($mheader,'rmv-version') !== FALSE || stristr($mheader,'x-delete-me') !== FALSE ) {
		
		return TRUE;
	} 
	
	$mmsgarr		= preg_split('/\s+/', $mmsg);
	$alphastr		= 'abcdefghijklmnopqrstuvwxyz';
	$alphaspecialstr	= '*!@&()-_:;\'",.?;=';
	$numstr			= '0123456789';
	$numspecialstr		= '~#$%+<>/():;.,-';
	$cntalpha		= 0;
	$cntnum			= 0;
	$cntalphaspecial 	= 0;
	$cntnumspecial		= 0;
	$cntcaught		= 0;
		
	foreach($mmsgarr as $id => $word) {
		
		if( strlen($word) >= 4 ) {
			
			for($i=0, $max=strlen($word); $i<$max; $i++) {
				
				if( strstr($alphastr, $word[$i]) ) {
					
					$cntalpha++;
				}
				
				if( strstr($alphaspecialstr, $word[$i]) ) {
					
					$cntalphaspecial++;
				}
				
				if( strstr($numstr, $word[$i]) ) {
					
					$cntnum++;
				}
				
				if( strstr($numspecialstr, $word[$i]) ) {
					
					$cntnumspecial++;
				}
			}
						
			if( strlen($word) != $cntalpha + $cntalphaspecial ) {
					
				if( strlen($word) != $cntnum + $cntnumspecial ) {
						
					$cntcaught++;
				}
			}
			
			if( $cntcaught == 10 ) {
			
				// return TRUE;
			}
			
			$cntalpha 		= 0;
			$cntalphaspecial 	= 0;
			$cntnum			= 0;
			$cntnumspecial 		= 0;	
		}
	}

	$mheaderarr 	= preg_split("/\s+/", $mheader);
				
	$schar		= '!#$%^&*(){}[]+\?><|~';
	$scharcnt 	= 0;
	
	foreach($mheaderarr as $id => $word) {
		
		if( strlen($word) >= 24 ) {
			
			for($i=0,$max=strlen($word); $i<$max; $i++) {
				
				if( strstr($schar,$word[$i]) !== FALSE ) {
					
					$scharcnt++;
				}
			}
			if( $scharcnt >= 8 ) return TRUE;
		}
		
		$scharcnt = 0;
	}

	if( $this->MailFilterTitleTag($mmsg) ) {
		
		return TRUE;
	
	} elseif( strstr($mmsg,'r.aol.com/cgi/redir') !== FALSE || 
			strstr($mmsg,'rd.yahoo.com') !== FALSE || 
		  	strstr($mmsg,'redir.impulsive.com') !== FALSE || 
		  	strstr($mmsg,'rd.webbersinternet.com') !== FALSE || 
		  	strstr($mmsg,'visibility: hidden;') !== FALSE ) {
		  	
		 	return TRUE;
	
	} elseif( ($spos = strpos($mmsg,'content-type: text/html;')) !== FALSE ) {
		
		 if( ($epos = strpos($mmsg,"\r\n\r\n",$spos)) !== FALSE ) {
		 	
		 	$content = substr($mmsg,$spos,$epos - $spos);
		 	
		 	if( strstr($content,'content-transfer-encoding: base64') !== FALSE ) {
		 		
		 		return TRUE;
		 	}
		 }
	}
	
	list($user,$domain) = explode('@',$this->mail_email_match);
	
	if( getmxrr($domain,$mxhostarr) ) {
		
		if( preg_match_all("/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/",$mheader . $mmsg,$matches) ) {
			 
			 foreach($matches as $id) {
			 	
			 	foreach($id as $id => $address) {
			 		
			 		$iparr[] = $address;
			 	}
			 }
			
			 if( $this->MailFilterCountry(array_unique($iparr)) ) {
									
				return TRUE;
			}
		}
		
	} else {
			
		return TRUE;
	}

	return FALSE;
}

function MailStatUpdate($login,$type) {
	
	$this->DBQuery("INSERT into mailstat VALUES('','" . $login. "','" . $type . "'," . time() . ")");

}
function MailComposeGroupList($gid) {
	
	$to = '';
	
	if( $this->MailBookGroupIS($gid) || $this->MailBookGroupEveryoneIs($gid) ) {
	
		if( $this->DBQuery("SELECT pemail,bemail FROM mailbook WHERE mgroup=" . $gid) ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
				
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
					
					if( !empty($row['pemail']) ) {
						
						$to .=  $row['pemail'] . '; ';
	
					} else {
						
						$to .= $row['bemail'] . '; ';
					}
				}
				
				$this->mail_compose_group_list = substr($to,0,-2);
			}
		}
	
		return TRUE;
	}	
}
function MailComposeFormat($composearr) {
	
	if( is_array($composearr) && sizeof($composearr) > 0 ) {
			
		foreach($composearr as $name => $value) {
		
			if( $name == 'to' || $name == 'cc' || $name == 'bcc' ) {
				
				$value = trim($value);
							
				if( $value[strlen($value)-1] == ',' || $value[strlen($value)-1] == ';' ) {
					
					$value = substr($value,0,-1);
				} 
					
				if( !empty($value) ) {
						
					if( strlen($value) > 1 && strlen($value) <= 1000 ) {
						
						$rcptdelim	= (strpos($value,';')) ? ';' : ',';
						$rcptarr 	= explode($rcptdelim,$value);
										
						foreach($rcptarr as $email) {
								
							$email 			= trim($email);
							list($user,$domain) 	= explode('@',$email);
						
							if( !$this->MailFormatEmail($email) || !checkdnsrr($domain,'MX') ) {
							
								$this->mail_compose_img_error[$name] = TRUE;
								break;
							}
						} 
					} else {
						
						$this->mail_compose_img_error[$name] = TRUE;
					}
				} elseif( $name == 'to' ) {
						
					$this->mail_compose_img_error[$name] = TRUE;
				}
			}
					
			if( $name == 'subject' ) {
				
				if( strlen($value) > 64 ) {
					
					$this->mail_compose_img_error[$name] = TRUE;
				
				} elseif( empty($value) && $this->mail_option_list['alertsubject'] == 1 ) {
					
					$this->mail_compose_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'msg' ) {
				
				if( strlen($value) >= $this->compose['max_msg_size'] ) {
					
					$this->mail_compose_img_error[$name] = TRUE;
				
				} elseif( empty($value) && $this->mail_option_list['alertmsg'] == 1 ) {
					
					$this->mail_compose_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'priority' )  {
				
				if( $value != 1 && $value != 3 && $value != 5 ) {
					
					$this->mail_compose_img_error[$name] = TRUE;
				}
			}				
		}
	}
	
	if( !is_array($this->mail_compose_img_error) ) {
		
		return TRUE;

	} else {
		
		$this->error['result'] = $this->errorcode['32'];
	}	
}

function MailExpressOptionUpdate($bookxprs) {

	$bookxprs = ($bookxprs != 1) ? 0 : 1;
	
	if( $this->DBQuery("UPDATE mailoption SET bookxprs='" . $bookxprs . "' WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		$this->MailCacheFunctionFlush('mailoptionlist');
		$this->MailCacheFunctionFlush('mailbookexpresslist');
		return TRUE;
	}
}

function MailBookExpressList() {
	
	$server_main	= $this->server['main'];
	$templateline 	= '';
	$templatehidden = '';
	$entry 		= '$entry';
	$cnt 		= 0;

	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
			
		switch($this->mail_option_list['bookxprs']) {
		
			case 0:
				$query = ' AND mxprs=\'1\'';	
				break;
		
			case 1:			
				$query = ' ORDER BY mreply DESC LIMIT 5';
				break;
		}
		
		if( $this->DBQuery("SELECT pfname,pmname,plname,pemail,bcompany,bemail FROM mailbook WHERE mbox='" . $this->lp['login'] . "'" . $query) ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
			
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					if( !empty($row['pfname']) ) {
					
						$name 	= $row['pfname'] . ' ' . $row['pmname'] . ' ' . $row['plname'];
						$email 	= $row['pemail'];
					
					} elseif( !empty($row['bcompany']) ) {
					
						$name 	= $row['bcompany'];
						$email 	= $row['bemail'];
					}
					
					$cnt++;				
					$templatehidden .= '<input type="hidden" name="$entry' . $cnt . '" value="' . $email . '">' . "\n";
					include($this->tpl['php'] . '/compose_book_xprs_list.tpl');
					$templateline   .= $template;
				}
					
			} else {
			
				include($this->tpl['php'] . '/compose_book_xprs_list_none.tpl');
				$templateline .= $template;
			}
		}
		
		$_SESSION['function'][__FUNCTION__]['list'] 		= $templateline;
		$_SESSION['function'][__FUNCTION__]['hiddenlist'] 	= nl2br($templatehidden);
		$_SESSION['function'][__FUNCTION__]['refresh']		= time() + $this->timeout['func_cache'];	
		$this->mail_book_xprs_list 				= $templateline;
		$this->mail_book_xprs_hidden_list 			= nl2br($templatehidden);
	
	} else {
		
		$this->mail_book_xprs_list 		= $_SESSION['function'][__FUNCTION__]['list'];
		$this->mail_book_xprs_hidden_list 	= $_SESSION['function'][__FUNCTION__]['hiddenlist'];
	}	
}
	
function MailFileScan($filetmp,$file) {
	
	if( is_file($filetmp) ) {
		
        	if( $this->MailExec($this->bin['antivrs'],'--secure --unzip ' . $filetmp) ) {

                	return TRUE;

        	} else {
        		  
                	unset($this->error['result']);
                	
                	if( ($spos = strpos($this->mail_exec_output[1],'the')) ) {
                		
                		$spos += 4;
                		
                		if( ($epos = strpos($this->mail_exec_output[1],'virus')) ) {
                			
                			$epos -= 1;
                				
                			$virusdata 	= trim(substr($this->mail_exec_output[1],$spos,$epos - $spos));
                			$virus 		= '<a href="http://vil.nai.com/vil/alphar.asp?char=' . urlencode($virusdata) . '" target="_blank">' . $virusdata . '</a>';
                			include($this->tpl['php'] . '/compose_file_virus_list.tpl');
                			$this->mail_compose_file_virus_list .= $template;
        			}
        		}
        		
        	}
        }
}

function MailComposeFileDetach($fidarr) {
	
	$cnt 			= 0;
	list($user,$domain) 	= explode('@',$this->lp['login']);	
	
	if( is_array($fidarr) && sizeof($fidarr) > 0 ) {
		
		foreach($fidarr as $fid => $id ) {
					
			if( isset($_SESSION['attach']['file'][$fid]) ) {
			
				foreach($_SESSION['attach']['file'][$fid] as $file => $size) {
				
					if( is_file($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file) ) {
					
						unlink($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file);
					}
					
					$_SESSION['attach']['size'] -= $size;
				}
				
				unset($_SESSION['attach']['file'][$fid]);
	 			$cnt++;
	 		}
	 	}
	 	
	 	if( $cnt > 0 ) {
	 		
			$this->error['result'] = str_replace('$cnt',$cnt,$this->errorcode['67']);
	 		return TRUE;
	 	}
	 	
	 } else {
	 	
	 	$this->error['result'] = $this->errorcode['68'];
	 }		
}

function MailReceiptIs($rid) {
	
	if( is_numeric($rid) ) {
		
		if( $this->DBQuery("SELECT rid FROM mailreceipt WHERE rid=" . $rid) ) {
			
			if( mysql_num_rows($this->db['result']) == 1 ) {
				
				$this->mail_receipt_id = $rid;
				return TRUE;
			}
		}
	}
}

function MailReceiptRequest() {

	if( $this->DBQuery("INSERT into mailreceipt VALUES(''," . time() . ")") ) {
		
		if( mysql_affected_rows($this->db['link']) == 1 ) {
			
			if( is_numeric(mysql_insert_id()) && mysql_insert_id() != 0 ) {
				
				$this->mail_receipt_id = mysql_insert_id();
				return TRUE;
			}
		}
	}
}

function MailReceiptUpdate($rid) {
			
	if( $this->DBQuery("UPDATE mailbox SET mrcptdate=" . time() . " WHERE mrcptid=" . $this->mail_receipt_id) ) {
						
		if( $this->DBQuery("DELETE FROM mailreceipt WHERE rid=" . $rid) ) {
			
			if( mysql_affected_rows($this->db['link']) == 1 ) {
				
				return TRUE;
			}
		}
	}
}

function MailFeedBackIs($type, $text) {
			
	if( $this->DBQuery("SELECT id FROM mailfeedback WHERE mbox='" . $this->lp['login'] . "' AND type='" . $type . "' AND text='" . addslashes(trim($text)) . "'") ) {
				
		if( mysql_num_rows($this->db['result']) == 1 ) {
					
			return TRUE;
		}
	}
}

function MailFeedBackRegister($type, $text) {
	
	if( $type > 0 && $type < 8 ) {
			
		if( strlen($text) > 2 && strlen($text) <= 10240 ) {
			
			if( !$this->MailFeedbackIs($type, $text) ) {
						
				if( $this->DBQuery("INSERT into mailfeedback VALUES('','" . $this->lp['login'] . "','" . $type . "','" . addslashes(trim($text)) . "'," . time() . ")") ) {
		
					if( mysql_affected_rows($this->db['link']) == 1 ) {
						
						switch($type) {
							
							case 1: 
								$typetext = 'Bug';
								break;
							case 2:
								$typetext = 'Design';
								break;
							case 3:	
								$typetext = 'Compat';
								break;
							case 4:
								$typetext = 'Function';
								break;
							
							case 5:
								$typetext = 'Lang';
								break;
							
							case 6:
								$typetext = 'Clip art';
								break;
								
							case 7:
								$typetext = 'Other';
								break;
						}
										
						include($this->tpl['php'] . '/feedback_email_subject.tpl');
						mail($this->email['feedback'],$subject,trim($text),"From: " . $this->lp['login'] . "\r\nContent-type: text/html; charset=iso-8859-1\r\nReturn-path: <" . $this->lp['login'] . ">\r\n");
						$_SESSION['result'] = $this->errorcode['48'];
						header('Location: http://' . $this->server['main'] . '/login/inbox');
						exit();	
					}
				}
			} else {
				
				$this->error['result'] = $this->errorcode['49'];
			}
		} else {
			
			$this->error['result'] = $this->errorcode['50'];
		}
	} else {
		
		$this->error['result'] = $this->errorcode['51'];
	}
}
function MailComposeFileAttach($filearr) {
	
	$totalgood	= 0;
	$totalbad	= 0;
	
	list($user, $domain) = explode('@', $this->lp['login']);
	
	if( is_array($filearr) && sizeof($filearr) > 0 ) {
		
		foreach($filearr as $file => $attrarr) {
			
			if( $attrarr['errorid'] == 0 && $attrarr['size'] > 0 ) {
			
				if( sizeof($_SESSION['attach']['file']) + 1 <= $this->mail_limit_list['file_cnt'] ) {
			
					if( ($attrarr['size']  + $_SESSION['attach']['size']) <= $this->mail_limit_list['file_size'] ) {
								
						if( is_uploaded_file($attrarr['tmp_name']) ) {
													
							if( $this->MailFileScan($attrarr['tmp_name'], basename($attrarr['name'])) ) {
									
								if( move_uploaded_file($attrarr['tmp_name'], $this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . basename($attrarr['name'])) ) {
														
									$_SESSION['attach']['file'][][basename($attrarr['name'])] = $attrarr['size']; 
									$_SESSION['attach']['size'] += $attrarr['size']; 
									$totalgood++;
								}	
							}	 
						}
					} else {
					
						$this->error['result'] = str_replace('$file_size',$this->mail_limit_list['file_size'] / 1024 / 1024,$this->errorcode['76']);
						break;
					}
				
				} else {
					
					$this->error['result'] = str_replace('$file_cnt',$this->mail_limit_list['file_cnt'],$this->errorcode['77']);
					break;
				}
			} else {
				
				$totalbad++;
			}
		}
	}
	
	if( isset($this->mail_compose_file_virus_list) ) {
		
		$viruslist	= $this->mail_compose_file_virus_list;	
 		include($this->tpl['php'] . '/compose_file_virus_warning.tpl'); 
		$this->mail_compose_file_virus_warning = $template;
	}
	 
	if( $totalbad == 5 ) {
					
		$this->error['result'] = $this->errorcode['74'];
	
	} elseif( $totalgood > 0 ) {
		
		$this->error['result'] = str_replace('$totalgood',$totalgood,$this->errorcode['75']);
	}
}

function MailComposeFileList() {
	
	$templatefile 	= '';
	$templatenofile = '';
	$templateattach = '';
	$totalsize 	= 0;
	$totalfile 	= 0;
	$icon 		= '';
	$ext		= '';
	
	if( is_array($_SESSION['attach']['file']) && sizeof($_SESSION['attach']['file']) > 0 ) {
		
		foreach($_SESSION['attach']['file'] as $fid => $fidarr) {
			
			foreach($fidarr as $file => $size ) {
							
				$ext 		= strtolower(substr($file,strrpos($file,'.') + 1,strlen($file)));
				$totalfile++;
				$totalsize 	+= $size;
				
				switch($ext) {
					
					case 'bmp':
						$icon = '<img src="/img/icons/file_extensions/ico_bmp.gif" width="14" height="15">';
						break;	
			
					case 'exe':	
						$icon = '<img src="/img/icons/file_extensions/ico_exe.gif" width="14" height="15">';
						break;
					
					case 'gif':
						$icon = '<img src="/img/icons/file_extensions/ico_gif.gif" width="12" height="15">';
						break;
					
					case 'jpeg': case 'jpg':
						$icon = '<img src="/img/icons/file_extensions/ico_jpg.gif" width="12" height="15">';
						break;
					
					case 'avi': case 'mov': case 'divx': case 'qt':
					case 'mpeg': case 'mpg': case 'mpe': case 'movie': case 'wmv' :
						$icon = '<img src="/img/icons/file_extensions/ico_movie_media.gif" width="12" height="15">';
						break;
					
					case 'mp3': case 'mp2': case 'mp1':  case 'cda': case 'wav': case 'mid': case 'midi':
					case 'aif': case 'aiff': case 'wma': case 'ram': case 'ra': case 'rm': case 'snd':
					case 'au': 
						$icon = '<img src="/img/icons/file_extensions/ico_music.gif" width="22" height="15">';
						break;
					
					case 'pdf':
						$icon = '<img src="/img/icons/file_extensions/ico_pdf.gif" width="12" height="15">';
						break;
					
					case 'ppt':
						$icon = '<img src="/img/icons/file_extensions/ico_powerpoint.gif" width="17" height="15">';
						break;
					
					case 'rtf': case 'doc': case 'txt':
						$icon = '<img src="/img/icons/file_extensions/ico_rtf_doc.gif" width="15" height="15">';
						break;
						
					case 'xls':
						$icon = '<img src="/img/icons/file_extensions/ico_xls.gif" width="16" height="15">';
						break;
					
					case 'psd':
						$icon = '<img src="/img/icons/file_extensions/ico_psd.gif" width="12" height="15">';
						break;
					
					case 'zip': case 'rar': case 'arj': case 'bz2':
					case 'gz': case 'tgz': case 'tar': case 'ace':
						$icon = '<img src="/img/icons/file_extensions/ico_archive.gif" width="18" height="15">';
						break;
					
					case 'swf': case 'fla':
						$icon = '<img src="/img/icons/file_extensions/ico_flash.gif" width="12" height="15">';
						break;
					
					case 'htm': case 'html':
						$icon = '<img src="/img/icons/file_extensions/ico_html.gif" width="16" height="15">';
						break;
					
					case 'php': case 'php3': case 'php4': case 'cgi':
					case 'pl': case 'perl': case 'shtml': case 'python':
					case 'asp': case 'jsp': case 'sh': case 'bash': 
					case 'c': case 'h': case 'xml':
						$icon = '<img src="/img/icons/file_extensions/ico_script.gif" width="13" height="16">';
						break;
					
					default:
						$icon = '<img src="/img/icons/file_extensions/ico_unknown.gif" width="13" height="15">';
						break;
				}
						
				if( $size > 1048576 ) {
					
					$size = round($size / 1024 / 1024,2) . ' MB';
				
				} else {				
				
					$size = round($size / 1024,2) . ' KB';
				} 
												
				include($this->tpl['php'] . '/compose_file_attach.tpl');						
				$templatefile .= $template;
				include($this->tpl['php'] . '/compose_attach.tpl');
				$templateattach .= $template;
			}
		}
		
	} else {
		
		include($this->tpl['php'] . '/compose_file_attach_none.tpl');	
		$templatenofile = $template;
	}
	
	if( $totalsize > 1048576 ) {
					
		$totalsize = round($totalsize / 1024 / 1024,2) . ' MB';
				
	} else {
					
		$totalsize = round($totalsize / 1024,2) . ' KB';			
	}
	
	$this->mail_compose_file_list 	= $templatefile;
	$this->mail_compose_nofile_list = $templatenofile;
	$this->mail_compose_file_total 	= $totalfile;
	$this->mail_compose_file_size 	= $totalsize;
	$this->mail_compose_attach_list = $templateattach;
	return TRUE;
}

function MailComposeSpanToFont($buffer) {
	
	 $eof = 0;
	 $epos = 0;
						 
	 while( $eof != 1 ) {
						 	
		if( ($spos = @strpos(strtolower($buffer),'<span',$epos)) !== FALSE ) {
			
			if( ($epos = strpos(strtolower($buffer),'>',$spos)) !== FALSE ) {
								
				if( ($fsspos = strpos(strtolower($buffer),'font-size:',$spos)) !== FALSE ) {
				
					if( $fsspos < $epos ) {
						
						$fsspos += strlen('font-size:');
				
						if( ($fsepos = strpos(strtolower($buffer),';',$fsspos)) !== FALSE || ($fsepos = strpos(strtolower($buffer),'"',$fsspos)) !== FALSE ) {
							
							if( $fsepos < $epos ) {
								
								$fsize = trim(substr($buffer,$fsspos,$fsepos - $fsspos));
							}
						}
					}
				}
				
				if( ($ffspos = strpos(strtolower($buffer),'font-family:',$spos)) !== FALSE ) {
				
					if( $ffspos < $epos ) {
						
						$ffspos += strlen('font-family:');
				
						if( ($ffepos = strpos(strtolower($buffer),';',$ffspos)) !== FALSE || ($ffepos = strpos(strtolower($buffer),'"',$ffspos)) !== FALSE ) {
							
							if( $ffepos < $epos ) {
								
								$fface = trim(substr($buffer,$ffspos,$ffepos - $ffspos));
							}
						}
					}
				}
				
				$epos += 1;
												
				if( isset($fsize) && isset($fface) ) {
				
					$buffer = substr_replace($buffer,'<font size="' . $fsize . '" face="' . $fface . '">',$spos,$epos - $spos); 
										 
			 	} elseif( isset($fsize) ) {
				 	
					$buffer = substr_replace($buffer,'<font size="' . $fsize . '">',$spos,$epos - $spos); 
				 		
				} elseif( isset($fface) ) {
				 		
					$buffer = substr_replace($buffer,'<font face="' . $fface . '">',$spos,$epos - $spos); 
				 }
				 	 
				  $epos = $spos + strlen('<span');
				 	 			 			 	
			} else {
				
				$epos = $spos + strlen('<span');
			}
			
		} else {
					 		
			 $eof = 1;		
		}
	}
	
	return str_replace('</SPAN>','</FONT>',$buffer);
}
	
function MailComposeSave($composearr) {
	
	$mailer 		= new phpmailer();
	$toaddr 		= array();
	$ccaddr 		= array();
	$bccaddr 		= array();
	$globaladdr 		= array();
	$queryarr		= array();
	
	$mailer->Hostname 		= $this->server['main'];
	$mailer->IsQmail();
	$mailer->IsHTML(true);
	$mailer->From			= $this->mail_account_name_list['reply'];
	$mailer->FromName 		= $this->mail_account_name_list['name'];
	$mailer->Subject 		= (!empty($composearr['subject'])) ? trim($composearr['subject']) : '<No Subject>';
	$mailer->WordWrap 		= $this->compose['wordwrap'];
	$mailer->AddReplyTo($mailer->From,$mailer->FromName);	
	$mailer->Priority 		= $composearr['priority'];
	$mailer->UseMSMailHeaders 	= TRUE;
	
	if( $composearr['signature'] == 1 ) {
			
		if( $composearr['editmode'] == 1 ) {
					
			$composearr['msg'] .= nl2br("\n\n" . $this->mail_signature_view['text']);
				
		} else {
					
			$composearr['msg'] .= "\n\n" . $this->mail_signature_view['text'];
		}
	}

	if( $composearr['editmode'] == 1 ) {
		
		$composearr['msg']	= trim($this->MailComposeSpanToFont($composearr['msg']));	                               
		$mailer->Body 		= trim($composearr['msg']);
		$mailer->AltBody 	= trim($composearr['msg']);
	
	} else {
		
		$mailer->Body 		= trim(nl2br($composearr['msg']));
		$mailer->AltBody	= trim($composearr['msg']);
	}
	
	$todelim	= (strpos($composearr['to'],';')) ? ';' : ',';
	$toaddr 	= explode($todelim,strtolower(trim($composearr['to'])));
        	
	foreach($toaddr as $address) {
		
		$address 	= trim($address);
		$globaladdr[] 	= $address;
		$mailer->AddAddress($address);
	}
	
	if( !empty($composearr['cc']) ) {
		
		$ccdelim 	= (strpos($composearr['cc'],';')) ? ';' : ',';			
		$ccaddr 	= explode($ccdelim,strtolower(trim($composearr['cc'])));
		
		foreach($ccaddr as $address) {
			
			$address 	= trim($address);
			$globaladdr[] 	= $address;
			$mailer->AddCC($address);
		}
	}
	
	if( $this->mail_option_list['replyccme'] == 1 ) {
		
		$globaladdr[] 		= $this->lp['login'];		
		$mailer->AddCC($this->lp['login']);
	}
	
	if( $this->mail_option_list['replyccother'] == 1 ) {
		
		$globaladdr[] 		= $this->mail_option_list['replyccaddr'];
		$mailer->AddCC($this->mail_option_list['replyccaddr']);
	}
	
	if( !empty($composearr['bcc']) ) {
		
		$bccdelim 	= (strpos($composearr['bcc'],';')) ? ';' : ',';
		$bccaddr 	= explode($bccdelim,strtolower(trim($composearr['bcc'])));
		
		foreach($bccaddr as $address) {
			
			$address 	= trim($address);
			$globaladdr[] 	= $address;
			$mailer->AddBCC($address);
		}
	}

	if( is_array($_SESSION['attach']['file']) && sizeof($_SESSION['attach']['file']) > 0 ) {
				
		list($user,$domain) = explode('@',$this->lp['login']);
		
		foreach($_SESSION['attach']['file'] as $fid => $fidarr ) {
				
			foreach($fidarr as $file => $size) {
				
				if( is_file($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file)  ) {
								
					$mailer->AddAttachment($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file);	
				}
			}
		}
	}	
	      
	$header	= $mailer->create_header();
	$body	= $mailer->create_body();
	$msg	= $header . $body;
	$size	= strlen($msg);
	$file	= (strpos(strtolower($header),'content-type: multipart/mixed;')) ? 1 : 0;
	
	if( $composearr['archive'] == 1 ) {
		
		$folder = 'Sent';
		$rcptid = $this->mail_receipt_id;
	
	} else {
		
		$folder = 'Drafts';
		$rcptid = 0;
	}	
	
	if( isset($_GET['mid']) && isset($_GET['action']) && $_GET['action'] == 'send' && $this->MailMsgIs($_GET['mid']) ) {
		
		$queryarr['mhash'] 	= md5($msg);
		$queryarr['mfrom']	= trim(strtolower($composearr['to']));
		$queryarr['msubject']	= $mailer->Subject;
		$queryarr['mdate']	= time();
		$queryarr['msize']	= $size;
		$queryarr['mstatus']	= 1;
		$queryarr['mpriority']	= $mailer->Priority;
		$queryarr['mfile']	= $file;
		
		$this->DBUpdate('mailbox', $queryarr, 'WHERE mid=' . $_GET['mid']);
		
		$queryarr		= array();
		$queryarr['mheader']	= $header;
		$queryarr['mmsg']	= $body;
		
		$this->DBUpdate('msgbox', $queryarr, 'WHERE mid=' . $_GET['mid']);
		
		$_SESSION['result'] = str_replace('$folder',$folder,$this->errorcode['72']);
		
		if( $composearr['archive'] != 1 ) {
						
			$this->MailComposeFileDetach($_SESSION['attach']['file']);
							
	 	   	if( $this->mail_option_list['sslout'] == 1 ) {
	 	   					
				header('Location: https://' . $this->server['main'] . '/login/drafts');
				exit();
				
			} else {
				
				header('Location: http://' . $this->server['main'] . '/login/drafts');
				exit();
			}
		}
		
	} else {
			 
		if( $this->MailMsgSizeCount() ) {
		
			if( ($size + $this->mail_msg_size_cnt) <= $this->mail_limit_list['inbox_size'] ) {
									
				if( $this->DBQuery("INSERT into mailbox VALUES('','" . $this->lp['login'] . "',0,'" . addslashes($folder) . "','FFFFFF','" . 
	    						    md5($msg) . "','" . trim(strtolower($composearr['to'])) . "','" .  addslashes($mailer->Subject) . "'," . time() . "," . $size . ",'1','" . $mailer->Priority . "','" . $file . "','0','0','0'," . $rcptid . ",0)") ) {
	    
					if( $this->DBQuery("INSERT into msgbox VALUES(" . mysql_insert_id() . ",'" . $this->lp['login'] . "','" . addslashes($header) . "','" . addslashes($body) . "')") ) {
					
						$this->DBQuery("UPDATE mailfolder SET count=(count) + 1 WHERE mbox='" . $this->lp['login'] . "' AND folder='" . addslashes($folder) . "'");				
						$_SESSION['result'] = str_replace('$folder',$folder,$this->errorcode['72']);
					
						if( $composearr['archive'] != 1 ) {
						
							$this->MailComposeFileDetach($_SESSION['attach']['file']);
							
	 	   					if( $this->mail_option_list['sslout'] == 1 ) {
	 	   					
								header('Location: https://' . $this->server['main'] . '/login/drafts');
								exit();
				
							} else {
				
								header('Location: http://' . $this->server['main'] . '/login/drafts');
								exit();
							}
						}
					
	 	   				return TRUE;
					}
				}	
		
			} else {
			
				$this->error['result'] = $this->errorcode['73'];
			}
		} 
	}
}

function MailComposeSend($composearr) {
	
	$mailer 		= new phpmailer();
	$toaddr 		= array();
	$ccaddr 		= array();
	$bccaddr 		= array();
	$globaladdr 		= array();
	$bgarr			= array();
	$txtarr			= array();
	
	$composearr['subject']		= stripslashes($composearr['subject']);
	$composearr['msg']		= stripslashes($composearr['msg']);
	
	$mailer->Hostname 		= $this->server['main'];
	$mailer->IsQmail();
	$mailer->IsHTML(true);
	$mailer->From			= $this->mail_account_name_list['reply'];
	$mailer->FromName 		= $this->mail_account_name_list['name'];
	$mailer->Subject 		= (!empty($composearr['subject'])) ? trim($composearr['subject']) : '<No Subject>';
	$mailer->WordWrap 		= $this->compose['wordwrap'];
	$mailer->AddReplyTo($mailer->From,$mailer->FromName);	
	$mailer->Priority 		= $composearr['priority'];
	$mailer->UseMSMailHeaders 	= TRUE;
		
	if( $composearr['signature'] == 1 ) {
			
		if( $composearr['editmode'] == 1 ) {
					
			$composearr['msg'] .= nl2br("\n\n" . $this->mail_signature_view['text']);
				
		} else {
					
			$composearr['msg'] .= "\n\n" . $this->mail_signature_view['text'];
		}
	}
	
	$eof 	= 0;
	$epos 	= 0;
	
	while( $eof != 1 ) {
		
		if( ($spos = strpos($composearr['msg'],'<XML ',$epos)) !== FALSE ) {
			
			$bgarr[]	= $spos;
			$epos 		= $spos += 5;
	
		} else {
			
			$eof 	= 1;
		}
	}
	
	$eof	= 0;
	$epos	= 0;
	
	while( $eof != 1 ) {
		
		if( ($spos = strpos($composearr['msg'],'<BR ',$epos)) !== FALSE ) {
			
			$txtarr[]	= $spos;
			$epos		= $spos += 4;
	
		} else {
			
			$eof 	= 1;
		}
	}
	
	if( sizeof($bgarr) > 0 ) {
		
		if( sizeof($bgarr) == 1 ) {
			
			$sposbg = $bgarr[0];
		
		} else {
			
			$bgarr 	= array_reverse($bgarr);		
			$sposbg = $bgarr[0];
		}
	} 
	
	if( sizeof($txtarr) > 0 ) {
		
		if( sizeof($txtarr) == 1 ) {
			
			$spostxt = $txtarr[0];
		
		} else {
			
			$txtarr  = array_reverse($txtarr);	
			$spostxt = $txtarr[0];
		}
	}
	
	unset($spos);
	
	if( isset($sposbg) && isset($spostxt) ) {
		
		$spos = ($spostxt > $sposbg) ? $spostxt : $sposbg;
	
	} elseif( isset($sposbg) ) {
		
		$spos = $sposbg;
	
	} elseif( isset($spostxt) ) {
		
		$spos = $spostxt;
	}					
	
	if( isset($spos) ) {
		
		if( ($epos = strpos($composearr['msg'],'>',$spos)) !== FALSE ) {
			
			$bodytag 	= substr($composearr['msg'],$spos,$epos - $spos);
			$bodytype 	= ($bodytag[0] . $bodytag[1] . $bodytag[2] . $bodytag[3] == '<XML') ? 'insert_backgrounds' : 'insert_textures';
			
			if( $bodytype == 'insert_backgrounds' ) {
				
				$spos 	+= 5;
				$bodytag = substr($composearr['msg'],$spos,$epos - $spos);
				
				if( stristr($bodytag,'jpg') || stristr($bodytag,'jpeg') || stristr($bodytag,'gif') || stristr($bodytag,'png') ) {
					
					$composearr['msg'] = '<body background="http://' . $this->server['main'] . '/login/compose/insert_backgrounds/backgrounds/' . $bodytag . '">' . $composearr['msg'] . '</body>';
				}
			
			} elseif( $bodytype == 'insert_textures' ) {
				
				$spos   += 4;
				$bodytag = substr($composearr['msg'],$spos,$epos - $spos);
				
				if( stristr($bodytag,'jpg') || stristr($bodytag,'jpeg') || stristr($bodytag,'gif') || stristr($bodytag,'png') ) {
					
					$composearr['msg'] = '<body background="http://' . $this->server['main'] . '/login/compose/insert_textures/textures/' . $bodytag . '">' . $composearr['msg'] . '</body>';
				}
			}
		}
	}
		
	if( $composearr['editmode'] == 1 ) {
		
		$composearr['msg']	= trim($this->MailComposeSpanToFont($composearr['msg']));	                               
		$mailer->Body 		= trim($composearr['msg']);
		$mailer->AltBody 	= trim($composearr['msg']);
	
	} else {
		
		$mailer->Body 		= trim(nl2br($composearr['msg']));
		$mailer->AltBody	= trim($composearr['msg']);
	}
	
	$todelim	= (strpos($composearr['to'],';')) ? ';' : ',';
	$toaddr 	= explode($todelim,strtolower(trim($composearr['to'])));
        	
	foreach($toaddr as $address) {
		
		$address 	= trim($address);
		$globaladdr[] 	= $address;
		$mailer->AddAddress($address);
	}
	
	if( !empty($composearr['cc']) ) {
		
		$ccdelim 	= (strpos($composearr['cc'],';')) ? ';' : ',';			
		$ccaddr 	= explode($ccdelim,strtolower(trim($composearr['cc'])));
		
		foreach($ccaddr as $address) {
			
			$address 	= trim($address);
			$globaladdr[] 	= $address;
			$mailer->AddCC($address);
		}
	}
	
	if( $this->mail_option_list['replyccme'] == 1 ) {
		
		$globaladdr[] 		= $this->lp['login'];		
		$mailer->AddCC($this->lp['login']);
	}
	
	if( $this->mail_option_list['replyccother'] == 1 ) {
		
		$globaladdr[] 		= $this->mail_option_list['replyccaddr'];
		$mailer->AddCC($this->mail_option_list['replyccaddr']);
	}
	
	if( !empty($composearr['bcc']) ) {
		
		$bccdelim 	= (strpos($composearr['bcc'],';')) ? ';' : ',';
		$bccaddr 	= explode($bccdelim,strtolower(trim($composearr['bcc'])));
		
		foreach($bccaddr as $address) {
			
			$address 	= trim($address);
			$globaladdr[] 	= $address;
			$mailer->AddBCC($address);
		}
	}

	if( is_array($_SESSION['attach']['file']) && sizeof($_SESSION['attach']['file']) > 0 ) {
				
		list($user,$domain) = explode('@',$this->lp['login']);
		
		foreach($_SESSION['attach']['file'] as $fid => $fidarr ) {
				
			foreach($fidarr as $file => $size) {
				
				if( is_file($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file)  ) {
								
					$mailer->AddAttachment($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file);	
				}
			}
		}
	}	
	
	$receipt = TRUE;
	
	foreach($globaladdr as $id => $address) {
		
		if( strstr($address, 'hotmail') || strstr($address, 'yahoo') ) {
			
			$receipt = FALSE;
		}
	}
	
	if( $receipt ) {
		
		$this->MailReceiptRequest();
		$mailer->Body  .= '<img src="http://' . $this->server['main'] . '/img/receipt/receipt.aka?rid=' . $this->mail_receipt_id . '" height="1" width="1">';	
	}
	
	$recptcnt = sizeof($globaladdr);
	
	if( ($this->mail_limit_list['send_cur'] + $recptcnt) <= $this->mail_limit_list['send_cnt'] ) {
							
		if( $mailer->Send() ) {
			
			if( $this->mail_option_list['sendsave'] == 1 ) {
				
				$composearr['archive'] = 1;
				$this->MailComposeSave($composearr);
			}
			
				$this->MailComposeFileDetach($_SESSION['attach']['file']);
				
				$this->DBQuery("UPDATE maillimit SET send_cur=(send_cur) + " . $recptcnt . " WHERE mbox='" . $this->lp['login'] . "'");
			
				if( $this->MailBookGroupEveryoneGet() ) {
							
					foreach($globaladdr as $email) {
						
						if( !strstr($this->mail_account_address_list,$email) ) {
							
							if( $this->MailBookContactIsByEmail('pemail',$email) ) {
				
								$this->DBQuery("UPDATE mailbook SET mreply=(mreply) + 1 WHERE mbox='" . $this->lp['login'] . "' AND pemail='" . $email . "'"); 
			
							} elseif( $this->MailBookContactIsByEmail('bemail',$email) ) {
				
								$this->DBQuery("UPDATE mailbook SET mreply=(mreply) + 1 WHERE mbox='" . $this->lp['login'] . "' AND bemail='" . $email . "'"); 
			
							} elseif( $this->mail_option_list['replybookadd'] == 1 ) {
								
								$this->DBQuery("INSERT into mailbook (cid,mbox,mgroup,mreply,mxprs,pfname,pemail) VALUES('','" . $this->lp['login'] . "'," . $this->mail_book_group_everyone . ",'0','0','" . $email . "','" . $email . "')");	
								$this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount) + 1 WHERE mbox='" . $this->lp['login'] . "' AND mgroup='Everyone'");
								$this->MailCacheFunctionFlush('mailbookexpresslist');
								$this->MailCacheFunctionFlush('mailbookminilist');
							}
						}	
					}		
				}
			
				$this->MailStatUpdate($this->lp['login'],'send');
				
				if( sizeof($toaddr) == 1 && empty($composearr['cc']) && empty($composearr['bcc']) ) {
			
					$_SESSION['result'] = str_replace('$email', strtolower($toaddr[0]),$this->errorcode['69']);
		
				} else {
			
					$_SESSION['result'] = str_replace('$recptcnt',$recptcnt,$this->errorcode['70']);
				}
					
				if( $this->mail_option_list['sslout'] == 1 ) {
			
			       		header('Location: https://' . $this->server['main'] . '/login/inbox');
			       		exit();
			       
				} else {
			
					header('Location: http://' . $this->server['main'] . '/login/inbox');
					exit();
				}
				
				return TRUE;
				
		} else {
				
			$this->error['result'] = $mailer->ErrorInfo;	
		} 
	} else {
		
		$this->error['result'] = str_replace('$send_cnt',$this->mail_limit_list['send_cnt'],$this->errorcode['71']);
	}
}	

function MailComposeSpellCheck($text) {
       	
        $this->errors 	= array();
        $this->text 	= $text;
        $text 		= '^'.implode("\n^", explode("\n", $text));
        $tmp 		= tempnam('/tmp', 'spl');
        $fp 		= fopen($tmp, 'w');
        fwrite($fp, $text);
        fclose($fp);
        $output 	= `{$this->bin['aspell']} -a < $tmp`;
        unlink($tmp);
        $num_errors 	= preg_match_all('|^& (\w+) \d+ \d+: (.*?)$|m', $output, $matches);
        $extra_errors 	= preg_match_all('|^# (\w+)( ).*$|m', $output, $matches2);
        
        for ($i = 0; $i < $extra_errors; $i++) {
        
       	 	$matches[0][] = $matches2[0][$i];
            	$matches[1][] = $matches2[1][$i];
            	$matches[2][] = $matches2[2][$i];
        }
        
        $num_errors += $extra_errors;
        
        for ($i = 0; $i < $num_errors; $i++) {
         
            $word = $matches[1][$i];
          	
          	  if (in_array($word, array_keys($this->errors))) {
                	
                	continue;
            	}
            	
            $suggestions 		= explode(', ', $matches[2][$i]);
            $this->errors[$word] 	= $suggestions;
        }
        
        return $num_errors;
}

function MailScheduleFileClear() {
	
	if( $this->DBQuery("SELECT mbox FROM maillogin") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				list($user,$domain) = explode('@',$row['mbox']);
	
				if( is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload') ) {
			
					if( ($dir = opendir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload')) ) {
			
						while( ($file = readdir($dir)) !== FALSE ) {
			
							if( $file == '..' || $file == '.' ) continue;
							unlink($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' . $file);
						}
					}
				}
	
				if( is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download') ) {
			
					if( ($dir = opendir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download')) ) {
			
						while( ($file = readdir($dir)) !== FALSE ) {
			
							if( $file == '..' || $file == '.' ) continue;
							unlink($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download/' . $file);
						}			
					}
				}
			}
		}
	}
}
function MailSignatureIsByName($name) {
	
	if( $this->DBQuery("SELECT id FROM mailsignature WHERE mbox='" . $this->lp['login'] . "' AND name='" . addslashes(trim($name)) . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailSignatureIs($sid) {
	
	if( is_numeric($sid) ) {
		
		if( $this->DBQuery("SELECT id FROM mailsignature WHERE id=" . $sid . " AND mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				return TRUE;
			}
		}
	}
}

function MailSignatureView($sid) {
	
	if( $this->MailSignatureIs($sid) ) {
		
		if( $this->DBQuery("SELECT name,text,fmt FROM mailsignature WHERE id=" . $sid) ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
							
				if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					$this->mail_signature_view = $row;
					return TRUE;
				}
			} 
		}
	}
}

function MailSignatureList($sid) {
	
	$templateline = '';
	
	if( $this->DBQuery("SELECT id,name,dflt FROM mailsignature WHERE mbox='" . $this->lp['login'] . "' ORDER by name ASC") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				($row['dflt'] == 1) ? $default = ' (Default)' : $default = '';
				
				if( !isset($sid) && !empty($default) ) {
					
					$templateline .= '<option selected value="' . $row['id'] . '">' . $row['name'] . ' ' . $default . '</option>'; 
				
				} elseif( $sid == $row['id'] ) {
					
					$templateline .= '<option selected value="' . $row['id'] . '">' . $row['name'] . ' ' . $default . '</option>'; 
				
				} else {
					
					$templateline .= '<option value="' . $row['id'] . '">' . $row['name'] . $default . '</option>'; 
				}
			}
			
			$this->mail_signature_list = $templateline;
		
		} else {
			
			$this->mail_signature_list = '<option value="0">No existant e-signatures.</option>';
		}	
	}
}
			
function MailSignatureDelete($sid) {
	
	if( $sid != 0 ) {
		
		if( $this->MailSignatureIs($sid) ) {
		
			if( $this->DBQuery("DELETE FROM mailsignature WHERE id=" . $sid) ) {
			
				if( mysql_affected_rows($this->db['link']) > 0 ) {
					
					if( !$this->MailSignatureDefaultGet() ) {
						
						$this->DBQuery("UPDATE mailsignature SET dflt='1' WHERE mbox='" . $this->lp['login'] . "' LIMIT 1");
					}
							
					$this->error['result'] = $this->errorcode['42'];
				}
			}
		}
	} else {
		
		$this->error['result'] = $this->errorcode['43'];
	}
}

function MailSignatureDefaultGet() {
	
	if( $this->DBQuery("SELECT id FROM mailsignature WHERE mbox='" . $this->lp['login'] . "' AND dflt='1'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_signature_default = $row['id'];
				return TRUE;
			}
		}
	}
}
			
function MailSignatureRegister($name, $text, $format, $default) {
	
	if( $this->MailFormatSignature($name) ) {
			
		if( strlen($text) > 2 && strlen($text) <= 10240 ) {
					
			($default != 1) ? $default = 0 : NULL;
			($format  != 1) ? $format  = 0 : NULL;
				
			if( $default == 1 ) {
				
				if( $this->MailSignatureDefaultGet() ) {
					
					$this->DBQuery("UPDATE mailsignature SET dflt='0' WHERE id=" . $this->mail_signature_default);
				}	
			
			} elseif( $default == 0 ) {
				
				if( !$this->MailSignatureDefaultGet() ) {
					
					$default = 1;
				}
			}	 
										
			if( !$this->MailSignatureIsByName($name) ) {
										
				if( $this->DBQuery("INSERT into mailsignature VALUES('','" . $this->lp['login'] . "','" . addslashes(trim($name)) . "','" . addslashes(trim($this->MailComposeSpanToFont($text))) . "','" . $format . "','" . $default . "')") ) {
					
					$this->error['result'] = str_replace('$name',$name,$this->errorcode['46']);
				}
			
			} elseif( $this->DBQuery("UPDATE mailsignature SET name='" . addslashes(trim($name)) . "',text='" . addslashes(trim($text)) . "',fmt='" . $format . "',dflt='" . $default . "' WHERE mbox='" . $this->lp['login'] . "' AND name='" . addslashes(trim($name)) . "'") ) {
					
					$this->error['result'] = str_replace('$name',$name,$this->errorcode['47']);
				}
		} else {
			
			$this->error['result'] = $this->errorcode['45'];
		}
	}
}

function MailMsgParseHeader($name,$header,$limit = 255) {
	
	if( ($namepos = strpos(strtolower($header),$name)) !== FALSE ) {
		
		$namepos += strlen($name)+1;
	
		if( ($nameend = strpos($header, "\r\n",$namepos)) !== FALSE ) {
			
			return substr(trim(substr($header,$namepos,$nameend - $namepos)),0,$limit);
		} 
	}	
}
	
function MailMsgParse($id) {
	
	$buffer 	= '';
	$msgarr 	= array('mfolder' => '','mfrom' => '','msubject' => '','mdate' => 0,'mstatus' => 1,'mpriority' => 3,'mfile' => 0, 'msign' => 0,'mread' => 0,'mdelete' => 0,'mheader' => '','mmsg' => '');

	fputs($this->server['socket'],'RETR ' . $id . "\r\n");
	$this->MailReadSocket();
	
	while( $this->server['eof'] != 1) {
		
		if( substr($buffer,-5) == "\r\n.\r\n") break;
		$this->MailReadData();
		$buffer .= $this->server['reply'];
	}
				
	if( ($headerpos = strpos($buffer,"\r\n\r\n")) !== FALSE ) {
		
		$header			= substr($buffer,0,$headerpos+2);
		$msgarr['mheader']	= $header;
		$msgarr['mmsg']		= substr($buffer,$headerpos+3,strlen($buffer));
		$msgarr['mhash']	= $this->mail_msg_parse['mhash'];		
		$msgarr['mfrom']	= $this->MailMsgParseHeader('from:',$header,96);
		$msgarr['inreplyto']	= $this->MailMsgParseHeader('in-reply-to:',$header,96);
		$msgarr['returnpath']	= $this->MailMsgParseHeader('return-path:',$header,96);
		$msgarr['replyto']	= $this->MailMsgParseHeader('reply-to:',$header,96);
		$msgarr['to']		= $this->MailMsgParseHeader('to:',$header,96);
		$msgarr['cc']		= $this->MailMsgParseHeader('cc:',$header,96);
		$msgarr['msubject']	= $this->MailMsgParseHeader('subject:',$header,96);
					
		if( !empty($msgarr['msubject']) ) {
								
			$msgarr['msubject'] = trim(strip_tags($msgarr['msubject']));		
		}
		
		if( empty($msgarr['msubject']) ) {
			
			$msgarr['msubject'] = '<No Subject>';
		}
			
		if( ($datepos = strpos(strtolower($header),'date:')) !== FALSE ) {
		 
			$datepos += 6;
		
			if( ($dateend = strpos($header,"\r\n",$datepos)) !== FALSE ) {
				
				if( ($compos = strpos($header,'(',$datepos)) !== FALSE && $compos < $dateend ) {
					
					$compos -= 1;
					$date	= strtotime(trim(substr($header,$datepos,$compos - $datepos)));
				
				} else {
								
					$date	= strtotime(trim(substr($header,$datepos,$dateend - $datepos)));			
				}
				
				$msgarr['mdate'] = ($date > 0 && $date < (time() + 43200)) ? $date : 0;
				$msgarr['mdate'] = ($msgarr['mdate'] != 0 && $msgarr['mdate'] > time() ) ? time() : $msgarr['mdate'];
			}
		}
	
		if( ($prioritypos = strpos(strtolower($header),'x-priority:')) !== FALSE ) {
		
			$prioritypos += 12;
		
			if( ($priorityend = strpos($header,"\r\n",$prioritypos)) !== FALSE ) {
				
				if( ($compos = strpos($header,'(',$prioritypos)) !== FALSE && $compos < $priorityend ) {
					
					$compos -= 1;
					$priority = trim(substr($header,$prioritypos,$compos - $prioritypos));	
				
				} else {
								
					$priority = trim(substr($header,$prioritypos,$priorityend - $prioritypos));			
				}
				
				$msgarr['mpriority'] = ($priority == 5 || $priority == 3 || $priority == 1) ? $priority : 3;	
			}
		}
	
		if( ($filepos = strpos(strtolower($header),'content-type: multipart/mixed;')) !== FALSE ) {
		
			$msgarr['mfile'] = 1;
		
		} elseif( ($filepos = strpos(strtolower($msgarr['mmsg']),'content-type: multipart/mixed;')) !== FALSE ) {
		
			$msgarr['mfile'] = 1;
		}
		
		if( ($filepos = strpos(strtolower($header),'content-type: multipart/signed;')) !== FALSE ) {
		
			$msgarr['msign'] = 1;
		
		} elseif( ($filepos = strpos(strtolower($header),'x-signed: ' . md5($this->mail_contact_list['maiden']))) !== FALSE ) {
		
			$msgarr['msign'] = 1;
		}		
		
		if( (stristr(substr($msgarr['msubject'],0,4),'RE:') !== FALSE) || (stristr(substr($msgarr['msubject'],0,4),'RE :') !== FALSE) ) {
			
			$msgarr['mstatus'] = 2;
		}
		
		if( (stristr(substr($msgarr['msubject'],0,4),'FW:') !== FALSE) || (stristr(substr($msgarr['msubject'],0,4),'FW :') !== FALSE) ) {
			
			$msgarr['mstatus'] = 3;
		}
	
	}
	
	$this->mail_msg_parse = $msgarr;
	return TRUE;
}

function MailFolderSizeCount() {
	
	$sizearr = array();
	
	if( $this->DBQuery("SELECT mfolder,msize FROM mailbox WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
			 	if( !isset($sizearr[$row['mfolder']]) ) {
			 		
			 		$sizearr[$row['mfolder']] = 0;
					$sizearr[$row['mfolder']] += $row['msize'];			 	
			 	} else {
			 		
			 		$sizearr[$row['mfolder']] += $row['msize'];
			 	}
			 }
			 
			 $this->mail_folder_size = $sizearr;
		}
	}
	
	return TRUE;
}

function MailFolderRedirect($folder) {
	
	if( $folder == 'Inbox' || $folder == 'Sent' || $folder == 'Deleted' || $folder == 'Drafts' ) {
		
		if( isset($_SERVER['HTTPS']) ) {
					
			header('Location: https://' . $this->server['main'] . '/login/' . strtolower($folder));
		
		} else {
			
			header('Location: http://' . $this->server['main'] . '/login/' . strtolower($folder));
		}
		
	} else {
		
		if( isset($_SERVER['HTTPS']) ) {
				
			 header('Location: https://' . $this->server['main'] . '/login/custom/?folder=' . urlencode($folder));
		
		} else {
		
			header('Location: http://' . $this->server['main'] . '/login/custom/?folder=' . urlencode($folder));
		}
	}
	
	exit();			
}

function MailFolderSort($sortarr) {
	
	if( is_array($sortarr) && sizeof($sortarr) > 0 ) {
		
		foreach($sortarr as $sortby => $id) {
			
			if( $sortby != 'folder ASC' )  {
											
				$this->mail_folder_sort 	= $sortby;
				$this->mail_folder_sort_query 	= ' ORDER BY ' . $sortby;
			
			} else {
				
				$this->mail_folder_sort 	= $sortby;
				$this->mail_folder_sort_query 	= ' ORDER BY id ASC';
			}	
		}
	} else {

		$this->mail_folder_sort 	= 'folder ASC';
		$this->mail_folder_sort_query 	= ' ORDER BY id ASC';
	}
}
function MailFolderList() {
	
	$templateline 	= '';
	$bgcolor 	= '#EEEEEE';
	$custcnt 	= 0;
	$builtcnt 	= 0;
	$totalsize 	= 0;
	$totalmsg 	= 0;
	
	if( $this->MailFolderSizeCount() ) {
			
		if( $this->DBQuery("SELECT id,folder,count,share,ctime,mtime,rdonly FROM mailfolder WHERE mbox='" . $this->lp['login'] . "'" . $this->mail_folder_sort_query) ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
			
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
					
					$row['size'] 	= $this->mail_folder_size[$row['folder']];
			 		$bgcolor 	= ($bgcolor == '#EEEEEE') ? '#FFFFFF' : '#EEEEEE';			
					$mcount 	= number_format($row['count']);
					$mshare 	= ($row['share'] == 1) ? '<img src="/img/icon_shared_folder.gif" alt="Indicates that more than one of your e-mail accounts use this folder." width="15" height="15" onMouseOver="window.status=\'Indicates that more than one of your e-mail accounts use this folder.\'; return true;" onMouseOut="window.status=\'\'; return true;">' : '<img src="/img/icon_unshared_folder.gif" alt="Indicates that this folder is not shared by multiple e-mail accounts." width="16" height="16" onMouseOver="window.status=\'Indicates that this folder is not shared by multiple e-mail accounts.\';return true;" onMouseOut="window.status=\'\'; return true;">'; 
					$msize 		= ($row['size'] > 1048576) ? round($row['size'] / 1024 / 1024) . ' MB' : round($row['size'] / 1024) . ' KB';
					$mctime 	= date('n/j/y g:i a',$row['ctime']);
					$mmtime 	= date('n/j/y g:i a',$row['mtime']);
				
					if( $row['rdonly'] == 1 ) {
					
						$mid = '<div align="center"><img src="/img/btn_disabled_checkbox.gif" width="15" height="13"></div>';
					
						if( $row['folder'] != 'Spam' ) {
						
							$mfolder = '<a href="http://' . $this->server['main'] . '/login/' . strtolower($row['folder']) . '">' . $row['folder'] . '</a>';
			
						} else {
						
							$mfolder = '<a href="http://' . $this->server['main'] . '/login/custom/?folder=' . $row['folder'] . '">' . $row['folder'] . '</a>';
						}
					
						$builtcnt++;
				
					} else {
					
						$mid 		= '<input name="mid[' . $row['id'] . ']" type="checkbox"  onClick="CCA(this);">';
						$mfolder	= '<input name="tid[' . $row['id'] . ']" type="text" class="textfields" value="' . $row['folder'] . '" size="16" maxlength="16">';
						$custcnt++;
					}
				
					$totalsize 	+= $row['size'];
					$totalmsg 	+= $row['count'];
				
					include($this->tpl['php'] . '/folder_list.tpl');
					$templateline .= $template;
				}
			}
		}
	
		$totalmsg 			= number_format($totalmsg);
		$totalsize 			= ($totalsize > 1048576) ? round($totalsize / 1024 / 1024) . ' MB' : round($totalsize / 1024) . ' KB';
		include($this->tpl['php'] . '/folder_list_total.tpl');
		$this->mail_folder_total 	= $template;
		$this->mail_folder_list 	= $templateline;
		$this->mail_folder_cust_cnt 	= $custcnt;
	}
}	

function MailFolderView()  {
	
	$templateline = '';
	$server_main  = '';
	$cnt	      = 0;
		 		
	if( $this->DBQuery("SELECT folder, count FROM mailfolder WHERE mbox='" . $this->lp['login'] . "' ORDER BY id") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'], MYSQL_ASSOC) ) {
				
				$cnt++;
							
				if( $_SESSION['folder_cur'] == $row['folder'] ) {
										
					$templateline .= '<option selected value="' . $row['folder'] . '">' . $row['folder'] . ' (' . number_format($row['count']) . ') </option>';		
				
				} else {
				
					$templateline .= '<option value="' . $row['folder'] . '">' . $row['folder'] . ' (' . number_format($row['count']) . ') </option>';		
				}			
			}
		}
	}
	
	$cnt 				= $cnt - 1;
	$server_main			= $this->server['main'];
	include($this->tpl['php'] . '/folder_view.tpl');
	$this->mail_folder_view_move 	= $templateline;
	$this->mail_folder_view_top 	= $template;
	return TRUE;	
}
	
function MailMsgHashIs($hash) {
	
	if( $this->DBQuery("SELECT id FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mhash='" . $hash . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailAccountClean($login) {
	
	$cntmsg = 0;
	
	if( $this->DBQuery("SELECT id, folder, rmcycle FROM mailaccount WHERE mbox='" . $login . "'") ) {
		
		$result = $this->db['result'];
				
		if( mysql_num_rows($result) > 0 ) {
			
			while( $row = mysql_fetch_array($result,MYSQL_ASSOC) ) {
					
				switch($row['rmcycle']) {
					
					case 1:
						$time = time() - 86400;
						break;
					
					case 2:
						$time = time() - 604800;
						break;
					
					case 3:
						$time = time() - 2592000;
						break;
					
					case 4:
						$time = 0;
						break;
					
					default:
						$time = 0;
						break;
				}
				
				if( $time != 0 ) {
					
					if( $this->DBQuery("UPDATE mailbox SET mdelete='1' WHERE mbox='" . $login . "' AND mmid=" . $row['id'] . " AND mdate < " . $time) ) {
						
						if( ($cntmsg = mysql_affected_rows($this->db['link'])) > 0 ) {
								
							$this->DBQuery("UPDATE mailfolder SET count=(count) - " . $cntmsg . " WHERE mbox='" . $login . "' AND folder='" . $row['folder'] . "'");
						}
					}
				}
			}
		}
	}
}

function MailWindowsIEIs() {
	
	if( stristr($_SERVER['HTTP_USER_AGENT'],'MSIE') && stristr($_SERVER['HTTP_USER_AGENT'],'WINDOWS') ) {
		
		return TRUE;
	}
}

function MailAccountHostLoginIs($host, $login) { 
	
	if( $this->DBQuery("SELECT id FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' AND host='" . $host . "' AND login='" . $login . "'") ) {
				
		if( mysql_num_rows($this->db['result']) == 1) {
			
			return TRUE;
		}
	}
}

function MailAccountNickIs($nick) { 
	
	if( $this->DBQuery("SELECT nick FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' AND nick='" . $nick . "'") ) {
				
		if( mysql_num_rows($this->db['result']) == 1) {
			
			return TRUE;
		}
	}
}
	
function MailAccountEmailIs($email) { 
	
	if( $this->MailFormatEmail($email) ) {
		
		if( $this->DBQuery("SELECT id FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' AND email='" . $email . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1) {
			
				return TRUE;
			}
		}
	}
}

function MailAccountFormat($accountarr, $register = 0) {
	
	if( isset($accountarr['nick']) )  {
	
		if( strlen($accountarr['nick']) < 1  ||
		    strlen($accountarr['nick']) > 32 || 
		    $accountarr['nick'] == 'AKAMail' || 
		    ($register == 1 && $this->MailAccountNickIs($accountarr['nick'])) || 
		    ($register == 0 && $this->mail_account_name_list['nick'] != $accountarr['nick'] && $this->MailAccountNickIs($accountarr['nick']))  ) {
		
			$this->mail_account_img_error['nick'] = TRUE;
		}
	}
	
	if( !preg_match("/([a-z\-\.\s\']{2,32})$/i",$accountarr['name']) ) {
		
		$this->mail_account_img_error['name'] = TRUE;
	}
	
	if( isset($accountarr['email']) ) {
			
		list($user,$domain) = explode('@',$accountarr['email']);
		
		if( !$this->MailFormatEmail($accountarr['email']) || 
			!checkdnsrr($domain,'MX') || 
			($register == 1 && $this->MailAccountEmailIs($accountarr['email'])) || 
			($register == 0 && $this->mail_account_name_list['email'] != $accountarr['email'] && $this->MailAccountEmailIs($accountarr['email'])) ) {
				
			$this->mail_account_img_error['email'] = TRUE;
		}
	}
	
	list($user,$domain) = explode('@',$accountarr['reply']);
				
	if( !$this->MailFormatEmail($accountarr['reply']) || 
		!checkdnsrr($domain,'MX') ) {
				
		$this->mail_account_img_error['reply'] = TRUE;
	}
	
	if( isset($accountarr['host']) && !$this->MailFormatHost($accountarr['host']) ) {
		
		$this->mail_account_img_error['host'] = TRUE;
	}
	
	if( isset($accountarr['login']) && (strlen($accountarr['login']) < 1 || strlen($accountarr['login']) > $this->limit['login']) ) {
		
		$this->mail_account_img_error['login'] = TRUE;
	}
	
	if( isset($accountarr['passwd']) && (strlen($accountarr['passwd']) < 1 || strlen($accountarr['passwd']) > 32) ) {
		
		$this->mail_account_img_error['passwd'] = TRUE;
	}
		
	if( !preg_match("/^([A-Z0-9]{6})$/",$accountarr['color']) ) {
		
		$this->mail_account_img_error['color'] = TRUE;
	}
	
	if( $accountarr['saveto'] == 'existant' ) {
		
		if( !$this->MailFolderIsByName($accountarr['existantfolder']) ) {
			
			$this->mail_account_img_error['existantfolder'] = TRUE;
		}
		
	} elseif( $accountarr['saveto'] == 'new' ) {
		
		if( $this->MailFolderIsByName($accountarr['newfolder']) || !$this->MailFormatFolder($accountarr['newfolder']) ) {
			
			$this->mail_account_img_error['newfolder'] = TRUE;
		}
	}
	
	if( isset($accountarr['port']) && ($accountarr['port'] < 1 || $accountarr['port'] > 65535) ) {
		
		$this->mail_account_img_error['port'] = TRUE;
	}
	
	if( $accountarr['rmcycle'] < 1 || $accountarr['rmcycle'] > 4 ) {
		
		$this->mail_account_img_error['rmcycle'] = TRUE;
	}
			
	if( !is_array($this->mail_account_img_error) && isset($accountarr['host']) ) {
		
		if( ($register == 1 && $this->MailAccountHostLoginIs($accountarr['host'],$accountarr['login'])) ||
			($register == 0 && ($this->mail_account_name_list['login'] != $accountarr['login'] || $this->mail_account_name_list['host'] != $accountarr['host']) && $this->MailAccountHostLoginIs($accountarr['host'],$accountarr['login'])) ) {
			
			$this->mail_account_img_error['host']	= TRUE;
			$this->error['result'] = $this->errorcode['34'];
			return FALSE;
			
		} elseif( !$this->MailLoginConnect($accountarr['host'],$accountarr['port']) ) {
			
			$this->mail_account_img_error['host']   = TRUE;
			$this->mail_account_img_error['port']	= TRUE;
			$this->error['result'] = str_replace('$host',$accountarr['host'],$this->errorcode['30']);
			return FALSE;
			
		} elseif( !$this->MailLogin($accountarr['login'],$accountarr['passwd'],$accountarr['host'],$accountarr['port']) ) {
					
			$this->mail_account_img_error['login']  = TRUE;
			$this->mail_account_img_error['passwd'] = TRUE;
			$this->error['result'] = $this->errorcode['31'];
			return FALSE;
		}
	}
			
	if( !is_array($this->mail_account_img_error) ) {
			
		return TRUE;
		
	} else {
		
		$this->error['result'] = $this->errorcode['32'];
	}
}

function MailAccountRefresh($mid) {
	
	$listarr	= array();
	$queryarr	= array();
	$rmarr		= array();
	$duparr		= array();
	$dupstorearr	= array();
	$cntmsg		= 0;
	$cntmsgspam	= 0;
	
	if( $this->DBQuery("SELECT id, login, passwd, host, port, folder, color, rdonly FROM mailaccount WHERE id=" . $mid) ) {

		$result = $this->db['result'];
				
		if( mysql_num_rows($result) == 1 ) {
			
			if( $row = mysql_fetch_array($result,MYSQL_ASSOC) ) {
								
				if( $this->MailLogin($row['login'], $row['passwd'], $row['host'], $row['port']) ) {
							
					fputs($this->server['socket'], "LIST\r\n");
					$this->MailReadSocket($this->server['socket']);
					$this->MailReadSocket($this->server['socket']);
						
					while( $this->server['reply'] != ".\r\n" ) {
								
						list($id,$size) 	= preg_split('/\s/',trim($this->server['reply']));	
						$listarr[trim($id)]	= trim($size);
						$this->MailReadSocket();		
					}
				
					if( sizeof($listarr) > 0 ) {
						
						foreach($listarr as $id => $size) {
							
							if( $this->MailMsgSocketIs($id) ) { 
															
								if( $this->MailMsgDeleteIs($this->mail_msg_parse['mhash']) ) { 
								
									$rmarr[$id] = $this->mail_msg_parse['mhash'];
								}
								
								continue;
							
							} else {		
								
								if( $size > $this->limit['max_msg_size'] ) {
									
									continue;
								}
										
								if( !isset($dupstorearr[$this->mail_msg_parse['mhash']]) ) {
									
									$dupstorearr[$this->mail_msg_parse['mhash']] = TRUE;
								
								} else {
									
									$duparr[$id] = $this->mail_msg_parse['mhash'];
									continue;
								}
										
								if( $this->MailMsgParse($id) ) {
										
									if( !$this->MailFilterLayer() && !empty($this->mail_msg_parse['mmsg']) ) {
										
										if( $this->mail_autorpd_list['status'] == 1 ) {
											
											if( $this->mail_autorpd_list['saveto'] == 1 ) {
												
												$row['folder'] = $this->mail_autorpd_list['folder'];
											}
										}
														
										$folder = ($this->mail_msg_parse['mfolder'] == 'Spam') ? $this->mail_msg_parse['mfolder'] : $row['folder'];
									
										$queryarr		= array();
										$queryarr['mbox']	= $this->lp['login'];
										$queryarr['mmid']	= $row['id'];
										$queryarr['mfolder']	= $folder;
										$queryarr['mcolor']	= $row['color'];
										$queryarr['mhash']	= $this->mail_msg_parse['mhash'];
										$queryarr['mfrom']	= $this->mail_msg_parse['mfrom'];
										$queryarr['msubject']	= $this->mail_msg_parse['msubject'];
										$queryarr['mdate']	= $this->mail_msg_parse['mdate'];
										$queryarr['msize']	= $size;
										$queryarr['mstatus']	= $this->mail_msg_parse['mstatus'];
										$queryarr['mpriority']	= $this->mail_msg_parse['mpriority'];
										$queryarr['mfile']	= $this->mail_msg_parse['mfile'];
										$queryarr['msign']	= $this->mail_msg_parse['msign'];
										$queryarr['mread']	= $this->mail_msg_parse['mread'];
										$queryarr['mdelete']	= $this->mail_msg_parse['mdelete'];
										$queryarr['mrcptid']	= 0;
										$queryarr['mrcptdate']	= 0;
										
										if( $this->DBInsert('mailbox',$queryarr) ) {
											
										$queryarr		= array();
										$queryarr['mid']	= mysql_insert_id();
										$queryarr['mbox'] 	= $this->lp['login'];
										$queryarr['mheader']	= $this->mail_msg_parse['mheader'];
										$queryarr['mmsg']	= $this->mail_msg_parse['mmsg'];
										
											if( $this->DBInsert('msgbox',$queryarr) ) {

												($folder == 'Spam') ? $cntmsgspam++ : $cntmsg++;
											}
										}
										 		
									} else {
											
										$duparr[$id] = $this->mail_msg_parse['mhash'];
										$this->MailStatUpdate($this->lp['login'],'spam');
									} 
								}
							}
						}
						
						$this->MailFilterDuplicate($duparr);
						$this->MailMsgDeleteQueue($rmarr);
						
						if( $cntmsg > 0 ) {
							
							
							$this->DBQuery("UPDATE mailfolder SET count=(count) + " . $cntmsg . " WHERE mbox='" . $this->lp['login'] . "' AND folder='" . $row['folder'] . "'");
						}
						
						if( $cntmsgspam > 0 ) {
							
							$this->DBQuery("UPDATE mailfolder SET count=(count) + " . $cntmsgspam . " WHERE mbox='" . $this->lp['login'] . "' AND folder='Spam'");				
						}
					}
					
					$this->mail_account_refresh_cnt += $cntmsg;
					$this->MailQuit();
					return TRUE;
				}				
			}
		}
	}
}

function MailMsgSocketIs($id) {

	$buffer  = '';
	$msghash = '';
		
	fputs($this->server['socket'],'TOP ' . $id . " 100\r\n");
	$this->MailReadSocket();
	
	while( $this->server['eof'] != 1 ) {
		
		if( substr($buffer,-5) == "\r\n.\r\n") break;
		$this->MailReadData();
		$buffer .= $this->server['reply'];
	}
		
	$msghash 			= md5($buffer);
	$this->mail_msg_parse['mhash']	= $msghash;
	
	if( $this->DBQuery("SELECT mid FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mhash='" . $msghash . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}			
}
function MailSecurePrint() {
	
	if( isset($_SERVER['HTTPS']) ) {
			
		include($this->tpl['php'] . '/page_secure_enabled.tpl');
		print($template);
	}
}
	
function MailMsgIs($mid) {
	
	if( is_numeric($mid) ) {
		
		if( $this->DBQuery("SELECT mid FROM mailbox WHERE mid=" . $mid . " AND mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				return TRUE;
			}
		}
	}
}

function MailFolderIsByName($folder) {
	
	if( $this->MailFormatFolder($folder) ) {
						
		if( $this->DBQuery("SELECT id FROM mailfolder WHERE mbox='" . $this->lp['login'] . "' AND folder='" . addslashes($folder) . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				return TRUE;
			} 
		}
	}  
}

function MailFolderCount() {
	
	if( $this->DBQuery("SELECT id FROM mailfolder WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		$this->mail_folder_cnt = mysql_num_rows($this->db['result']);
		return TRUE;
	}	
}

function MailFolderIs($id) {

	if( is_numeric($id) ) {
		
		if( $this->DBQuery("SELECT id FROM mailfolder WHERE id=" . $id . " AND mbox='" . $this->lp['login'] . "'") ) {
			
			if( mysql_num_rows($this->db['result']) == 1  ) {
				
				return TRUE;
			}
		}
	}	
}

function MailListSort($sortarr) {
	
	if( is_array($sortarr) && sizeof($sortarr) > 0 ) {
		
		foreach($sortarr as $sortby => $id) {
			
			$this->mail_list_sort = $sortby;
			break;
		}
	} else {
		
		switch($this->mail_option_list['folderview']) {
			
			case 0:
				$this->mail_list_sort = 'mdate DESC';
				break;
			case 1:
				$this->mail_list_sort = 'mdate ASC';
				break;
		}
	}			
}

function MailMsgMove($idarr, $folder) {
	
	$cntmsg = 0;
	
	if( $folder != '#' ) {
		
		if( $this->MailFolderIsByName($folder) ) {
			
			if( $folder != $_SESSION['folder_cur'] ) {
				
				if( is_array($idarr) && sizeof($idarr) > 0 ) {
		
					foreach($idarr as $id => $mid) {
			
						if( $this->MailMsgIs($mid) ) {
													
							if( $this->DBQuery("UPDATE mailbox SET mfolder='" . addslashes($folder) . "' WHERE mid=" . $mid) ) {
								
								 $cntmsg++;
							}
						}
					}	
					
					if( $cntmsg > 0 ) {
							
						$this->DBQuery("UPDATE mailfolder SET count=(count)-" . $cntmsg . " WHERE folder='" . $_SESSION['folder_cur'] . "'");
						$this->DBQuery("UPDATE mailfolder SET count=(count)+" . $cntmsg . " WHERE folder='" . addslashes($folder) . "'");
						$this->error['result'] = str_replace('$folder',$folder,$this->errorcode['15']);
					}
			
				} else {
		
					$this->error['result'] = $this->errorcode['16'];
				}	
			} else {
		
				$this->error['result'] = $this->errorcode['18'];			
			}
		} else {
			
			$this->error['result'] = $this->errorcode['17'];
		}
		
	} else {
		
		$this->error['result'] = $this->errorcode['19'];;
	}
}

function MailMsgStatusIs($status) {
	
	list($status,$statusid) = explode('-',$status);
	
	switch($status) {
		
		case 'mread':
		
			if( $statusid == 0 || $statusid == 1 ) {
				
				return TRUE;
			}
			break;
			
		case 'mstatus':
		
			if( $statusid == 1 || $statusid == 4 || $statusid == 5 ) {
				
				return TRUE;
			}
			break;
			
		case 'mpriority':
		
			if( $statusid == 1 || $statusid == 3 || $statusid == 5 ) {
				
				return TRUE;
			}
			break;
	}
}
			
function MailMsgStatusUpdate($idarr, $status) {
						
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
						
		if( $this->MailMsgStatusIs($status) ) {
			
			list($status,$statusid) = explode('-',$status);
		
			foreach($idarr as $id => $mid) {
			
				if( $this->MailMsgIs($mid) ) {
					
					if( $status == 'mstatus' && $statusid == 5 ) {
						
						$this->DBQuery("UPDATE mailbox SET mread='1' WHERE mid=" . $mid);
					}
						
					$this->DBQuery("UPDATE mailbox SET " . $status . "='" . $statusid . "' WHERE mid=" . $mid);
				}		
			}
							
			$this->error['result'] = $this->errorcode['20'];
		}
				
	} else {
				
		$this->error['result'] = $this->errorcode['21'];
	}
}

function MailFilterBlockList() {

	$templateline		= '';
	$templateline0	 	= '';
	$count 			= 0;
	
	if( $this->DBQuery("SELECT id,mfrom FROM mailfilter WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$count++;			
				$templateline 		.= '<option value="' . $row['id'] . '">' . $row['mfrom'] . '</option>';
				$templateline0 		.= $row['mfrom'] . ',';
			}
			
			if( $count > 0 ) {
				
				$this->mail_filter_block_list 		= $templateline;
				$this->mail_filter_block_blacklist 	= substr($templateline0,0,-1);
			}
		}
	}			

	$this->mail_filter_block_count 		= $count;
	return TRUE;
}

function MailFilterIs($mid) {
	
	if( is_numeric($mid) ) {
		
		if( $this->DBQuery("SELECT id FROM mailfilter WHERE id=" . $mid . " AND mbox='" . $this->lp['login'] . "'") ) {
			
			if( mysql_num_rows($this->db['result']) == 1 ) {
				
				return TRUE;
			}
		}
	}
}

function MailFilterIsByName($text) {
	
	if( $this->DBQuery("SELECT id FROM mailfilter WHERE mbox='" . $this->lp['login'] . "' AND mfrom='" . $text . "'") ) {
			
		if( mysql_num_rows($this->db['result']) == 1 ) {
				
			return TRUE;
		}
	}
}
							
function MailFilterBlockDelete($idarr) {
	
	$cntrm = 0;
	
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
		
		foreach($idarr as $id => $mid) {
			
			if( $mid != 0 ) {
		
				if( $this->MailFilterIs($mid) ) {
			
					$cntrm++;
					$this->DBQuery("DELETE FROM mailfilter WHERE id=" . $mid);						
				}
			}
		}
		
		if( $cntrm > 0 ) {
			
			$this->error['result'] = str_replace('$cntrm',$cntrm,$this->errorcode['54']);
		}
		
	} else {
		
		$this->error['result'] = $this->errorcode['55'];
	}
}

function MailCacheFunctionFlush($function) {
	
	if( isset($_SESSION['function'][$function]) ) {
		
		unset($_SESSION['function'][$function]);
	}
}
	
function MailOptionList() {
	
	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
		
		if( $this->DBQuery("SELECT * FROM mailoption WHERE mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					$_SESSION['function'][__FUNCTION__]['data']	= $row;
					$_SESSION['function'][__FUNCTION__]['refresh']	= time() + $this->timeout['func_cache'];
					$this->mail_option_list 			= $row;
					return TRUE;
				}
			}
		}
	} else {
		
		$this->mail_option_list = $_SESSION['function'][__FUNCTION__]['data'];
		return TRUE;
	}
}

function MailOptionUpdate($optionarr) { 
	
	$optionarr['blockmedia']	= ($optionarr['blockmedia'] != 1) ? 0 : 1;
	$optionarr['sslout']		= ($optionarr['sslout'] != 1) ? 0 : 1;
	$optionarr['sslin']		= ($optionarr['sslin'] != 1) ? 0 : 1;
	$optionarr['sessexp']		= ($optionarr['sessexp'] < 0 || $optionarr['sessexp'] > 4 ) ? 2 : $optionarr['sessexp'];
	$optionarr['sendformat']	= ($optionarr['sendformat'] != 1) ? 0 : 1;
	$optionarr['sendsave']		= ($optionarr['sendsave'] != 1) ? 0 : 1;
	$optionarr['recvformat']	= ($optionarr['recvformat'] != 1) ? 0 : 1;
	$optionarr['recvcheck']		= ($optionarr['recvcheck'] != 1) ? 0 : 1;
	$optionarr['recvchecksnd']	= ($optionarr['recvchecksnd'] != 1) ? 0 : 1;
	$optionarr['recvcheckdelay']	= ($optionarr['recvcheckdelay'] < 1 || $optionarr['recvcheckdelay'] > 5) ? 2 : $optionarr['recvcheckdelay'];
	$optionarr['folderview']	= ($optionarr['folderview'] != 1) ? 0 : 1;
	$optionarr['folderpage']	= ($optionarr['folderpage'] < 1 || $optionarr['folderpage'] > 1000) ? 50 : $optionarr['folderpage'];
	$optionarr['bookpage']		= ($optionarr['bookpage'] < 1 || $optionarr['bookpage'] > 1000) ? 50 : $optionarr['bookpage'];
	$optionarr['replybookadd']	= ($optionarr['replybookadd'] != 1) ? 0 : 1;
	$optionarr['replyinclude']	= ($optionarr['replyinclude'] != 1) ? 0 : 1;
	$optionarr['replyccme']		= ($optionarr['replyccme'] != 1) ? 0 : 1;
	$optionarr['replyccother']	= ($optionarr['replyccother'] != 1) ? 0 : 1;
	$optionarr['replyccaddr']	= ($optionarr['replyccother'] != 1) ? '' : $optionarr['replyccaddr'];
	$optionarr['headerview']	= ($optionarr['headerview'] != 1) ? 0 : 1;
	$optionarr['alertmsg']		= ($optionarr['alertmsg'] != 1) ? 0 : 1;
	$optionarr['alertsubject']	= ($optionarr['alertsubject'] != 1) ? 0 : 1;

	if( $this->DBQuery("UPDATE mailoption SET blockmedia='" . $optionarr['blockmedia'] . "',sslout='" . $optionarr['sslout'] . "',sslin='" . $optionarr['sslin'] . "',
			   sessexp='" . $optionarr['sessexp'] . "',sendformat='" . $optionarr['sendformat'] . "',sendsave='" . $optionarr['sendsave'] . "',
			   recvformat='" . $optionarr['recvformat'] . "',recvcheck='" . $optionarr['recvcheck'] . "',recvchecksnd='" . $optionarr['recvchecksnd'] . "',
			   recvcheckdelay='" . $optionarr['recvcheckdelay'] . "',folderview='" . $optionarr['folderview'] . "',
			   folderpage='" . $optionarr['folderpage'] . "',bookpage='" . $optionarr['bookpage'] . "',
			   replybookadd='" . $optionarr['replybookadd'] . "',replyinclude='" . $optionarr['replyinclude'] . "',replyccme='" . $optionarr['replyccme'] . "',
			   replyccother='" . $optionarr['replyccother'] . "',replyccaddr='" . addslashes(trim(strtolower($optionarr['replyccaddr']))) . "',
			   headerview='" . $optionarr['headerview'] . "',alertsubject='" . $optionarr['alertsubject'] . "',
			   alertmsg='" . $optionarr['alertmsg'] . "' WHERE mbox='" . $this->lp['login'] . "'") ) {
			
			   $this->MailCacheFunctionFlush('mailoptionlist');
			   
			   $_SESSION['result'] = $this->errorcode['52'];
			   
			   if( isset($_SESSION['option']['referer']) ) {
			   	
			   	header('Location: ' . $_SESSION['option']['referer']);
			   	unset($_SESSION['option']['referer']);
			   
			   } else {
			   	
			   	header('Location: http://' . $this->server['main'] . '/login/inbox');
			   }
			   
			   exit();
	}	
}

function MailScheduleAutoRpdStart() {

	$time = mktime(0,0,0,date('n'),date('d'),date('Y'));
	
	if( $this->DBQuery("SELECT mbox,subject,text FROM mailautorpd WHERE rdate=" . $time . " AND status='2'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			$result = $this->db['result'];
					
			while( $row = mysql_fetch_array($result,MYSQL_ASSOC) ) {
				
				$this->lp['login'] = $row['mbox'];
						
				if( $this->MailAccountPath() ) {
						
					list($user,$domain) = explode('@',$this->lp['login']);
			
					if( ($cmdfp = fopen($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user),'a')) && ($msgfp = fopen($this->mail_account_path . '/rpdmsg','w')) ) {
							
						flock($cmdfp,2);
						flock($msgfp,2);
						
						$rpdcmd  = $this->mail_account_path . '/Maildir/' . "\n";				
						$rpdcmd .= '|' . $this->bin['autorpd'] . ' ' . 
						  	  '--file="' . $this->mail_account_path . '/rpdmsg" ' .
							  '--from="' . $this->lp['login'] . '" ' .
							  '--work-dir="' . $this->mail_account_path . '" ' .
							  '--subject="' . trim($row['subject']) . "\"\n";
						
						fputs($cmdfp,$rpdcmd);
						fputs($msgfp,$row['text']);
						flock($cmdfp,3);
						flock($msgfp,3);
						fclose($cmdfp);
						fclose($msgfp);
							
						$this->DBQuery("UPDATE mailautorpd SET status='1' WHERE mbox='" . $this->lp['login'] . "'");
					}
				}
			}
		}
	}		
}

function MailScheduleAutoRpdStop() {

	$time = mktime(0,0,0,date('n'),date('d'),date('Y'));
	
	if( $this->DBQuery("SELECT mbox FROM mailautorpd WHERE sdate=" . $time . " AND status='1'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			$result = $this->db['result'];
					
			while( $row = mysql_fetch_array($result,MYSQL_ASSOC) ) {
				
				$this->lp['login'] = $row['mbox'];
				
				if( $this->MailAccountPath() ) {
	
					list($user,$domain) = explode('@',$this->lp['login']);
				
					if( ($fp = @fopen($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user),'r+')) ) {
				
						flock($fp,2);
								
						if( $this->MailFileRead($fp) ) {
							
							if( ($spos = strpos($this->mail_file_read,$this->mail_account_path . '/Maildir/')) !== FALSE ) {
					
								$epos 	= strpos($this->mail_file_read,'|' . $this->bin['autorpd'],$spos);
								$epos 	= strpos($this->mail_file_read,"\n",$epos) + 1;
								$buffer = str_replace(substr($this->mail_file_read,$spos,$epos - $spos),'',$this->mail_file_read);
								ftruncate($fp,0);
								rewind($fp);
								fputs($fp,$buffer);
							}		
						}
						
						flock($fp,3);
						fclose($fp);
					
					}
				}
				
				@unlink($this->mail_account_path . '/rpdmsg');	
				
				if( filesize($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user)) == 0 ) {
					
					@unlink($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user));
				}
					
				$this->DBQuery("UPDATE mailautorpd SET status='0' WHERE mbox='" . $this->lp['login'] . "'");
			}
		}
	}			
}
			
function MailAutoRpdRegister($subject, $text, $folder, $saveto, $rdate, $sdate) {
	
	$status	= 0;
	$rpdcmd	= '';
	
	$saveto	= ($saveto != 1) ? 0 : 1;
		
	if( strlen($subject) > 0 && strlen($subject) <= 64 ) {
		
		if( strlen($text) > 0 && strlen($text) <= 10240 ) {
			
			if( $sdate > $rdate && $rdate >= mktime(0,0,0,date('n'),date('d'),date('Y')) ) {
					
				if( $rdate == mktime(0,0,0,date('n'),date('d'),date('Y')) ) {
				
					$status = 1;
			
				} else {		
				
					$status = 2;
				}
					
				$text = trim($text);
				
				if( $status == 1 ) {
							
					if( $this->MailAccountPath() ) {
						
						list($user,$domain) = explode('@',$this->lp['login']);
			
						if( ($cmdfp = fopen($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user),'a')) && ($msgfp = fopen($this->mail_account_path . '/rpdmsg','w')) ) {
						
							flock($cmdfp,2);
							flock($msgfp,2);
							
							$rpdcmd  = $this->mail_account_path . '/Maildir/' . "\n";
							
							$rpdcmd .= '|' . $this->bin['autorpd'] . ' ' . 
						   		  '--file="' . $this->mail_account_path . '/rpdmsg" ' .
								  '--from="' . $this->lp['login'] . '" ' .
								  '--work-dir="' . $this->mail_account_path . '" ' .
								  '--subject="' . trim($subject) . "\"\n";
								  
							fputs($cmdfp,$rpdcmd);
							fputs($msgfp,$text);
							flock($cmdfp,3);
							flock($msgfp,3);
							fclose($cmdfp);
							fclose($msgfp);
						}
					}
				}		
				
				if( $saveto == 1 ) {
					
					if( !$this->MailFolderIsByName($folder) ) {
						
						$folder = 'Inbox';
					}
				}		
								
				if( $this->DBQuery("UPDATE mailautorpd SET subject='" . addslashes(trim($subject)) . "',text='" . addslashes(trim($text)) . "',folder='" . addslashes($folder) . "',saveto='" . $saveto . "',rdate=" . $rdate . ",sdate=" . $sdate . ",status='" . $status . "' WHERE mbox='" . $this->lp['login'] . "'") ) {
				
					$this->error['result'] = $this->errorcode['64'];
					return TRUE;	
				}
			} else {
				
				$this->error['result'] = $this->errorcode['63'];
			}	
		} else {
			
			$this->error['result'] = $this->errorcode['62'];
		}
	} else {
		
		$this->error['result'] = $this->errorcode['61'];
	}
}

function MailAccountDefaultRegister($mid) {
	
	if( $this->MailAccountIs($mid) ) {
		
		if( $this->DBQuery("UPDATE mailaccount SET dflt=0 WHERE mbox='" . $this->lp['login'] . "'") ) {
			
			if( $this->DBQuery("UPDATE mailaccount SET dflt=1 WHERE id=" . $mid . " AND mbox='" . $this->lp['login'] . "'") ) {
				
				$this->MailCacheFunctionFlush('mailaccountlist');
				return TRUE;
			}
		}
	} 	
}

function MailAccountPath() {
		
	$templateline		= '';
	list($user,$domain) 	= explode('@',$this->lp['login']);
	
	if( ($fp = @fopen($this->path['vpopdomain'] . '/' .  $domain . '/vpasswd','r')) ) {
		
		flock($fp,2);
	
		while( !feof($fp) ) {
		
			$line = fgets($fp,1024);
			list($userid,$passwd,$uid,$gid,$name,$homedir,$quota) = explode(':',$line);			
		
			if($userid == $user) {
			
				$templateline = $homedir; 
				break;
			}
		}
		
		flock($fp,3);
		fclose($fp);
		
		if( !empty($templateline) ) {
			
			$this->mail_account_path = trim($templateline);
			return TRUE;
		}
	}
}

function MailFileRead($fp) {
	
	$buffer = '';
	
	while( !feof($fp) ) {
		
		$buffer .= fgets($fp,512);
	}
	
	$this->mail_file_read = $buffer;
	return TRUE;
}

function MailAutoRpdRelease() { 

	if( $this->MailAccountPath() ) {
				
		list($user,$domain) = explode('@',$this->lp['login']);
				
		if( ($fp = @fopen($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user),'r+')) ) {
				
			flock($fp,2);
								
			if( $this->MailFileRead($fp) ) {
							
				if( ($spos = strpos($this->mail_file_read,$this->mail_account_path . '/Maildir/')) !== FALSE ) {
					
					$epos 	= strpos($this->mail_file_read,'|' . $this->bin['autorpd'],$spos);
					$epos 	= strpos($this->mail_file_read,"\n",$epos) + 1;
					$buffer = str_replace(substr($this->mail_file_read,$spos,$epos - $spos),'',$this->mail_file_read);
					ftruncate($fp,0);
					rewind($fp);
					fputs($fp,$buffer);
				}
			}
				
			flock($fp,3);
			fclose($fp);
							
			@unlink($this->mail_account_path . '/rpdmsg');
				
			if( filesize($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user)) == 0 ) {
					
				@unlink($this->path['vpopdomain'] . '/' . $domain . '/.qmail-' . str_replace('.',':',$user));
			}
		}
	}			
		
	if( $this->DBQuery("UPDATE mailautorpd SET status='0' WHERE mbox='" . $this->lp['login'] . "'") ) {
				
		$this->error['result'] 			= $this->errorcode['65'];
		return TRUE;
	}
}

function MailAutoRpdOptionRegister() {
	
	$queryarr		= array();
	$queryarr['mbox']	= $this->lp['login'];
	$queryarr['subject']	= '';
	$queryarr['text']	= '';
	$queryarr['folder']	= 'Inbox';
	$queryarr['saveto']	= 0;
	$queryarr['rdate']	= 0;
	$queryarr['sdate']	= 0;
	$queryarr['status']	= 0;
	
	if( $this->DBInsert('mailautorpd',$queryarr) ) {
				
		if( mysql_affected_rows($this->db['link']) == 1 ) {
		
			return TRUE;
		}
	}	
}

function MailAutoRpdList() {
	
	if( $this->DBQuery("SELECT subject,text,folder,saveto,rdate,sdate,status FROM mailautorpd WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_autorpd_list 		= $row;
			}
			
			switch($this->mail_autorpd_list['status']) {
				
				case 0:	
					$this->mail_autorpd_list['statusimg']	= '<img src="/img/auto_res_off.gif" width="156" height="13">';
					break;
				
				case 1:
					$this->mail_autorpd_list['statusimg']	= '<img src="/img/auto_res_on.gif" width="156" height="13">';
					break;
				
				case 2:
					$this->mail_autorpd_list['statusimg']	= '<img src="/img/auto_res_pnd.gif" width="180" height="13">';	
					break;	
			}			
		}
	}
}
		
function MailOptionRegister() {
	
	$queryarr			= array();
	$queryarr['mbox']		= $this->lp['login'];
	$queryarr['blockmedia']		= 0;
	$queryarr['sslout']		= 0;
	$queryarr['sslin']		= 0;
	$queryarr['sessexp']		= 2;
	$queryarr['sendformat']		= 1;
	$queryarr['sendsave']		= 1;
	$queryarr['recvformat']		= 1;
	$queryarr['recvcheck']		= 1;
	$queryarr['recvcheckdelay'] 	= 2;
	$queryarr['recvchecksnd']	= 1;
	$queryarr['folderview']		= 0;
	$queryarr['folderpage']		= 50;
	$queryarr['bookpage']		= 50;
	$queryarr['bookxprs']		= 1;
	$queryarr['replybookadd']	= 1;
	$queryarr['replyinclude']	= 1;
	$queryarr['replyccme']		= 0;
	$queryarr['replyccother']	= 0;
	$queryarr['replyccaddr']	= '';
	$queryarr['spamlogrm']		= 0;
	$queryarr['spamformat']		= 0;
	$queryarr['spamadvmv']		= 1;
	$queryarr['headerview']		= 0;
	$queryarr['alertsubject']	= 1;
	$queryarr['alertmsg']		= 1;
	
	if( $this->DBInsert('mailoption',$queryarr) ) {
		
		if( mysql_affected_rows($this->db['link']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailOptionFormat($optionarr) {

	if( is_array($optionarr) && sizeof($optionarr) > 0 ) {
		
		if( $optionarr['replyccother'] == 1 ) {
			
			list($user,$domain) = explode('@',$optionarr['replyccaddr']);
					
			if( !$this->MailFormatEmail($optionarr['replyccaddr']) || !checkdnsrr($domain,'MX') ) {
			
				$this->mail_option_img_error['replyccaddr'] = TRUE;
			}
		}
	
		if( !is_array($this->mail_option_img_error) ) {
		
			return TRUE;
	
		} else {
			
			$this->error['result'] = $this->errorcode['32'];
		}
	}
}	
function MailOptionIs() {

	if( $this->DBQuery("SELECT id FROM mailoption WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailFilterPrivateList() {
	
	$templateline = '';
	
	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
		
		if( $this->DBQuery("SELECT pemail,bemail FROM mailbook WHERE mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
				
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					if( !empty($row['pemail']) ) {
					
						$templateline .= $row['pemail'] . ',';
				
					} elseif( !empty($row['bemail']) ) {
					
						$templateline .= $row['bemail'] . ',';
					}
				}
				
				$templateline 					= substr($templateline,0,-1);
				$_SESSION['function'][__FUNCTION__]['data'] 	= $templateline;
				$_SESSION['function'][__FUNCTION__]['refresh'] 	= time() + $this->timeout['func_cache'];
				$this->mail_filter_private_list 		= $templateline;
			}
		}
	} else {
		
		$this->mail_filter_private_list = $_SESSION['function'][__FUNCTION__]['data'];
	}
	
	return TRUE;
}				
		
function MailFilterBlockRegister($text) {
	
	$queryarr	= array();
	$text 		= strtolower(trim($text));
		
	if( $this->MailAccountList() ) {
		
		if( $this->MailFormatEmail($text) || $this->MailFormatDomain($text) ) {
			
			if( !$this->MailFilterIsByName($text) ) {
										
				if( !strstr($this->mail_account_address_list,$text) ) {
						
					if( !strstr($text,'akalink.com') ) {
						
						$queryarr['mbox']	= $this->lp['login'];
						$queryarr['mfrom']	= $text;
						
						if( $this->DBInsert('mailfilter',$queryarr) ) {
						
							$this->error['result'] = str_replace('$text',$text,$this->errorcode['60']);
							return TRUE;
						}
					} else {
							
						$this->error['result'] = $this->errorcode['59'];
					}
				} else {
					
					$this->error['result'] = $this->errorcode['58'];
				}
			} else {
				
				$this->error['result'] = $this->errorcode['57'];		
			}
			
		} else {
		
			$this->error['result'] = $this->errorcode['56'];
		}
	}
}

function MailPageList() {
	
	$templateline = '';
	
	if( $this->mail_status['msg_cnt'] > $this->mail_option_list['folderpage'] ) {
		
		for($page=0; $page<$this->mail_status['msg_cnt']; $page+=$this->mail_option_list['folderpage']) {
						
			$cnt++;
				
			if( $this->mail_page_pos == $page) {
				
				$templateline .= '<option selected value="' . $page . '">Page ' . $cnt . '</option>';
		
			} else {
				
				$templateline .= '<option value="' . $page . '">Page ' . $cnt . '</option>';
			}
		}					
	
		$this->mail_page_list = $templateline; 	
	}
}

function MailPageSelect($actarr,$pagejump) {
	
	if( isset($_SESSION[$_SESSION['folder_cur']]['pagepos']) ) {
		
		$pagepos = $_SESSION[$_SESSION['folder_cur']]['pagepos'];
	
	} else {	
	
		$pagepos = 0;
	}	

	if( isset($pagejump) && is_numeric($pagejump) ) {
		
		if( $pagejump <= $this->mail_status['msg_cnt'] ) {
										
			$pagepos = $pagejump;
		}
	}
			
	if( is_array($actarr) ) {
				
		foreach($actarr as $action => $id) {
		
			if( $action == 'next') {
			
				if( ($this->mail_status['msg_cnt'] - $this->mail_option_list['folderpage']) > $pagepos ) {
		
					$pagepos += $this->mail_option_list['folderpage'];
				}
			}
	
			if( $action == 'previous' ) {
		
				if( $pagepos != 0 ) {
		
					$pagepos -= $this->mail_option_list['folderpage'];
				}
			}
		}
	}
	
	$this->mail_page_spos		= ($this->mail_status['msg_cnt'] == 0) ? 0 : $pagepos + 1;
			
	if( ($pagepos + $this->mail_option_list['folderpage']) > $this->mail_status['msg_cnt'] ) {
	
		$this->mail_page_epos	= $this->mail_status['msg_cnt'];

	} else {

		$this->mail_page_epos	= $pagepos + $this->mail_option_list['folderpage'];
	}

	$this->mail_page_pos 				= $pagepos;
	$_SESSION[$_SESSION['folder_cur']]['pagepos'] 	= $pagepos;	
}

function MailFilterLayer() {
	
	$this->MailFormatEmail($this->mail_msg_parse['mfrom']);

	if( $this->mail_option_list['spamformat'] == 1  ) {
	
		if( $this->MailFilterPrivateList() ) {
								
			if( !strstr($this->mail_filter_private_list,strtolower(trim($this->mail_email_match))) ) {
			
				return TRUE;			
			}
		}
	}

	if( $this->MailFilterBlockList() ) {
		
		if( $this->mail_filter_block_count > 0 ) {
			
			if( strstr($this->mail_filter_block_blacklist,strtolower(trim($this->mail_email_match))) !== FALSE ) {
			
				return TRUE;
			}
			
			list($user,$domain) = explode('@',$this->mail_email_match);
			
			if( strstr($this->mail_filter_block_blacklist,',' . strtolower(trim($domain))) !== FALSE ) {
				
				return TRUE;
			}	
		}
	}

	if( $this->MailWhiteListList() ) {

		if( isset($this->mail_white_list_list[strtolower(trim($this->mail_email_match))]) ) {

			return FALSE;
		}
	}

	if( $this->mail_option_list['spamadvmv'] == 1 ) {
		
		if( strstr(trim(strtolower(substr($this->mail_msg_parse['msubject'],0,4))),'adv') !== FALSE || strstr(trim(strtolower(substr($this->mail_msg_parse['msubject'],0,4))),'avd') !== FALSE ) {
		  
			$this->mail_msg_parse['mfolder'] = 'Spam';
			return FALSE;
		}
	}

	if( $this->MailFilterSpamCube() ) {
		
		$this->mail_msg_parse['mfolder'] = 'Spam';
		return FALSE;
	} 				 							
}	

function MailStatus() {
	
	$statusarr			= array();
	$statusarr['msg_unread']	= 0;
	$statusarr['msg_spam']		= 0;
	$statusarr['msg_cnt']		= 0;
	$statusarr['ind_size']		= 0;
	$statusarr['ind_maxsize']	= $this->mail_limit_list['inbox_size'] / 1024 / 1024;
	$statusarr['ind_pct']		= 0;
	$statusarr['ind_width']		= 5;
	$statusarr['ind_img']		= '/img/useage_bar.gif';
	
	if( $this->DBQuery("SELECT mfolder,mread,msize FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mdelete='0'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				if( 'Spam' == $row['mfolder'] ) {
					
					$statusarr['msg_spam']++;
				}
				
				if( $_SESSION['folder_cur'] == $row['mfolder'] ) {
					
					$statusarr['msg_cnt']++;
					
					if( $row['mread'] == 0 ) {
					
						  $statusarr['msg_unread']++;
					}
				}
				
				$statusarr['ind_size'] += $row['msize'];
			}
			
			$statusarr['ind_pct'] 	= ceil(($statusarr['ind_size'] / ($statusarr['ind_maxsize'] * 1024 * 1024)) * 100);
			$statusarr['ind_size'] 	= round($statusarr['ind_size'] / 1024 / 1024,1);
		}
	}
	
	$statusarr['ind_width'] = (ceil(($statusarr['ind_pct'] * 250) / 100) > 0) ? ceil(($statusarr['ind_pct'] * 250) / 100) : 5; 
	$statusarr['ind_img']	= ($statusarr['ind_pct'] > 80) ? '/img/useage_bar_over.gif' : '/img/useage_bar.gif';
	$this->mail_status	= $statusarr;
}
	
function MailEntityIs($login) {
		
	if( $this->DBQuery("SELECT mbox FROM mailcontact WHERE mbox='" . $login . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailFormatFolder($folder) {
	
	if( strlen(trim($folder)) > 1 && strlen(trim($folder)) <= $this->limit['folderlen'] ) {
		
		if( !stristr($folder,'\'') && !stristr($folder,'"') ) {
			
			return TRUE;
		}
	}		
}

function MailFolderRegister($folder, $rdonly = 0) {
	
	$queryarr = array();
	
	if( $this->MailFolderCount() ) {
		
		if( ($this->mail_folder_cnt + 1) <= $this->limit['max_folder'] ) {
					
			if( $this->MailFormatFolder($folder) ) {
			
				if( !$this->MailFolderIsByName($folder) ) {
			
					$queryarr['mbox'] 	= $this->lp['login'];
					$queryarr['folder']	= $folder;
					$queryarr['count']	= 0;
					$queryarr['share']	= 0;
					$queryarr['ctime']	= time();
					$queryarr['mtime']	= time();
					$queryarr['rdonly']	= $rdonly;
					
					if( $this->DBInsert('mailfolder',$queryarr) ) {
											
						$this->error['result'] = str_replace('$folder',$folder,$this->errorcode['07']);
						return TRUE;
					}
				} else {
			
					$this->error['result'] = str_replace('$folder',$folder,$this->errorcode['09']);
				}
			} else {
		
				$this->error['result'] = str_replace('$folder',$folder,$this->errorcode['08']);
			}
		} else {
			
			$this->error['result'] = $this->errorcode['113'];
		}
	}
} 	

function MailFolderUpdate($idarr) {
	
	$cnt = 0;
		
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
		
		foreach($idarr as $id => $name) {
			
			if( $this->MailFormatFolder($name) ) {
				
				if( $this->MailFolderIs($id) ) {
					
					if( $this->MailFolderNameGet($id) ) {
						
						if( $name != $this->mail_folder_id_name ) {
												
							$this->DBQuery("UPDATE mailfolder SET folder='" . addslashes($name) . "',ctime=" . time() . ",mtime=" . time() . " WHERE id=" . $id);
							$this->DBQuery("UPDATE mailbox SET mfolder='" .addslashes($name) . "' WHERE mbox='" . $this->lp['login'] . "' AND mfolder='" . addslashes($this->mail_folder_id_name)  . "'");			
							$this->DBQuery("UPDATE mailaccount SET folder='" . addslashes($name) . "' WHERE mbox='" . $this->lp['login'] . "' AND folder='" . addslashes($this->mail_folder_id_name)  . "'");
							$cnt++;
						}
					}
				}	
			} else {
				
				$this->error['result'] = $this->errorcode['26'];
			}
		}
		
		if( $cnt > 0 ) {
		
			$this->mailcachefunctionflush('mailaccountlist');					
			$this->error['result'] = $this->errorcode['27'];
			return TRUE;			
		}	 	
	}
}

function MailFolderDelete($idarr) {
	
	$msgcnt = 0;
	$cnt 	= 0;
	
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
		
		foreach($idarr as $id => $name) {
			
			if( $this->MailFolderIs($id) ) {
				
				if( $this->MailFolderNameGet($id) ) {
					
					if( !$this->MailAccountFolderIs($this->mail_folder_id_name) ) {
							
						if( $this->DBQuery("UPDATE mailbox SET mfolder='Deleted' WHERE mbox='" . $this->lp['login'] . "' AND mfolder='" . addslashes($this->mail_folder_id_name) . "'") ) {
					
							if( ($msgcount = mysql_affected_rows($this->db['link'])) > 0 ) {
						
								$this->DBQuery("UPDATE mailfolder SET count=(count)+ " . $msgcount . " WHERE mbox='" . $this->lp['login'] . "' AND folder='Deleted'");
							}	 		
					
							$this->DBQuery("DELETE FROM mailfolder WHERE id=" . $id); 
							$cnt++;
						}
					} else {
						
						$this->error['result'] = str_replace('$folder',$this->mail_folder_id_name,$this->errorcode['23']);
					}
				}
			}			
		}
		
		if( $cnt > 0 ) {
			
			$this->error['result'] = $this->errorcode['24'];
			return TRUE;				
	 	}
	 	
	 } else {
	 	
	 	$this->error['result'] = $this->errorcode['25'];
	 }	
}				
				
function MailContactRegister($contactarr) {

	foreach($contactarr as $name => $value) {
		
		$contactarr[$name] = addslashes(trim($value));
	}	
	
	$contactarr['fname']	= ucwords(strtolower($contactarr['fname']));
	$contactarr['mname']	= strtoupper(str_replace('.','',$contactarr['mname']));
	$contactarr['lname']	= ucwords(strtolower($contactarr['lname']));
	$contactarr['city']	= ucwords(strtolower($contactarr['city']));
	$contactarr['zip']	= strtoupper($contactarr['zip']);
	$contactarr['maiden']	= strtolower($contactarr['maiden']);
	$contactarr['dtel']	= $this->FixFormatPhone($contactarr['dtel']);
	$contactarr['etel']	= $this->FixFormatPhone($contactarr['etel']);
	$contactarr['ftel']	= $this->FixFormatPhone($contactarr['ftel']);
	$contactarr['date']	= time();
	
	if( $this->DBQuery("INSERT into mailcontact VALUES('"  . $this->lp['login'] . "','" . $contactarr['fname'] . "','" . $contactarr['mname'] . "','" .
			   $contactarr['lname'] . "','" . $contactarr['company'] . "','" . $contactarr['address'] . "','" . $contactarr['city'] . "','" .
			   $contactarr['state'] . "','" . $contactarr['zip'] . "','" . $contactarr['country'] . "','" . $contactarr['dtel'] . "','" .
			   $contactarr['dtelext'] . "','" . $contactarr['etel'] . "','" . $contactarr['etelext'] . "','" . $contactarr['ftel'] . "','" . 
			   $contactarr['maiden'] . "','" . $contactarr['bdate'] . "'," . $contactarr['date'] . ")") ) {
			   		   				
                return TRUE;
        }
}

function MailEntityRegister($contactarr) {
		
		$name = ucwords(strtolower($contactarr['fname'])) . ' ' . ucwords(strtolower($contactarr['lname']));
				
		$this->MailAccountRegister(array('auto' => 1,'nick' => 'AKAMail', 'name' => $name,'reply' => $this->lp['login'],'email' => $this->lp['login'], 'host' => $this->server['main'], 'login' => $this->lp['login'], 'passwd' => $this->lp['passwd'], 'color' => 'FFFFFF', 'saveto' => 'existant', 'existantfolder' => 'Inbox','port' => '110', 'rmcycle' => '4','rdonly' => '1', 'dflt' => '1'));	
		$this->MailOptionRegister();
		$this->MailAutoRpdOptionRegister();
		$this->MailLimitRegister();
		$this->MailBookGroupRegister('Everyone',1);			
		$this->MailFolderRegister('Inbox',1);
		$this->MailFolderRegister('Sent',1);
		$this->MailFolderRegister('Deleted',1);
		$this->MailFolderRegister('Drafts',1);
		$this->MailFolderRegister('Spam',1);
		$this->MailDirDataRegister();
		
		$tel_techsupport= $this->tel['techsupport'];
		$tel_sales	= $this->tel['sales'];	
			
		include($this->tpl['php'] . '/mail_welcome1_email_msg.tpl');
		include($this->tpl['php'] . '/mail_welcome1_email_subject.tpl');
		mail($this->lp['login'],$templatesubject,$template,"MIME-Version: 1.0\n" . "Content-Type: text/html; charset=iso-8859-1\n" . "Return-Path: <" . $this->email['support'] . ">\n" . "From: " . $this->email['support'] . "\n" . "X-Signed: " . md5(strtolower($contactarr['maiden'])));
		include($this->tpl['php'] . '/mail_welcome2_email_msg.tpl');
		include($this->tpl['php'] . '/mail_welcome2_email_subject.tpl');
		mail($this->lp['login'],$templatesubject,$template,"MIME-Version: 1.0\n" . "Content-Type: text/html; charset=iso-8859-1\n" . "Return-Path: <" . $this->email['ceo'] . ">\n" . "From: " . $this->email['ceo'] . "\n" . "X-Signed: " . md5(strtolower($contactarr['maiden'])));
				
		return TRUE;
}

function MailExec($cmd, $arg) {

	if( !is_file($cmd) ) {
				
		$this->error['result'] = $cmd . ' unexistant.';
	
	} elseif( empty($arg) )  {
	
		$this->error['result'] = 'Empty argument to ' . $cmd;
		
	} else {
		
		@exec($cmd . ' ' . $arg,$this->mail_exec_output,$mail_exec_return);
		
		if( $mail_exec_return == 0 ) {
				
			return TRUE;
		
		} else {	
			
			$this->error['result'] = $this->mail_exec_output;
		}
	}
}

function MailLoginInit() {

	if( !isset($_SESSION['login']) ) {

 		header('Location: http://' . $this->server['main']);
		exit();
	}
	
	$this->lp		= array();
	$this->lp['login']	= $_SESSION['login']['login'];
	$this->lp['passwd']	= $_SESSION['login']['passwd'];
}

function MailLoginExpire() {

	$timeout = 0;
	$timenow = time();
	
	switch($this->mail_option_list['sessexp']) {
			
		case 0:
			$timeout = 0;
			break;
		case 1:
			$timeout = 30 * 60;
			break;
		case 2:
			$timeout = 60 * 60;
			break;
		case 3:
			$timeout = 120 * 60;
			break;
		case 4:
			$timeout = 300 * 60;
			break;
	}			
	
	if( $timeout != 0 && ($timenow - $_SESSION['login']['timeout']) > $timeout) {
			
		header('Location: http://' . $this->server['main'] . '/session_expired');
		exit();
				
	} elseif( substr($_SERVER['REQUEST_URI'],-1) != '?' ) {
		
		$_SESSION['login']['timeout'] = $timenow;
	}	
}

function MailLoginRestoreIs($login, $maiden, $bdate) {
	
	$login	= strtolower(trim($login));
	$maiden	= strtolower(trim($maiden));

	if( $this->MailFormatEmail($login) && (strlen($maiden) >= $this->limit['min_maiden'] && strlen($maiden) <= $this->limit['max_maiden']) && strlen($bdate) == $this->limit['bdate'] ) {
		
		if( $this->DBQuery("SELECT mbox FROM mailcontact WHERE mbox='" . addslashes($login) . "' AND maiden='" . addslashes($maiden) . "' AND bdate='" . addslashes($bdate) . "'") ) {
					
			if( mysql_num_rows($this->db['result']) == 1 ) {
				
				if( $this->DBQuery("SELECT status FROM maillogin WHERE mbox='" . addslashes($login) . "'") ) {
					
					if( mysql_num_rows($this->db['result']) == 1 ) {
					
						if( $row = mysql_fetch_array($this->db['result']) ) {
							
							switch($row['status']) {
									
								case 0:
									$this->error['result'] = str_replace('$techsupport',$this->tel['techsupport'],$this->errorcode['01']);
									break;
							
								case 1:
									session_unset();
									$_SESSION['login']['login'] 	= strtolower(trim($login));
									return TRUE;
									break;
									
								case 2:
									$this->error['result'] = str_replace('$techsupport',$this->tel['techsupport'],$this->errorcode['02']);
									break;
							}
						}
					}
				}
			}
		}
	}												
	
	$this->error['result']	= $this->errorcode['03'];
}

function MailLoginRecord($login) {
	
	if( $this->DBQuery("UPDATE maillogin SET ip='" . $_SERVER['REMOTE_ADDR'] . "',date=" . time() . " WHERE mbox='" . $login . "'") ) {
		
		return TRUE;
	}
}

function MailLoginRestore($login, $rpasswd, $crpasswd) {
	
	$login	= strtolower(trim($login));
	
	if( $this->MailFormatEmail($login) ) {
				
		if( strlen($rpasswd) >= $this->limit['min_passwd'] && strlen($rpasswd) <= $this->limit['max_passwd'] ) {
		
			if( $rpasswd ==	$crpasswd ) {
			
				if( $this->MailExec($this->bin['vpasswd'],escapeshellarg($login) . ' ' . escapeshellarg(trim($rpasswd))) ) {
					
					if( $this->DBQuery("UPDATE maillogin SET passwd='" . addslashes(trim($rpasswd)) . "' WHERE mbox='" . $login . "'") ) {
						
						if( $this->DBQuery("UPDATE mailaccount SET passwd='" . addslashes(trim($rpasswd)) . "' WHERE mbox='" . $login . "' AND nick='AKAMail'") ) {
																	
							$_SESSION['login']['passwd']	= trim($rpasswd);
							$_SESSION['login']['timeout']	= time();
							$_SESSION['result']		= $this->errorcode['06'];
							$this->MailLoginRecord($login);
							$this->MailStatUpdate($login,'login');
							$this->MailAccountClean($login);
							
							if( isset($_SERVER['HTTPS']) ) {
						
								header('Location: https://' . $this->server['main'] . '/login/inbox');
						
							} else {
							
								header('Location: http://' . $this->server['main'] . '/login/inbox');
							}
			
							exit();			
						}
					}
				}
			
			} else {
		
				$this->error['result'] = $this->errorcode['04'];
			}
		} else {
		
			$this->error['result'] = $this->errorcode['05'];
	 	}
	 } else {
	 	
	 	$this->error['result'] = $this->errorcode['03'];
	 }
}

function MailPasswdAlter($cpasswd, $npasswd, $cnpasswd) {
	
	if( strlen($npasswd) >= $this->limit['min_passwd'] && strlen($npasswd) <= $this->limit['max_passwd'] ) {
		
		if( $npasswd ==	$cnpasswd ) {
			
			if( $cpasswd == $this->lp['passwd'] ) {
				
				if( $this->MailExec($this->bin['vpasswd'],escapeshellarg($this->lp['login']) . ' ' . escapeshellarg(trim($npasswd))) ) {
					
					if( $this->DBQuery("UPDATE maillogin SET passwd='" . addslashes(trim($npasswd)) . "' WHERE mbox='" . $this->lp['login'] . "'") ) {
						
						if( $this->DBQuery("UPDATE mailaccount SET passwd='" . addslashes(trim($npasswd)) . "' WHERE mbox='" . $this->lp['login'] . "' AND nick='AKAMail'") ) {
									
							$_SESSION['login']['passwd'] = $npasswd;
						
							if( isset($_COOKIE['login']) ) {
							
								setcookie("login[passwd]",md5($_SESSION['login']['passwd']),time() + 2592000,'/',$this->server['main'],0);
							}
								
							$this->error['result'] = $this->errorcode['38'];
							return TRUE;				
						}
					}
				}
			} else {
			
				$this->error['result'] = $this->errorcode['39'];
			}
		} else {
		
			$this->error['result'] = $this->errorcode['40'];
		}
	} else {
		
		$this->error['result'] = $this->errorcode['41'];
	 }
}

function MailContactNamePrint() {
	
	if( $this->MailContactList() ) {
		
		if( isset($this->mail_contact_list['fname']) && isset($this->mail_contact_list['lname']) ) {
			
			print($this->mail_contact_list['fname'] . ' ' . $this->mail_contact_list['lname']);
		
		} else {
			
			print($this->lp['login']);	
		}
	} else {
		
		print($this->lp['login']);
	}
}
	
function MailContactList() {
	
	$contactarr = array();
	
	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
			
		if( $this->DBQuery("SELECT * FROM mailcontact WHERE mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					foreach($row as $name => $value) {
					
						if( !empty($value) ) {
										
							$contactarr[$name] = $value;
						}
					}
					
					$_SESSION['function'][__FUNCTION__]['data']	= $contactarr;
					$_SESSION['function'][__FUNCTION__]['refresh']	= time() + $this->timeout['func_cache'];	
					$this->mail_contact_list 			= $contactarr;
					return TRUE;
				}
			}
		}
	} else {
		
		$this->mail_contact_list = $_SESSION['function'][__FUNCTION__]['data'];
		return TRUE;
	}
}			

function FixFormatPhone($tel) {
	
	if( strlen($tel) == 10 && is_numeric($tel) ) {
                                
       		$tel = $tel[0] . $tel[1] . $tel[2] . '-' . $tel[3] . $tel[4] . $tel[5] . '-' . $tel[6] . $tel[7] . $tel[8] . $tel[9];
	} 
       
       return $tel;
}	

function MailContactUpdate($contactarr) {
	
	$query			= '';
			
	$contactarr['fname']	= ucwords(strtolower($contactarr['fname']));
	$contactarr['mname']	= strtoupper(str_replace('.','',$contactarr['mname']));
	$contactarr['lname'] 	= ucwords(strtolower($contactarr['lname']));
	$contactarr['city']	= ucwords(strtolower($contactarr['city']));
	$contactarr['zip'] 	= strtoupper($contactarr['zip']);
	$contactarr['maiden'] 	= strtolower($contactarr['maiden']);
	$contactarr['dtel']	= $this->FixFormatPhone($contactarr['dtel']);
	$contactarr['etel']	= $this->FixFormatPhone($contactarr['etel']);
	
	unset($contactarr['bdmonth']);
	unset($contactarr['bdday']);
	unset($contactarr['bdyear']);
	
	$query = "UPDATE mailcontact SET ";
	
	foreach($contactarr as $name => $value) {
					
		$query .= $name . '=\'' . addslashes(trim($value)) . '\', ';
	}
	
	$query  = substr($query,0,-2);
	$query .= ' WHERE mbox=\'' . $this->lp['login'] . '\'';
	
	if( $this->DBQuery($query) ) {
		
		$this->MailCacheFunctionFlush('mailcontactlist');
		$_SESSION['result'] = $this->errorcode['37'];
		header('Location: https://' . $this->server['main'] . '/login/options/01');
		exit();				
        }
}
                		
function MailContactFormat($contactarr) {
											
	if( !preg_match("/^([a-z\-\.\s\']{2,20})$/i",trim($contactarr['fname'])) ) {
		
		$this->mail_contact_img_error['fname'] = TRUE;
	}
		
	if( !preg_match("/^([a-z\-\.\s\']{2,20})$/i",trim($contactarr['lname'])) ) {
	
		$this->mail_contact_img_error['lname'] = TRUE;
	}
	
	if( !empty($contactarr['mname']) && !preg_match("/^([a-z\.]{1,2})$/i",trim($contactarr['mname'])) ) {
	
		$this->mail_contact_img_error['mname'] = TRUE;
	}
	
	if( !empty($contactarr['bizname']) && !preg_match("/^([a-z0-9\-\.\&\#\s\'\,]{2,60})$/i",trim($contactarr['bizname'])) ) {
	
		$this->mail_contact_img_error['bizname'] = TRUE;
	}
	
	if( !preg_match("/^([a-z0-9\#\-\.\&\s]{2,30})$/i",trim($contactarr['address'])) ) {
	
		$this->mail_contact_img_error['address'] = TRUE;
	}
		
	if( !preg_match("/^([a-z\-\.\s]{2,20})$/i",trim($contactarr['city'])) ) {
	
		$this->mail_contact_img_error['city'] = TRUE;
	}	
			
	if( !preg_match("/^([A-Z]{2})$/",trim($contactarr['state'])) ) {
	
		$this->mail_contact_img_error['state'] = TRUE;
	}
	
	if( !preg_match("/^([A-Z]{2})$/",trim($contactarr['country'])) ) {
	
		$this->mail_contact_img_error['country'] = TRUE;
	}
	
	if( $contactarr['country'] != 'US' && $contactarr['country'] != 'CA' ) {
		
		if( !empty($contactarr['zip']) && !preg_match("/^([a-z0-9\-\s]{3,15})$/i",trim($contactarr['zip'])) ) {
	 
			$this->mail_contact_img_error['zip'] = TRUE;
	 	}
	 
	 } elseif( !preg_match("/^([a-z0-9\-\s]{3,15})$/i",trim($contactarr['zip'])) ) {
	 
		$this->mail_contact_img_error['zip'] = TRUE;
	 }	
	 
	if( !preg_match("/^([a-z0-9\-]{10,20})$/i",trim($contactarr['dtel'])) ) {
	 
	 	$this->mail_contact_img_error['dtel'] = TRUE;
	}	
	
	if( !empty($contactarr['etel']) && !preg_match("/^([a-z0-9\-]{10,20})$/i",trim($contactarr['etel'])) ) {
	 
	 	$this->mail_contact_img_error['etel'] = TRUE;
	}	
	
	if( !empty($contactarr['dtelext']) && !preg_match("/^([0-9]{1,5})$/",trim($contactarr['dtelext'])) ) {
	 
	 	$this->mail_contact_img_error['dtel'] = TRUE;
	}	
	
	if( !empty($contactarr['etelext']) && !preg_match("/^([0-9]{1,5})$/",trim($contactarr['etelext'])) ) {
	 
	 	$this->mail_contact_img_error['etel'] = TRUE;
	}	
	
	if( !preg_match("/^([a-z\-\.\s\']{2,20})$/i",trim($contactarr['maiden'])) ) {
	
		$this->mail_contact_img_error['maiden'] = TRUE;
	}
				
	if( $contactarr['country'] == 'US' && !is_numeric($contactarr['zip']) ) {
			
		$this->mail_contact_img_error['zip'] = TRUE;
	}
		
	if( $contactarr['country'] == 'CA' && is_numeric($contactarr['zip']) ) {
			
		$this->mail_contact_img_error['zip'] = TRUE;
	}
	
	if( !is_array($this->mail_contact_img_error) ) {
			
		return TRUE;
		
	} else {
		
		$this->error['result'] = $this->errorcode['32'];
	}
}

function MailContactStatePrint($state) {
		
	$statearray = array("AL" => "Alabama",
     			    "AK" => "Alaska",
      			    "AZ" => "Arizona",
      			    "AR" => "Arkansas",
      			    "CA" => "California",
      			    "CO" => "Colorado",
      			    "CT" => "Connecticut",
      			    "DE" => "Delaware",
      			    "DC" => "District of Columbia",
      			    "FL" => "Florida",
      			    "GA" => "Georgia",
      			    "HI" => "Hawaii",
      			    "ID" => "Idaho",
      			    "IL" => "Illinois",
     		            "IN" => "Indiana",
      			    "IA" => "Iowa",
      			    "KS" => "Kansas",
      			    "KY" => "Kentucky",
      			    "LA" => "Lousiana",
      			    "ME" => "Maine",
      			    "MD" => "Maryland",
      			    "MA" => "Massachusetts",
      			    "MI" => "Michigan",
      			    "MN" => "Minnesota",
      			    "MS" => "Mississippi",
      			    "MO" => "Missouri",
      			    "MT" => "Montana",
      			    "NE" => "Nebraska",
      			    "NV" => "Nevada",
      			    "NH" => "New Hampshire",
      			    "NJ" => "New Jersey",
      		            "NM" => "New Mexico",
      			    "NY" => "New York",
      			    "NC" => "North Carolina",
      			    "ND" => "North Dakota",
      			    "OH" => "Ohio",
      			    "OK" => "Oklahoma",
      			    "OR" => "Oregon",
      			    "PA" => "Pennsylvania",
      			    "RI" => "Rhode Island",
      			    "SC" => "South Carolina",
      		            "SD" => "South Dakota",
      			    "TN" => "Tennessee",
      			    "TX" => "Texas",
      			    "UT" => "Utah",
      			    "VT" => "Vermont",
      			    "VA" => "Virginia",
      		            "WA" => "Washington",
      		            "WV" => "West Virginia",
      			    "WI" => "Wisconsin",
      			    "WY" => "Wyoming");

	foreach($statearray as $ainitial => $astate) {
	
		if($ainitial == $state) return $astate; 
	}

	return FALSE;
}

function MailContactCountryPrint($country) {
	
	$templateline = '';
		
 	$countryarray = array("US" => "United States of America",
 			"CA" => "Canada",
			"AF" => "Afghanistan",
			"AL" => "Albania",
                 	"DZ" => "Algeria",
                 	"AS" => "American Samoa",
		 	"AD" => "Andorra",
		 	"AO" => "Angola",
		 	"AI" => "Anguilla",
		 	"AQ" => "Antarctica",
		 	"AG" => "Antigua and Barbuda",
		 	"AR" => "Argentina",
		 	"AM" => "Armenia",
		 	"AW" => "Aruba",
		 	"AU" => "Australia",
		        "AT" => "Austria",
			"AZ" => "Azerbaijan",
			"BS" => "Bahamas",
		 	"BH" => "Bahrain",
		 	"BD" => "Bangladesh",
		 	"BB" => "Barbados",
		 	"BY" => "Belarus",
		 	"BE" => "Belgium",
		 	"BZ" => "Belize",
		 	"BJ" => "Benin",
		 	"BM" => "Bermuda",
		 	"BT" => "Bhutan",
		 	"BO" => "Bolivia",
		 	"BA" => "Bosnia and Herzegowina",
		 	"BW" => "Botswana",
		 	"BV" => "Bouvet Island",
		 	"BR" => "Brazil",
		 	"IO" => "British Indian Ocean Territory",
		 	"BN" => "Brunei Darussalam",			
		 	"BG" => "Bulgaria",
		 	"BF" => "Burkina Faso",
		 	"BI" => "Burundi",
		 	"KH" => "Cambodia",
		 	"CM" => "Cameroon",
		 	"CV" => "Cape Verde",
		 	"KY" => "Cayman Islands",
		 	"CF" => "Central African Republic",
		 	"TD" => "Chad",
		 	"CL" => "Chile",
		 	"CN" => "China",
		 	"CX" => "Christmas Island",
		 	"CC" => "Cocos (Keeling) Islands",
		 	"CO" => "Colombia",
		 	"KM" => "Comoros",
		 	"CG" => "Congo",
		 	"CD" => "Congo, the Democratic Republic of the",
		 	"CK" => "Cook Islands",
		 	"CR" => "Costa Rica",
		 	"CI" => "Cote d'Ivoire",
		 	"HR" => "Croatia (Hrvatska)",
		 	"CU" => "Cuba",
		 	"CY" => "Cyprus",
		 	"CZ" => "Czech Republic",
		 	"DK" => "Denmark",
		 	"DJ" => "Djibouti",
		 	"DM" => "Dominica",
		 	"DO" => "Dominican Republic",
		 	"TP" => "East Timor",
		 	"EC" => "Ecuador",
		 	"EG" => "Egypt",
		 	"SV" => "El Salvador",
		 	"GQ" => "Equatorial Guinea",
		 	"ER" => "Eritrea",
		 	"EE" => "Estonia",
		 	"ET" => "Ethiopia",
		 	"FK" => "Falkland Islands (Malvinas)",
		 	"FO" => "Faroe Islands",
		 	"FJ" => "Fiji",
			"FI" => "Finland",
		        "FR" => "France",
		 	"FX" => "France, Metropolitan",
	         	"GF" => "French Guiana",
		 	"PF" => "French Polynesia",
		 	"TF" => "French Southern Territories",
		 	"GA" => "Gabon",
		 	"GM" => "Gambia",
		 	"GE" => "Georgia",
		 	"DE" => "Germany",
		 	"GH" => "Ghana",
		 	"GI" => "Gibraltar",
		 	"GR" => "Greece",
		 	"GL" => "Greenland",
		 	"GD" => "Grenada",
		 	"GP" => "Guadeloupe",
		 	"GU" => "Guam",
		 	"GT" => "Guatemala",
		 	"GN" => "Guinea",
		 	"GW" => "Guinea-Bissau",
		 	"GY" => "Guyana",
		 	"HT" => "Haiti",
		 	"HM" => "Heard and Mc Donald Islands",
		 	"VA" => "Holy See (Vatican City State)",
		 	"HN" => "Honduras",
		 	"HK" => "Hong Kong",
		 	"HU" => "Hungary",
		 	"IS" => "Iceland",
		 	"IN" => "India",
		 	"ID" => "Indonesia",
		 	"IR" => "Iran, Islamic Republic of",
		 	"IQ" => "Iraq",
		 	"IE" => "Ireland",
		 	"IL" => "Israel",
		 	"IT" => "Italy",
		 	"JM" => "Jamaica",
		 	"JP" => "Japan",
		 	"JO" => "Jordan",
		 	"KZ" => "Kazakhstan",
	         	"KE" => "Kenya",
		 	"KI" => "Kiribati",
		 	"KP" => "Korea, Democratic People's Republic of",
		 	"KR" => "Korea, Republic of",
			"KW" => "Kuwait",
			"KG" => "Kyrgyzstan",
		 	"LA" => "Lao, Democratic People's Republic of",
		 	"LV" => "Latvia",
		 	"LB" => "Lebanon",
		 	"LS" => "Lesotho",
		 	"LR" => "Liberia",
		 	"LY" => "Libyan Arab Jamahiriya",
                 	"LI" => "Liechtenstein",
		 	"LT" => "Lithuania",
		 	"LU" => "Luxembourg",
		 	"MO" => "Macau",
		 	"MK" => "Macedonia, The Former Yugoslav Republic of",
		 	"MG" => "Madagascar",
		 	"MW" => "Malawi",
		 	"MY" => "Malaysia",
		 	"MV" => "Maldives",
		 	"ML" => "Mali",
		 	"MT" => "Malta",
		 	"MH" => "Marshall Islands",
		 	"MQ" => "Martinique",
		 	"MR" => "Mauritania",
		 	"MU" => "Mauritius",
		 	"YT" => "Mayotte",
		 	"MX" => "Mexico",
		 	"FM" => "Micronesia, Federated States of",
		 	"MD" => "Moldova, Republic of",
		 	"MC" => "Monaco",
		 	"MN" => "Mongolia",
		 	"MS" => "Montserrat",
		 	"MA" => "Morocco",
		 	"MZ" => "Mozambique",
		 	"MM" => "Myanmar",
		 	"NA" => "Namibia",
		 	"NR" => "Nauru",
		 	"NP" => "Nepal",
		 	"NL" => "Netherlands",
		 	"AN" => "Netherlands Antilles",
		 	"NC" => "New Caledonia",
		 	"NZ" => "New Zealand",
		 	"NI" => "Nicaragua",
		 	"NE" => "Niger",
		 	"NG" => "Nigeria",
		 	"NU" => "Niue",
		 	"NF" => "Norfolk Island",
		 	"MP" => "Northern Mariana Islands",
	         	"NO" => "Norway",
		 	"OM" => "Oman",
		 	"PK" => "Pakistan",
		 	"PW" => "Palau",
		 	"PA" => "Panama",
		 	"PG" => "Papua New Guinea",
		 	"PY" => "Paraguay",	
		 	"PE" => "Peru",
		 	"PH" => "Phillippines",
		 	"PN" => "Pitcairn",
		 	"PL" => "Poland",
		 	"PT" => "Portugal",
		 	"PR" => "Puerto Rico",
		 	"QA" => "Qatar",
		 	"RE" => "Reunion",
		 	"RO" => "Romania",
		 	"RU" => "Russian Federation",
		 	"RW" => "Rwanda",
		 	"KN" => "Saint Kitts and Nevis",
		 	"LC" => "Saint LUCIA",
		 	"VC" => "Saint Vincent and the Grenadines",
		 	"WS" => "Samoa",
		 	"SM" => "San Marino",
		 	"ST" => "Sao Tome And Principe",
		 	"SA" => "Saudi Arabia",
		 	"SN" => "Senegal",
		 	"SC" => "Seychelles",
		 	"SL" => "Sierra Leone",
		 	"SG" => "Singapore",
		 	"SK" => "Slovakia (Slovak Republic)",
		 	"SI" => "Slovenia",
		 	"SB" => "Solomon Islands",
		 	"SO" => "Somalia",
		 	"ZA" => "South africa",
		 	"GS" => "South Georgia and the South Sandwich Islands",
		 	"ES" => "Spain",
		 	"LK" => "Sri Lanka",
		 	"SH" => "St. Helena",
		 	"PM" => "St. Pierre and Miquelon",
		 	"SD" => "Sudan",
		 	"SR" => "Suriname",
		 	"SJ" => "Svalbard and Jan Mayen Islands",
		 	"SZ" => "Swaziland",
		 	"CH" => "Switzerland",
		 	"SY" => "Syrian Arab Republic",
		 	"TW" => "Taiwan, Province of China",
		 	"TJ" => "Tajikistan",
		 	"TZ" => "Tanzania, United Republic of",
		 	"TH" => "Thailand",
		 	"TG" => "Togo",
		 	"TK" => "Tokelau",
		 	"TO" => "Tonga",
		 	"TT" => "Trinidad and Tobago",
		 	"TN" => "Tunisia",
		 	"TR" => "Turkey",
		 	"TM" => "Turkmenistan",
		 	"TC" => "Turks and Caicos Islands",
		 	"TV" => "Tuvalu",
		 	"UG" => "Uganda",
		 	"UA" => "Ukraine",
		 	"AE" => "United Arab Emirates",
		 	"GB" => "United Kingdom",
		 	"UM" => "United States Minor Outlying Islands",
		 	"UY" => "Uruguay",
		 	"UZ" => "Uzbekistan",
		 	"VU" => "Vanuatu",
		 	"VE" => "Venezuela",
		 	"VN" => "Viet Nam",
		 	"VG" => "Virgin Islands (British)",
		 	"VI" => "Virgin Islands (U.S.)",
		 	"WF" => "Wallis and Futuna Islands",
		 	"EH" => "Western Sahara",
		 	"YE" => "Yemen",
		 	"YU" => "Yugoslavia",
		 	"ZM" => "Zambia",
		 	"ZW" => "Zimbabwe");
		 		
		foreach($countryarray as $ainitial => $acountry) {
		
			if( $country == $ainitial ) {
			
				$templateline .= '<option selected value="' . $ainitial . '">' . $acountry . '</option>';	
		
			} else {
			
				$templateline .= '<option value="' . $ainitial . '">' . $acountry . '</option>';
			}
		}
	
		$this->mail_contact_country_list = $templateline;
		
		if( strlen($country) == 2 ) {
			
			return $countryarray[$country];
		}
		
}

function MailContactProvincePrint($province) {
	
	$provincearray = array("AB" => "Alberta",
			       "BC" => "British Columbia",
			       "MB" => "Manitoba",
			       "NB" => "New Brunswick",
			       "NF" => "Newfoundland",
			       "NS" => "Nova Scotia",
			       "NU" => "Nunavut",
			       "NT" => "Northwest Territories",
			       "ON" => "Ontario",
			       "PE" => "Prince Edward Island",
			       "QC" => "Quebec",
			       "SK" => "Saskatchewan",
			       "YT" => "Yukon");

	foreach($provincearray as $ainitial => $aprovince) {
	
		if($province == $ainitial) return $aprovince; 
	}
	
	return FALSE;
}

function MailFilterOptionUpdate($optionarr) {
	
	$optionarr['spamlogrm']		= ($optionarr['spamlogrm'] != 1) ? 0 : 1;
	$optionarr['spamformat']	= ($optionarr['spamformat'] != 1) ? 0 : 1;
	$optionarr['spamadvmv']		= ($optionarr['spamadvmv'] != 1) ? 0 : 1;
		
	if( $this->DBQuery("UPDATE mailoption SET spamlogrm='" . $optionarr['spamlogrm'] . "',spamformat='" . $optionarr['spamformat'] . "',spamadvmv='" . $optionarr['spamadvmv'] . "' WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		$this->MailCacheFunctionFlush('mailoptionlist');
		$_SESSION['result'] = $this->errorcode['53'];
		header('Location: http://' . $this->server['main'] . '/login/inbox');
		exit();
	}
}
	
function MailMsgBlockIs($email) {
	
	if( $this->MailAccountList() ) {
		
		if( strstr($this->mail_account_address_list,strtolower($email)) ) {
			
			return TRUE;
		}	
				
		if( $this->DBQuery("SELECT id FROM mailfilter WHERE mbox='" . $this->lp['login'] . "' AND mfrom='" . strtolower($email) . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1  ) {
			
				return TRUE;
			}
		}
	}
}

function MailMsgSizeCount() {
	
	if( $this->DBQuery("SELECT sum(msize) as mmsize FROM mailbox WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_msg_size_cnt = $row['mmsize'];
				return TRUE;
			}
		}
	}  
}
								
function MailMsgBlock($idarr) {
	
	$queryarr = array();
	$cntblock = 0;
	
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
		
		foreach($idarr as $id => $mid) {
			
			if( $this->MailMsgIs($mid) ) {
				
				if( $this->MailMsgViewHeader($mid) ) {
					
					if( $this->MailFormatEmail($this->mail_msg_view_header['mfrom']) ) {
								
						if( $this->MailMsgBlockIs($this->mail_email_match) ) {
							
							$this->DBQuery("UPDATE mailbox SET mdelete='1' WHERE mid=" . $mid);
							
						} else {
							
							$queryarr['mbox']	= $this->lp['login'];
							$queryarr['mfrom']	= $this->mail_email_match;
							$this->DBInsert('mailfilter',$queryarr);
							$this->DBQuery("UPDATE mailbox SET mdelete='1' WHERE mid=" . $mid);
						}
						
						$cntblock++;
					}
				}
			}	
		}
				
		if( $cntblock > 0 ) {
									
			$this->DBQuery("UPDATE mailfolder SET count=(count) - " . $cntblock . " WHERE mbox='" . $this->lp['login'] . "' AND folder='" . $_SESSION['folder_cur'] . "'");
			$this->error['result'] = str_replace('$cntblock',$cntblock,$this->errorcode['13']);
		}
			
	} else {
		
		$this->error['result'] = $this->errorcode['14'];
	}		
}	

function MailWhiteListBookFlush() {

	if( $this->DBQuery("SELECT pemail, bemail FROM mailbook WHERE mbox='" . $this->lp['login'] . "'") ) {

		$result = $this->db['result'];

		if( mysql_num_rows($result) > 0 ) {

			while( $row = mysql_fetch_array($result, MYSQL_ASSOC) ) {

				$email = (!empty($row['pemail'])) ? $row['pemail'] : $row['bemail'];

				if( !$this->MailWhiteListIs($email) ) {

					$this->DBInsert('mailwhitelist', array('id' => '', 'mbox' => $this->lp['login'], 'mfrom' => $email, 'date' => time()));
				}
			}
		}
	}
}

function MailWhiteListIs($email) {

	if( $this->MailFormatEmail($email) ) {

		if( $this->DBQuery("SELECT id FROM mailwhitelist WHERE mbox='" . $this->lp['login'] . "' AND mfrom='" . $email . "'") ) {

			if( mysql_num_rows($this->db['result']) == 1 ) {

				return TRUE;
			}
		}
	}
}

function MailWhiteListList() {

	$bufferarr = array();

	if( $this->DBQuery("SELECT mfrom FROM mailwhitelist WHERE mbox='" . $this->lp['login'] . "'") ) {

		if( mysql_num_rows($this->db['result']) > 0 ) {

			while( $row = mysql_fetch_array($this->db['result'], MYSQL_ASSOC) ) {
			
				$bufferarr[$row['mfrom']] = TRUE;
			}
			
			$this->mail_white_list_list = $bufferarr;
			return TRUE;
		}
	}
}
				
function MailMsgUnblock($idarr) {
	
	$queryarr 	= array();
	$cnt	 	= 0;
	
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
		
		foreach($idarr as $id => $mid) {
			
			if( $this->MailMsgIs($mid) ) {
		
				$this->DBUpdate('mailbox', array('mfolder' => 'Inbox'), "WHERE mid=" . $mid . " AND mbox='" . $this->lp['login'] . "'");
				$cnt++;
				
				if( $this->MailMsgViewHeader($mid) ) {

					if( $this->MailFormatEmail($this->mail_msg_view_header['mfrom']) ) {
						
						if( !$this->MailWhiteListIs(strtolower(trim($this->mail_email_match))) ) {

							$this->DBInsert('mailwhitelist', array('id' => '', 'mbox' => $this->lp['login'], 'mfrom' => strtolower(trim($this->mail_email_match)), 'date' => time()));
						}

						
					}
				}
			}	
		}
				
		if( $cnt > 0 ) {
									
			$this->DBQuery("UPDATE mailfolder SET count=(count) - " . $cnt . " WHERE mbox='" . $this->lp['login'] . "' AND folder='" . $_SESSION['folder_cur'] . "'");
			$this->DBQuery("UPDATE mailfolder SET count=(count) + " . $cnt . " WHERE mbox='" . $this->lp['login'] . "' AND folder='Inbox'");
			$this->error['result'] = str_replace('$cnt', $cnt, $this->errorcode['115']);
			return TRUE;
		}		
	}
		
	$this->error['result'] = $this->errorcode['116'];	
}
			
function MailMsgDeleteAll() {
	
	if( $this->DBQuery("SELECT mid FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mdelete='1'") ) {
		
		$result = $this->db['result'];
		
		if( mysql_num_rows($result) > 0 ) {
			
			while( $row = mysql_fetch_array($result,MYSQL_ASSOC) ) {
							
				$this->DBQuery("DELETE FROM mailbox WHERE mid=" . $row['mid']);
				$this->DBQuery("DELETE FROM msgbox WHERE mid=" . $row['mid']);
			}
		}
	}
	
	return TRUE;					
}		

function MailFilterDuplicate($duparr) {

        if( is_array($duparr) && sizeof($duparr) > 0 ) {

                foreach($duparr as $id => $hash) {

                        $this->MailDelete($id);
                }
        }
}

function MailMsgDeleteQueue($rmarr) {
	
	if( is_array($rmarr) && sizeof($rmarr) > 0 ) {
		
		foreach($rmarr as $id => $hash) {
						
			if( $this->DBQuery("SELECT mid FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mhash='" . $hash . "'") ) {
				
				if( mysql_num_rows($this->db['result']) == 1 ) {
					
					$result = $this->db['result'];
					
					if( $row = mysql_fetch_array($result, MYSQL_ASSOC) ) {
				
						$this->DBQuery("DELETE from mailbox WHERE mid=" . $row['mid']);
						$this->DBQuery("DELETE from msgbox WHERE mid=" . $row['mid']);
						$this->MailDelete($id);
					}
				}
			}
		}
	}
}

function MailPostIs($action) {
	
	if( (isset($_POST[$action . '_x']) && isset($_POST[$action . '_y'])) || isset($_POST[$action]) ) {
		
		return TRUE;
	} 
}

function MailFolderNameGet($id) {
	
	if( $this->DBQuery("SELECT folder FROM mailfolder WHERE id=" . $id . " AND mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_folder_id_name = $row['folder'];
				return TRUE;
			}
		}
	}
}
			
function MailFolderEmpty($folder) {

	$cntmsg = 0;
	
	if( $this->MailFolderIsByName($folder) ) {
		
		if( $folder == 'Deleted' || $folder == 'Spam' ) {
			
			if( $this->DBQuery("UPDATE mailbox SET mdelete='1' WHERE mbox='" . $this->lp['login'] . "' AND mfolder='" . addslashes($folder) . "'") ) {
				
				if( ($cntmsg = mysql_affected_rows($this->db['link'])) > 0 ) {
								
					$this->DBQuery("UPDATE mailfolder SET count=0 WHERE mbox='" . $this->lp['login'] . "' AND folder='" . addslashes($folder) . "'");
				}
			}			
		
		} elseif( $this->DBQuery("UPDATE mailbox SET mfolder='Deleted' WHERE mbox='" . $this->lp['login'] . "' AND mfolder='" . addslashes($folder) . "'") ) {
			
			if( ($cntmsg = mysql_affected_rows($this->db['link'])) > 0 ) {
				
				$this->DBQuery("UPDATE mailfolder SET count=0 WHERE mbox='" . $this->lp['login'] . "' AND folder='" . addslashes($folder) . "'");
				$this->DBQuery("UPDATE mailfolder SET count=(count)+ " . $cntmsg . " WHERE mbox='" . $this->lp['login'] . "' AND folder='Deleted'");
			}
		}												
							
		$this->error['result'] = str_replace('$folder',$folder,str_replace('$cntmsg',$cntmsg,$this->errorcode['12']));
	}				
}

function MailScheduleFeedBackClear() {
	
	$time = time() - $this->gc['feedback'];
	
	if( $this->DBQuery("DELETE FROM mailfeedback WHERE date < " . $time) ) {
		
		return TRUE;
	}
}

function MailScheduleReceiptClear() {

	$time = time() - $this->gc['receipt'];
	
	if( $this->DBQuery("DELETE FROM mailreceipt WHERE rdate < " . $time) ) {
		
		return TRUE;
	}
}

function MailScheduleStatClear() {
	
	$time =  time() - $this->gc['stat'];
	
	if( $this->DBQuery("DELETE FROM mailstat WHERE date < " . $time) ) {
		
		return TRUE;
	}
}

function MailScheduleComposeReset() {
	
	if( $this->DBLink() ) {
		
		if( $this->DBQuery("UPDATE maillimit SET send_cur=0") ) {
		
			return TRUE;
		}
	}
}
function MailFolderEmptySpam() {
	
	$msgcnt = 0;
	
	if( $this->DBQuery("UPDATE mailbox SET mdelete='1' WHERE mbox='" . $this->lp['login'] . "' AND mfolder='Spam'") ) {
				
		if( ($msgcnt = mysql_affected_rows($this->db['link'])) > 0 ) {
											
			$this->DBQuery("UPDATE mailfolder SET count=0 WHERE mbox='" . $this->lp['login'] . "' AND folder='Spam'");	
		}
	}			
}

function MailMsgDelete($idarr)  {
	
	$cntrm = 0;
	
	if( is_array($idarr) && sizeof($idarr) > 0 ) {
			
		foreach($idarr as $id => $mid) {
			
			if( $this->MailMsgIs($mid) ) {
				
				if( $_SESSION['folder_cur'] == 'Deleted' || $_SESSION['folder_cur'] == 'Spam' ) {
									
					$this->DBQuery("UPDATE mailbox SET mdelete='1' WHERE mid=" . $mid);
			
				} else {
					
					$this->DBQuery("UPDATE mailbox SET mfolder='Deleted' WHERE mid=" . $mid);
				}
			
				$cntrm++;	
			}
		}
		
		if( $cntrm > 0 ) {
			
			if( $_SESSION['folder_cur'] == 'Deleted' || $_SESSION['folder_cur'] == 'Spam' ) {
								
				$this->DBQuery("UPDATE mailfolder SET count=(count)-" . $cntrm . " WHERE mbox='" . $this->lp['login'] . "' AND folder='" . $_SESSION['folder_cur'] . "'");
			
			} else {
				
				$this->DBQuery("UPDATE mailfolder SET count=(count)-" . $cntrm . " WHERE mbox='" . $this->lp['login'] . "' AND folder='" . $_SESSION['folder_cur'] . "'");
				$this->DBQuery("UPDATE mailfolder SET count=(count)+" . $cntrm . " WHERE mbox='" . $this->lp['login'] . "' AND folder='Deleted'");	
			}
											
			$this->error['result'] = $this->errorcode['10'];
		}
			
	} else {
		
		$this->error['result'] = $this->errorcode['11'];
	}		
}
function MailList() {

	$templateline 	= '';
	$cnt 		= 0;
	
	if( $this->DBQuery("SELECT mid,mcolor,mfrom,msubject,mdate,msize,mstatus,mpriority,mfile,msign,mread,mrcptdate FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mfolder='" . $_SESSION['folder_cur'] . "' AND mdelete='0' ORDER BY " . $this->mail_list_sort . " LIMIT " . $this->mail_page_pos . "," . $this->mail_option_list['folderpage']) ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$cnt++;
						
				$row['mfrom'] = trim(str_replace('"','',stripslashes($row['mfrom'])));
			
				if( ($spos = strpos($row['mfrom'],'<')) !== FALSE ) {
					
					if( ($epos = strpos($row['mfrom'],'>',$spos)) !== FALSE ) {
						
						if( $row['mfrom'][0] != '<') {
							
							$row['mfrom'] = substr($row['mfrom'],0,$spos - 1);								
						} else {
							
							$row['mfrom'] = substr($row['mfrom'],1,-1);
						}
					}
				}				
				
				$row['mfrom'] 	= htmlspecialchars($row['mfrom']);				
				$textspad 	= '';
				$textepad 	= '';
				$bgcolor 	= '#' . $row['mcolor'];
											
				if( $row['mread'] == 0  && $_SESSION['folder_cur'] != 'Sent' ) {
					
					$textspad 	.= '<strong>';
					$textepad 	.= '</strong>';
				} 				
					
				$row['msubject']= (strlen($row['msubject']) > 32) ? substr(stripslashes($row['msubject']),0,25) . '...' : stripslashes($row['msubject']);
				$row['mfrom']	= (strlen($row['mfrom']) > 32) ? substr(stripslashes($row['mfrom']),0,25) . '...' : stripslashes($row['mfrom']);		
				$mid 		= $row['mid'];	
				$mfile 		= ($row['mfile'] == 1) ? '<img src="/img/icons/mailboxes/ico_attachment_clip_paper.gif" alt="Indicates this is an e-mail attachment" width="16" height="16" onMouseOver="window.status=\'Indicates this is an e-mail attachment.\'; return true;" onMouseOut="window.status=\'\'; return true;">' : NULL;
				$mfrom 		= $textspad . $row['mfrom'] . $textepad;
				$mdate 		= $textspad . date('n/j/y g:i a',$row['mdate']) . $textepad;
				$msize		= ($row['msize'] > 1048576) ? round($row['msize'] / 1024 / 1024,1) . ' MB' : round($row['msize'] / 1024) . ' KB';
				$msize 		= $textspad . $msize . $textepad;	
				$mrcptdate 	= ($row['mrcptdate'] != 0) ? $textspad . date('n/j/y g:i a',$row['mrcptdate']) . $textepad : $textspad . 'Unknown' . $textepad;
				
				if( $this->mail_option_list['sslin'] == 1 ) {
					
					$msubject = ($_SESSION['folder_cur'] != 'Drafts') ? $textspad . '<a href="https://' . $this->server['main'] . '/login/view/?mid=' . $mid . '">' . htmlspecialchars($row['msubject']) . '</a>' . $textepad : $textspad . '<a href="https://' . $this->server['main'] . '/login/compose?mid=' . $mid . '&action=send">' . htmlspecialchars($row['msubject']) . '</a>' . $textepad;
				
				} else {
				
					$msubject = ($_SESSION['folder_cur'] != 'Drafts') ? $textspad . '<a href="http://' . $this->server['main'] . '/login/view/?mid=' . $mid . '">' . htmlspecialchars($row['msubject']) . '</a>' . $textepad : $textspad . '<a href="http://' . $this->server['main'] . '/login/compose?mid=' . $mid . '&action=send">' . htmlspecialchars($row['msubject']) . '</a>' . $textepad;
				}
				
				switch($row['mpriority']) {
					
					case 1: 
						$mpriority = '<img src="/img/icons/mailboxes/ico_high_priority.gif" alt="Indicates this is a high priority E-mail" width="12" height="16" onMouseOver="window.status=\'Indicates this is a high priority E-mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">';
						break;
					case 5:
						$mpriority = '<img src="/img/icons/mailboxes/ico_low_priority.gif" alt="Indicates this is a low priority E-mail" width="12" height="16" onMouseOver="window.status=\'Indicates this is a low priority E-mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						break;
						
					default:
						$mpriority = '';
						break;
				}
							
				switch($row['mstatus']) {
					
					case 1:	
						if( $row['msign'] == 1 ) {
							
							$mstatus = ($row['mread'] == 0) ? '<img src="/img/icons/mailboxes/ico_email_unread_signature.gif" alt="Indicates that this is a new E-Mail." width="18" height="18" onMouseOver="window.status=\'Indicates that this is a new E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">' : '<img src="/img/icons/mailboxes/ico_email_read_signature.gif" alt="Indicates that you have already read this E-Mail." width="18" height="18" onMouseOver="window.status=\'Indicates that you have already read this E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						
						} else {			
							
							$mstatus = ($row['mread'] == 0) ? '<img src="/img/icons/mailboxes/ico_new_mail_unread.gif" alt="Indicates that this is a new E-Mail." width="16" height="13" onMouseOver="window.status=\'Indicates that this is a new E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">' : '<img src="/img/icons/mailboxes/ico_new_mail_read.gif" alt="Indicates that you have already read this E-Mail." width="17" height="14" onMouseOver="window.status=\'Indicates that you have already read this E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						}
						break;
						
					case 2:
						$mstatus = '<img src="/img/icons/mailboxes/ico_reply.gif" alt="You have replied to this E-Mail already." width="16" height="16" onMouseOver="window.status=\'You have replied to this E-Mail already.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						break;
					case 3:
						$mstatus = '<img src="/img/icons/mailboxes/ico_forward.gif" alt="You have forwarded this E-Mail to another person." width="16" height="16" onMouseOver="window.status=\'You have forwarded this E-Mail to another person.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						break;
					
					case 4:
						$mstatus = '<img src="/img/icons/mailboxes/ico_flagged.gif" alt="Indicates that this E-mail his flagged for Review." width="19" height="16" onMouseOver="window.status=\'Indicates that this E-mail his flagged for Review.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						break;
						
					case 5:
						$mstatus = '<img src="/img/icons/mailboxes/ico_appointment.gif" alt="Indicates that this E-mail is an Appointment." width="16" height="16" onMouseOver="window.status=\'Indicates that this E-mail is an Appointment.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
						break;
				}
				
				if( $_SESSION['folder_cur'] == 'Sent' ) {
						
					include($this->tpl['php'] . '/mail_list_sent.tpl');
				
				} else {
					
					include($this->tpl['php'] . '/mail_list.tpl');
				}
				
				$templateline .= $template;
			}
			
			$this->mail_list = $templateline;
			
		} else {
			
			include($this->tpl['php'] . '/mail_list_none.tpl');
			$this->mail_list_none = $template;
		}
	}
	
	$this->mail_list_cnt = $cnt;
} 
function MailQuit() {

	fputs($this->server['socket'],"QUIT\r\n");
	fclose($this->server['socket']);
}

function MailDelete($id) {

	fputs($this->server['socket'],'DELE ' . $id . "\r\n");
	$this->MailReadSocket();
}

function MailAccountIs($mid) {

	if( is_numeric($mid) ) {
			
		if( $this->DBQuery("SELECT id FROM mailaccount WHERE id=" . $mid . " AND mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1) {
			
				return TRUE;
			}
		}
	}
}

function MailAccountFolderIs($folder) {

	if( $this->MailFormatFolder($folder) ) {
			
		if( $this->DBQuery("SELECT id FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' AND folder='" . addslashes($folder) . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1) {
			
				return TRUE;
			}
		}
	}
}

function MailMsgDeleteIs($hash) {
	
	if( $this->DBQuery("SELECT mid FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mhash='" . $hash . "' AND mdelete='1'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailAccountReload() {
	
	$this->mail_account_reload_snd	= '';
	$this->mail_account_reload_time = '';
	$timeout			= 0;
	
	if( $this->mail_option_list['recvcheck'] == 1 ) {
		
		switch($this->mail_option_list['recvcheckdelay']) {
		
			case 1:
				$timeout = 5 * 60;
				break;
		
			case 2:
				$timeout = 30 * 60;
				break;
		
			case 3:
				$timeout = 60 * 60;
				break;
			
			case 4:
				$timeout = 120 * 60;
				break;
		
			case 5:
				$timeout = 300 * 60;
				break;
		}
			
		$this->mail_account_reload_time = '<meta http-equiv=Refresh content="' . $timeout . '; URL=/login/inbox/?">' . "\n";
	}	
	
	if( $this->mail_option_list['recvchecksnd'] == 1 ) {
				
			$this->mail_account_reload_snd = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="https://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,29,0" width="1" height="1">
							 <param name="movie" value="/img/sounds/newmail.swf">
							 <param name="quality" value="high">
							 <param name=menu value=false>
					       		 <embed src="/img/sounds/newmail.swf" quality="high" pluginspage="https://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="1" height="1"></embed>
							 </object>';
	}
		
	return TRUE;
}

function MailAccountPrimaryIs($mid) {
		
	if( $this->DBQuery("SELECT id FROM mailaccount WHERE id=" . $mid . " AND rdonly='1'") ) {
			
		if( mysql_num_rows($this->db['result']) == 1 ) {
				
			return TRUE;
		}
	}
}			
function MailAccountRelease($mid) {
	
	if( $this->MailAccountIs($mid) ) {
		
		if( !$this->MailAccountPrimaryIs($mid) ) {
						
			if( $this->DBQuery("DELETE FROM mailaccount WHERE id=" . $mid) ) {
			
				if( mysql_affected_rows($this->db['link']) > 0 ) {
				
					$this->MailCacheFunctionFlush('mailaccountlist');						
					$this->error['result'] = $this->errorcode['29'];
					return TRUE;
				}
			}
		} else {
				
			$this->error['result'] = $this->errorcode['28'];				
		}
	}
}

function MailAccountNameList($mid) {
	
	$this->mail_account_name_list = array();
	
	if( $this->DBQuery("SELECT nick,name,email,reply,host,port,login,passwd,color,folder,auto,rmcycle FROM mailaccount WHERE id=" . $mid . " AND mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_account_name_list = $row;
				return TRUE;
			}
		}
	}
}

function MailAccountRegister($accountarr) {
	
	$queryarr	= array();
	
	if( $accountarr['saveto'] == 'new' ) {
		
		if( $this->MailFolderRegister($accountarr['newfolder']) ) {
	
			$queryarr['folder'] = $accountarr['newfolder'];
		
		} else {
		
			$queryarr['folder'] = 'Inbox';
		}
	
	} elseif( $accountarr['saveto'] == 'existant' ) {
		
		if( $this->MailFolderIsByName($accountarr['existantfolder']) ) {
	
			$queryarr['folder'] = $accountarr['existantfolder'];
		
		} else { 
			
			$queryarr['folder'] = 'Inbox';
		}
	}

	if( $accountarr['auto'] != 1 ) {
		
		$accountarr['auto'] = 0;
	}
		
	if( $accountarr['rdonly'] != 1 ) {
		
		$accountarr['rdonly'] = 0;
	}
	
	$queryarr['mbox']	= $this->lp['login'];
	$queryarr['nick']	= $accountarr['nick'];
	$queryarr['name']	= ucwords(strtolower($accountarr['name']));
	$queryarr['email']	= strtolower($accountarr['email']);
	$queryarr['reply']	= strtolower($accountarr['reply']);
	$queryarr['host']	= strtolower($accountarr['host']);	
	$queryarr['port']	= $accountarr['port'];
	$queryarr['login']	= $accountarr['login'];
	$queryarr['passwd']	= $accountarr['passwd'];
	$queryarr['color']	= $accountarr['color'];
	$queryarr['folder']	= $queryarr['folder'];
	$queryarr['auto']	= $accountarr['auto'];
	$queryarr['rmcycle']	= $accountarr['rmcycle'];
	$queryarr['rdonly']	= $accountarr['rdonly'];
	$queryarr['dflt']	= '0';
	
	if( $this->DBInsert('mailaccount',$queryarr) ) {
		
		$this->MailCacheFunctionFlush('mailaccountlist');
		$_SESSION['result'] = str_replace('$nick',$accountarr['nick'],$this->errorcode['35']);
		
		if( $accountarr['rdonly'] == 0 ) {
			
			header('Location: https://' . $this->server['main'] . '/login/othermail');
			exit();
		}
	}
}

function MailBookRegister($type, $contactarr) {
	
	foreach($contactarr as $name => $value) {
			
		$contactarr[$name]	= addslashes(trim($value));  
	}
	
	if( isset($contactarr['pfname']) && !$this->MailFormatEmail($contactarr['pfname']) ) {
		
		$contactarr['pfname']	= ucwords(strtolower($contactarr['pfname']));
	}
	
	if( isset($contactarr['pfname']) && $this->MailFormatEmail($contactarr['pfname']) ) {
		
		$contactarr['pfname']	= strtolower($contactarr['pfname']);
	}
		
	if( isset($contactarr['pmname']) ) {
		
		$contactarr['pmname']	= ucwords(strtolower($contactarr['pmname']));
	}
	
	if( isset($contactarr['plname']) ) {
		
		$contactarr['plname']	= ucwords(strtolower($contactarr['plname']));
	}
	
	if( isset($contactarr['pemail']) ) {
		
		$contactarr['pemail']	= strtolower($contactarr['pemail']);
	}
	
	if( isset($contactarr['bemail']) ) {
		
		$contactarr['bemail']	= strtolower($contactarr['bemail']);
	}
	
	if( isset($contactarr['pmsn']) ) {
		
		$contactarr['pmsn']	= strtolower($contactarr['pmsn']);
	}
	
	if( isset($contactarr['pcity']) ) {
		
		$contactarr['pcity']	= ucwords(strtolower($contactarr['pcity']));
	}
	
	if( isset($contactarr['bcity']) ) {
		
		$contactarr['bcity']	= ucwords(strtolower($contactarr['bcity']));
	}
	
	if( isset($contactarr['ptel']) ) {
					
		$contactarr['ptel']	= $this->FixFormatPhone($contactarr['ptel']);
	}
	
	if( isset($contactarr['pftel']) ) {
					
		$contactarr['pftel']	= $this->FixFormatPhone($contactarr['pftel']);
	}
	
	if( isset($contactarr['pptel']) ) {
					
		$contactarr['pptel']	= $this->FixFormatPhone($contactarr['pptel']);
	}
	
	if( isset($contactarr['pctel']) ) {
					
		$contactarr['pctel']	= $this->FixFormatPhone($contactarr['pctel']);
	}
	
	if( isset($contactarr['btel']) ) {
					
		$contactarr['btel']	= $this->FixFormatPhone($contactarr['btel']);
	}
	
	if( isset($contactarr['bftel']) ) {
					
		$contactarr['bftel'] 	= $this->FixFormatPhone($contactarr['bftel']);
	}
	
	if( isset($contactarr['purl']) ) {
		
		$contactarr['purl']	= str_replace('http://','',$contactarr['purl']);
	}
	
	if( isset($contactarr['burl']) ) {
		
		$contactarr['burl']	= str_replace('http://','',$contactarr['burl']);
	}
	
	if( $this->MailBookGroupEveryoneGet() ) {
		
		switch($type) {
		
		case 'personal':
				
				if( !$this->MailBookContactIsByEmail('pemail',$contactarr['pemail']) ) {
						
					$contactarr['pbdalert'] = ($contactarr['pbdalert'] != 1) ? 0 : 1;
					$contactarr['picq'] 	= (!is_numeric($contactarr['picq'])) ? 0 : $contactarr['picq'];	
										
					if( $this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount)+1 WHERE mgid=" . $this->mail_book_group_everyone . " AND mbox='" . $this->lp['login'] . "'") ) {
						
						if( $this->DBQuery("INSERT into mailbook (cid,mbox,mgroup,mreply,mxprs,pfname,pmname,plname,pbdate,pbdalert,paddress,pcity,pstate,pzip,pemail,ptel,pftel,pptel,pctel,purl,picq,paim,pmsn) VALUES('','" . $this->lp['login'] . "'," . $this->mail_book_group_everyone . ",'0','0','" . $contactarr['pfname'] . "','" . $contactarr['pmname'] . "','" . $contactarr['plname'] . "','" . $contactarr['pbdate'] . "','" . $contactarr['pbdalert'] . "','" .
			    				$contactarr['paddress'] . "','" . $contactarr['pcity'] . "','" . $contactarr['pstate'] . "','" . $contactarr['pzip'] . "','" . $contactarr['pemail'] . "','" . $contactarr['ptel'] . "','" . $contactarr['pftel'] . "','" . $contactarr['pptel'] . "','" . $contactarr['pctel'] . "','" . $contactarr['purl'] . "'," . $contactarr['picq'] . ",'" . $contactarr['paim'] . "','" . $contactarr['pmsn'] . "')") ) {
							
							$this->MailCacheFunctionFlush('mailbookminilist');
							$this->MailCacheFunctionFlush('mailfilterprivatelist');		   					   				
			   				$this->MailCacheFunctionFlush('mailbookgroupview');
			   				$this->MailCacheFunctionFlush('mailbookexpresslist');
			   				return TRUE;
						}
					}
				}
			break;
					
		case 'business':
		
				if( !$this->MailBookContactIsByEmail('bemail',$contactarr['bemail']) ) {
					
					if( $this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount)+1 WHERE mgid=" . $this->mail_book_group_everyone . " AND mbox='" . $this->lp['login'] . "'") ) {
						
						if( $this->DBQuery("INSERT into mailbook (cid,mbox,mgroup,mreply,mxprs,bcompany,bposition,baddress,bcity,bstate,bzip,bcountry,btel,btelext,bftel,burl,bemail) VALUES('','" .
			    				$this->lp['login'] . "'," . $this->mail_book_group_everyone . ",'0','0','" . $contactarr['bcompany'] . "','" . $contactarr['bposition'] . "','" . $contactarr['baddress'] . "','" . $contactarr['bcity'] . "','" .
			    				$contactarr['bstate'] . "','" . $contactarr['bzip'] . "','" . $contactarr['bcountry'] . "','" . $contactarr['btel'] . "','" . $contactarr['btelext'] . "','" .
			    				$contactarr['bftel'] . "','" . $contactarr['burl'] . "','" . $contactarr['bemail'] . "')") ) {
			    				
			    					$this->MailCacheFunctionFlush('mailbookminilist');
			    					$this->MailCacheFunctionFlush('mailfilterprivatelist');					
			   					$this->MailCacheFunctionFlush('mailbookgroupview');
			   					$this->MailCacheFunctionFlush('mailbookexpresslist');
			   					return TRUE;
						}
			 		}
			 	}
			 break;
		}
	}
}

function MailBookFormat($contactarr) {
	
	if( is_array($this->mail_book_img_error) ) {
		
		unset($this->mail_book_img_error);
	}	
	
	if( is_array($contactarr) ) {
			
		foreach($contactarr as $name => $value) {
		
			if( $name == 'pfname' ) {
													
				if( !$this->MailFormatEmail($value) && !preg_match("/^([a-z\-\.\s\']{1,20})$/i",$value) ) {
				
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'plname' && !empty($value) ) {
														
				if( !preg_match("/^([a-z\-\.\s\']{1,20})$/i",$value) ) {
				
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
		
			if( $name == 'pemail' ) {
													
				list($user,$domain) = explode('@',$value);
			
				if( !checkdnsrr($domain,'MX') || !$this->MailFormatEmail($value) ) {
				
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'paim' && !empty($value) ) {
				
				if( strlen($value) < 3 || strlen($value) > 16 ) {
					
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			
			if($name == 'picq' && !empty($value) )  {
				
				if( !is_numeric($value) ) {
					
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'pmsn' && !empty($value) ) {
				
				if( !$this->MailFormatEmail($value) ) {
				
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'bcompany' ) {
				
				if( !preg_match("/^([a-z0-9\&\#\-\.\s\'\,]{2,60})$/i",$value) ) {
					
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			
			if( $name == 'bemail' ) {
			
				list($user,$domain) = explode('@',$value);
			
				if( !checkdnsrr($domain,'MX') || !$this->MailFormatEmail($value) ) {
				
					$this->mail_book_img_error[$name] = TRUE;
				}
			}
			    						
			if( strlen($value) > 128 ) {
			
				$this->mail_book_img_error[$name] = TRUE;
			}	
		}
	}
	
	if( !is_array($this->mail_book_img_error) ) {
		
		return TRUE;

	} else {
		
		$this->error['result'] = $this->errorcode['32'];
	}		
}
	
function MailBookUpdate($cid, $contactarr) {
	
	if( isset($contactarr['pfname']) && !$this->MailFormatEmail($contactarr['pfname']) ) {
		
		$contactarr['pfname']	= ucwords(strtolower($contactarr['pfname']));
	}
	
	if( isset($contactarr['pfname']) && $this->MailFormatEmail($contactarr['pfname']) ) {
		
		$contactarr['pfname']	= strtolower($contactarr['pfname']);
	}
		
	if( isset($contactarr['pmname']) ) {
		
		$contactarr['pmname']	= ucwords(strtolower($contactarr['pmname']));
	}
	
	if( isset($contactarr['plname']) ) {
		
		$contactarr['plname']	= ucwords(strtolower($contactarr['plname']));
	}
	
	if( isset($contactarr['pemail']) ) {
		
		$contactarr['pemail']	= strtolower($contactarr['pemail']);
	}
	
	if( isset($contactarr['bemail']) ) {
		
		$contactarr['bemail']	= strtolower($contactarr['bemail']);
	}
	
	if( isset($contactarr['pmsn']) ) {
		
		$contactarr['pmsn']	= strtolower($contactarr['pmsn']);
	}
	
	if( isset($contactarr['pcity']) ) {
		
		$contactarr['pcity']	= ucwords(strtolower($contactarr['pcity']));
	}
	
	if( isset($contactarr['bcity']) ) {
		
		$contactarr['bcity']	= ucwords(strtolower($contactarr['bcity']));
	}
	
	if( isset($contactarr['ptel']) ) {
					
		$contactarr['ptel']	= $this->FixFormatPhone($contactarr['ptel']);
	}
	
	if( isset($contactarr['pftel']) ) {
					
		$contactarr['pftel']	= $this->FixFormatPhone($contactarr['pftel']);
	}
	
	if( isset($contactarr['pptel']) ) {
					
		$contactarr['pptel']	= $this->FixFormatPhone($contactarr['pptel']);
	}
	
	if( isset($contactarr['pctel']) ) {
					
		$contactarr['pctel']	= $this->FixFormatPhone($contactarr['pctel']);
	}
	
	if( isset($contactarr['btel']) ) {
					
		$contactarr['btel']	= $this->FixFormatPhone($contactarr['btel']);
	}
	
	if( isset($contactarr['bftel']) ) {
					
		$contactarr['bftel'] 	= $this->FixFormatPhone($contactarr['bftel']);
	}
	
	if( isset($contactarr['purl']) ) {
		
		$contactarr['purl']	= str_replace('http://','',$contactarr['purl']);
	}
	
	if( isset($contactarr['burl']) ) {
		
		$contactarr['burl']	= str_replace('http://','',$contactarr['burl']);
	}
	
	$contactarr['pbdalert'] 	= ($contactarr['pbdalert'] != 1) ? 0 : 1;	 
	unset($contactarr['pbdmonth']);
	unset($contactarr['pbdyear']);
	unset($contactarr['pbdday']);
 
	$query = "UPDATE mailbook SET ";
	
	foreach($contactarr as $name => $value) {
					
		$query .= $name . '=\'' . addslashes(trim($value)) . '\', ';
	}
	
	$query  = substr($query,0,-2);
	$query .= ' WHERE cid=' . $cid . ' AND  mbox=\'' . $this->lp['login'] . '\'';
	
	if( $this->DBQuery($query) ) {
		
		$this->MailCacheFunctionFlush('mailfilterprivatelist');	
		$this->MailCacheFunctionFlush('mailbookminilist');		
		return TRUE;
	}
}

function MailBookSort($sortarr) {
	
	if( is_array($sortarr) && sizeof($sortarr) > 0 ) {
		
		foreach($sortarr as $sortby => $id) {
			
			$this->addrbook['sort'] = $sortby;
		}
	} 
}
function MailBookQuickRegister($contactarr) {
	
	if( !empty($contactarr['psn']) ) {
		
		$contactarr[$contactarr['psnmsg']] = $contactarr['psn'];
	}
	
	if( $this->MailBookFormat($contactarr) ) {
		
		if( $this->MailBookRegister('personal',$contactarr) ) {
			
			$this->error['result'] = $this->errorcode['80'];
			return TRUE;
		}
	} 
}

function MailBookContactIsByEmail($type,$email) {
	
	if( $this->DBQuery("SELECT cid FROM mailbook WHERE mbox='" . $this->lp['login'] . "' AND " . $type . "='" . $email . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1) {
			
			$this->error['result'] = str_replace('$email',$email,$this->errorcode['93']);
			return TRUE;
		}
	}
}

function MailScheduleBookContactBdayAlert() {

	if( $this->DBQuery("SELECT mbox,pfname,pmname,plname,pbdate,bcompany,pemail,bemail FROM mailbook WHERE pbdalert=1") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				list($year,$month,$day) = explode('-',$row['pbdate']);
				
				if( $month == date('m') && $day == date('d') ) {
							
					if( !empty($row['pfname']) )  {
					
						$name = $row['pfname'] . ' ' . $row['pmname'] . ' ' . $row['plname'];
				
					} elseif( !empty($row['bcompany']) ) {
								 
						$name = $row['bcompany'];
					}
				
					$recipient 	= (!empty($row['pemail'])) ? $row['pemail'] : $row['bemail'];
					$sender		= $row['mbox'];
					include($this->tpl['php'] . '/book_bday_alert_email_msg.tpl');
					include($this->tpl['php'] . '/book_bday_alert_email_subject.tpl');
					mail($recipient,$this->MailRandomArrayString($templatesubject),$template,'From: ' . $sender. "\r\nContent-type: text/html; charset=iso-8859-1\r\nReturn-path: <" . $sender . ">\r\n");
				}
			}
		}
	}
}
function MailBookContactList($cid) {
	
	$this->mail_book_contact_list	= array();
	
	if( $this->MailBookContactIs($cid) ) {
		
		if( $this->DBQuery("SELECT * FROM mailbook WHERE cid=" . $cid) ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					foreach($row as $name => $value) {
					
						if( !empty($value) ) {
						
							$this->mail_book_contact_list[$name] = $value;
						}
					}
				}
			}
		}
	}
}

function MailBookPrint($type, $group, $printpersonal, $printbusiness, $printnotes) {
	
	$templateline 	= '';
	$cnt 		= 0;
	$type 		= ($type != 1) ? 0 : 1;
	$printpersonal 	= ($printpersonal != 1) ? 0 : 1;
	$printbusiness 	= ($printbusiness != 1) ? 0 : 1;
	$printnotes 	= ($printnotes != 1) ? 0 : 1;
	
	if( $type == 1 ) {
		
		if( !$this->MailBookGroupEveryoneIs($group) && !$this->MailBookGroupIs($group) ) {
		
			$this->error['result'] = str_replace('$group',$group,$this->errorcode['100']);
			return FALSE;
		}
	
		if( $this->MailBookGroupEveryoneIs($group) ) {
		
			$groupall = TRUE;
		}
	}
	
	if( $this->DBQuery("SELECT * FROM mailbook WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				if( $type == 1 ) {
						
					if( !isset($groupall) && $row['mgroup'] != $group ) {		
					
						continue;
					}
				}
				
				if( !empty($row['pfname']) && $printpersonal == 0 )  {
						
					continue;
				
				} elseif( empty($row['pfname']) && !empty($row['bcompany']) && $printbusiness == 0 ) {
					
					continue;	
				} 
				
				$cnt++;
						
				$contactarr = array();
					
				if( !empty($row['pfname']) ) {
					
					$contactarr['name'] = $row['pfname'] . ' ' . $row['pmname'] .  ' ' . $row['plname'];
				
				} elseif( !empty($row['bcompany']) ) {
					
					$contactarr['name'] = $row['bcompany'];
				}
						
				$contactarr['name'] .= (!empty($row['bposition'])) ? ' - ' . $row['bposition'] : NULL;
				
				if( !empty($row['notes']) && $printnotes == 1 ) {
					
					$contactarr['notes'] = '<table width="600" height="36" border="0" align="center" cellpadding="0" cellspacing="0">
  					<tr><td align="left" valign="top" class="akalink"><strong><font color="#000000">Notes:</font></strong> ' . 
      					htmlspecialchars(nl2br($row['notes'])) . '</td></tr></table>';
				}
						
				if( !empty($row['pfname']) ) {
					
					$contactarr['pheader'] 		= '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td width="293" class="akalink"><font color="#000000"><strong>Personal Contact Information:</strong></font></td></tr></table>';
				
					if( !empty($row['paddress']) ) {
						
						$contactarr['pcity'] 	= (!empty($row['pcity'])) ? ', ' . $row['pcity'] : NULL;
						$contactarr['pstate'] 	= (!empty($row['pstate']) && $row['pstate'] != 'UN') ? ', ' . $row['pstate'] : NULL;
						$contactarr['pzip'] 	= (!empty($row['pzip'])) ? ', ' . $row['pzip'] : NULL;
						
						$contactarr['paddress'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td height="18" colspan="2" valign="bottom" class="akalink">' . $row['paddress'] . $contactarr['pcity'] . $contactarr['pstate'] . $contactarr['pzip'] . '</td></tr></table>';
            				}
					
					if( !empty($row['pcountry']) && $row['pcountry'] != 'UN' ) {
						
						$country = $this->MailContactCountryPrint($row['pcountry']);
						
						if( !empty($country) ) {
						
							$contactarr['country'] 		= $country;
							$contactarr['pcountry'] 	= '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td colspan="2" class="akalink">' . $contactarr['country'] . '</td></tr><tr><td colspan="2" class="akalink">&nbsp;</td></tr></table>';
						}
                                	}
                                	
                                	if( !empty($row['ptel']) ) {
                                	
                               			$contactarr['ptel'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td width="64" class="akalink">Phone: </td>
                					<td width="230" class="akalink">' . $row['ptel'] . '</td></tr></table>';
                			}
    					
    					if( !empty($row['pftel']) ) {
              					
              					 $contactarr['pftel'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td width="64" class="akalink">Fax: </td>
                					   <td width="230" class="akalink">' . $row['pftel'] . '</td></tr></table>';
              				}
              			
                			if( !empty($row['pctel']) ) {
                				    
            					$contactarr['pctel'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td width="64" class="akalink">Cellular: </td>
                					   <td width="230" class="akalink">' . $row['pctel'] . '</td></tr></table>';
              				}
              				
              				if( !empty($row['pptel']) ) {
              					
              					$contactarr['pptel'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td width="64" class="akalink">Pager: </td>
                					 <td width="230" class="akalink">' . $row['pptel'] . '</td></tr></table>';	            				
            				}
            				
            				if( !empty($row['pemail']) ) {
            					
                				$contactarr['pemail'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td><td width="64" class="akalink">E-mail: </td>
                					  <td width="229" class="akalink">' . $row['pemail'] . '</td></tr></table>';
             				} 
            			}
            			
            			if( !empty($row['bcompany']) ) {
            				
            				$contactarr['bheader'] 	= '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td width="293" class="akalink"><font color="#000000"><strong>Business Contact Information: </strong></font></td></tr></table>';
            				$contactarr['bcompany'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr><td height="18" colspan="2" valign="bottom" class="akalink">' . $row['bcompany'] . '</td></tr></table>';
					
					if( !empty($row['baddress']) ) {
						
						$contactarr['bcity'] 	= (!empty($row['bcity'])) ? ', ' . $row['bcity'] : NULL;
						$contactarr['bstate'] 	= (!empty($row['bstate']) && $row['bstate'] != 'UN') ? ', ' . $row['bstate'] : NULL;
						$contactarr['bzip'] 	= (!empty($row['bzip'])) ? ', ' . $row['bzip'] : NULL;
						
						$contactarr['baddress'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr>
                	     				    <td height="9" colspan="2" valign="bottom" class="akalink">' . $row['baddress'] . $contactarr['bcity'] . $contactarr['bstate'] . $contactarr['bzip'] . '</td></tr></table>';			    
            				}
            				
            				if( !empty($row['bcountry']) && $row['bcountry'] != 'UN' ) {
            					
            					$country = $this->MailContactCountryPrint($row['bcountry']);
            					
            					if( !empty($country) ) {
            							
            						$contactarr['country'] 	= $country;
            						$contactarr['bcountry'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr>
                			          	    <td colspan="2" class="akalink">' . $contactarr['country'] . '</td></tr>
              				            	    <tr><td colspan="2" class="akalink">&nbsp;</td></tr></table>';
            					}
					}
					
           				if( !empty($row['btel']) ) {
           					        	
                                		 $contactarr['btel'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr>
                				 	 <td width="64" class="akalink">Phone: </td>
                			         	 <td class="akalink">' . $row['btel'] . '</td></tr>
            						 </table>';
                                	}
                                	
                                	if( !empty($row['bftel']) ) {
                                		
                                		 $contactarr['bftel'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr>
                				 	 <td width="64" class="akalink">Fax: </td>
                			         	 <td class="akalink">' . $row['bftel'] . '</td></tr>
            						 </table>';
                                	}
                                	
                                	if( !empty($row['bemail']) ) {
                                		
                                		$contactarr['bemail'] = '<table width="293" border="0" cellpadding="0" cellspacing="0"><tr>
                					  <td width="64" class="akalink">E-mail</td>
                					  <td width="229" class="akalink">' . $row['bemail'] . '</td>
              						  </tr></table>';
            				}
           			}
            			
            			include($this->tpl['php'] . '/book_print.tpl');
				$templateline .= $template;
				unset($contactarr);
			}
			
			$this->mail_book_print_list = $templateline;
		} else {
			
			$this->error['result'] = $this->errorcode['101'];
			return FALSE;
		}
		
		if( $cnt == 0 ) {
			
			$this->error['result'] = $this->errorcode['102'];
			return FALSE;
		}
		
		return TRUE;
	}
}

function MailBookSend($cid, $gid) {
	
	$cnt = 0;
	
	if( is_array($gid) && sizeof($gid) > 0 ) {
		
		foreach($gid as $type => $typearr) {
		
			foreach($typearr as $gid => $gidid) {
					
				if( $this->MailBookGroupIs($gid) || $this->MailBookGroupEveryoneIs($gid) ) {
						
					if( $this->DBQuery("SELECT pemail,bemail FROM mailbook WHERE mgroup=" . $gid) ) {
					
						if( mysql_num_rows($this->db['result']) > 0 ) {
						
							while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
															
								if( !empty($row['pemail']) ) {
															
									$$type .= $row['pemail'] . '; ';
								
								} elseif( !empty($row['bemail']) ) {
										
									$$type .= $row['bemail'] . '; ';
								}
							}
						}
					}
				}
			}
		}
	} else {
		
		$cnt++;
	}
		
	if( is_array($cid) && sizeof($cid) > 0 ) {
		
		foreach($cid as $type => $typearr) {
		
			foreach($typearr as $cid => $cidid) {
			
				if( $this->MailBookContactIs($cid) ) {
				
					if( $this->DBQuery("SELECT pemail,bemail FROM mailbook WHERE cid=" . $cid) ) {
					
						if( mysql_num_rows($this->db['result']) == 1 ) {
						
							if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
							
								if( !empty($row['pemail']) ) {
									
									if( !strstr($$type,$row['pemail']) ) {
										
										$$type .= $row['pemail'] . '; ';
									}
									
								} elseif( !empty($row['bemail']) )  {
								
									if( !strstr($$type,$row['pemail']) ) {
										
										$$type .= $row['bemail'] . '; ';
									}
								}
							}
						}
					}
				}
			}
		}
	} else {
		
		$cnt++;
	}
	
	if( $cnt == 2 ) {
		
		$this->error['result'] = $this->errorcode['79'];
		
	} else {
		
		$to	= (isset($to))  ? urlencode(substr($to,0,-2))   : NULL;
		$cc	= (isset($cc))  ? urlencode(substr($cc,0,-2))   : NULL;
		$bcc	= (isset($bcc)) ? urlencode(substr($bcc,0,-2))  : NULL;		
		header('Location: http://' . $this->server['main'] . '/login/compose/?to=' . $to . '&cc=' . $cc . '&bcc=' . $bcc);
		exit();
	}
}	 
	
function MailBookList($letter, $group, $pagejump, $keyword) { 
	
	$bookarr	= array();
	$bookselarr 	= array();
	$letterarr 	= array();
	$bgcolor 	= '#EEEEEE';
	$pagelist 	= '';
	$pagecnt 	= 0;
	$bookselcnt 	= 0;
	$cnt 		= 0;
	
	if( $this->MailPostIs('searchnow') ) {
			
		if( !empty($keyword) && (strlen($keyword) < 1 || strlen($keyword) > 20) ) {
		
			$this->error['result'] = $this->errorcode['90'];
			unset($keyword);
			$letter = 'ALL';
		}
	}
	
	if( $this->DBQuery("SELECT mgid,mgroup,mcount FROM mailbookgroup WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$mgid 		= $row['mgid'];
				$mgroup 	= $row['mgroup'];
				$mcount 	= $row['mcount'];
				$mgroupletter 	= strtoupper($mgroup[0]);
				
				if( !isset($letterarr[$mgroupletter]) ) {
					
					$letterarr[$mgroupletter] = '<a href="/login/addressbook/index.aka?browse=' . $mgroupletter . 
								    '" onMouseOver="window.status=\'Sort by letter (' . $mgroupletter . 
								    ')\'; return true;" onMouseOut="window.status=\'\'; return true;">' . 
								    $mgroupletter . '</a>';
				}
				
				if( empty($keyword) ) {
										
					if( isset($group) && $mgid != $group) {
					
						continue;
					
					} elseif( isset($letter) && $letter != 'ALL' && $letter != 'GROUP' && $mgroupletter != $letter ) {
					
						continue;			
					}	 
				
				} elseif( !stristr($mgroup,$keyword) ) {
					
					continue;
				}
				
				$cnt++;				
				($bgcolor == '#EEEEEE') ? $bgcolor = '#FFFFFF' : $bgcolor = '#EEEEEE';
				include($this->tpl['php'] . '/book_group_list.tpl');
				$bookarr[] = $template;
			}
		}
	}
							
	if( $this->DBQuery("SELECT cid,mgroup,pfname,pmname,plname,pemail,bcompany,bemail,picq,paim,pmsn FROM mailbook WHERE mbox='" . $this->lp['login'] . "' ORDER BY " . $this->addrbook['sort']) ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
											
				if( !empty($row['pfname']) )  {
					
					$name 	 = $row['pfname'] . ' ' . $row['pmname'] . ' ' . $row['plname'];
					$email	 = (!empty($row['pemail'])) ? $row['pemail'] : '(none)';
					
				} elseif( !empty($row['bcompany']) ) {
								 
					$name 	= $row['bcompany'];
					$email 	= (!empty($row['bemail'])) ? $row['bemail'] : '(none)';
				}
					
				$cid 		= $row['cid'];
				$aim 		= (!empty($row['paim'])) ? '<a href="aim:goim?screenname=' . urlencode($row['paim']) . '" onMouseOver="window.status=\'Send an Instant Message to this person\'; return true;" onMouseOut="window.status=\'\'; return true;">' . $row['paim'] . '</a>' : '(none)';
				$icq 		= (!empty($row['picq'])) ? '<a href="http://web.icq.com/wwp?Uin=' . $row['picq'] . '" target="_blank" onMouseOver="window.status=\'Send an ICQ Message to this person\'; return true;" onMouseOut="window.status=\'\'; return true;">' . $row['picq'] . '</a>' : '(none)';
				$msn 		= (!empty($row['pmsn'])) ? '<a href="/login/compose?to=' . urlencode($row['pmsn']) . '" onMouseOver="window.status=\'Send a MSN E-mail to this person\'; return true;" onMouseOut="window.status=\'\'; return true;">' . $row['pmsn'] . '</a>' : '(none)';
				$emailref 	= urlencode($email);
				$nameletter 	= strtoupper($name[0]);
				
				if( !isset($letterarr[$nameletter]) ) {
					
					$letterarr[$nameletter] = '<a href="/login/addressbook/index.aka?browse=' . $nameletter . 
								  '" onMouseOver="window.status=\'Sort by letter (' . $nameletter . 
								  ')\'; return true;" onMouseOut="window.status=\'\'; return true;">' . 
								  $nameletter . '</a>';
				}		
				
				if( empty($keyword) ) {
				
					if( isset($group) && $row['mgroup'] != $group ) {
						
						continue;
					
					} elseif( isset($letter) && $letter == 'GROUP' ) {
					
						continue;
					
					} elseif( isset($letter) && $letter != 'ALL' && $letter != 'GROUP' && $nameletter != $letter ) {
					
						continue;
					}
			
				} elseif( !stristr($name,$keyword) ) {
					
					continue;
				}
			
				$cnt++;
				($bgcolor == '#EEEEEE') ? $bgcolor = '#FFFFFF' : $bgcolor = '#EEEEEE';
				include($this->tpl['php'] . '/book_list.tpl');
				$bookarr[] = $template;
			}
		}
	}
	
	if( $this->MailPostIs('searchnow') ) {
				
		if( !empty($keyword) ) {
		
			$letter = '';
		}
	}
	
	for($i='A'; $i<='Z'; $i++) {
			
		if( !isset($letterarr[$i]) ) {
					
			$letterarr[$i] 		= $i;	
		
		} elseif( $letter == $i ) {
				
			$letterarr[$letter] 	= '<b><font size="3">' . $letter . '</font></b>'; 			
		}
	}
	
	if( (!isset($letter) && !isset($group)) || $letter == 'ALL'  ) {
		
		$letterarr['ALL'] = '<b>View All</b>';
	
	} else {
		
		$letterarr['ALL'] = '<a href="/login/addressbook/index.aka?browse=ALL">View All</a>';
	}	
	
	if( $letter == 'GROUP' ) {
		
		$letterarr['GROUP'] = '<b>View Groups</b>';
	
	} else {
		
		$letterarr['GROUP'] = '<a href="/login/addressbook/index.aka?browse=GROUP">View Groups</a>';
	}
		
	include($this->tpl['php'] . '/book_letter.tpl');
	$this->mail_book_sort_list = $template;
	
	if( $cnt > 0 ) {
		
		for($i=0; $i<$cnt; $i+=$this->mail_option_list['bookpage']) {
			
			$pagecnt++;
			
			if( $pagejump == $i ) {
							
				$pagelist .= '<option selected value="' . $i . '">Page ' . $pagecnt . '</option>' . "\n";
			
			}  else {
				
				$pagelist .= '<option value="' . $i . '">Page ' . $pagecnt . '</option>' . "\n";
			}
		}
			
		foreach($bookarr as $id => $value) {
		
			if( $id >= $pagejump ) {
			
				$selectcnt++;
			
				if( $selectcnt <= $this->mail_option_list['bookpage'] ) {
				
					$bookselarr[] = $value;
				}
			}
		}
		
		if( $this->MailPostIs('searchnow') && !empty($keyword) ) {
			
			 $this->error['result'] = str_replace('$keyword',$keyword,str_replace('$bookcnt',sizeof($bookarr),$this->errorcode['91']));
		
		} else {
						
			$this->mail_book_page_spos	= ($pagejump == 0) ? 1 : $pagejump + 1;  
			$this->mail_book_page_epos	= ($pagejump + $this->mail_option_list['bookpage'] > $cnt) ? $cnt : $pagejump + $this->mail_option_list['bookpage'];
			$this->mail_book_page_list	= $pagelist;
			$this->mail_book_page_cnt	= $cnt;
		}
		
		$this->mail_book_search_list = implode('',$bookselarr);
	} else {
			
		if( $this->MailPostIs('searchnow') && !empty($keyword) ) {
			
		  	$_SESSION['result'] = str_replace('$keyword',$keyword,$this->errorcode['92']);
	        } else {
	        	
	        	$_SESSION['result'] = $this->error['result'];
	        }
	   
	       header('Location: http://' . $this->server['main'] . '/login/addressbook');
	       exit();
	}
}

function MailBookGroupIs($gid) {
	
	if( is_numeric($gid) ) {
		
		if( $this->DBQuery("SELECT mgid FROM mailbookgroup WHERE mgid=" . $gid . " AND mbox='" . $this->lp['login'] . "' AND mrdonly='0'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				return TRUE;
			}
		}
	}	
}

function MailBookGroupIsByName($group) {
			
	if( $this->DBQuery("SELECT mgroup FROM mailbookgroup WHERE mbox='" . $this->lp['login'] . "' AND mgroup='" . $group . "'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
				
			$this->error['result'] = str_replace('$group',$group,$this->errorcode['86']);
			return TRUE;
		}
	}	
}

function MailFormatSignature($sname) {
			
	if( preg_match('/^([a-z0-9\-\.\&\#\_\s\']{1,' . $this->limit['signlen'] . '})$/i',$sname) ) {
		
		return TRUE;	
	
	} else {
		
		$this->error['result'] = $this->errorcode['44'];
	}	
}

function MailFormatPasswd($passwd) {
	
	if( strlen($passwd) > 0 && strlen($passwd) <= $this->limit['max_passwd'] ) {
		
		return TRUE;	
	}	
}

function MailFormatHost($host) {
	        
	$result		= FALSE;
	$hostregex      = '/^([a-z0-9\-\.])+\.([a-z0-9\-]{1,63}\.([a-z]{2,3}\.)?[a-z]{2,4})$/i';

	(preg_match($hostregex, $host)) ? $result = TRUE : $result = FALSE;
	($host[0] == '-' || $host[strlen($host)-1] == '-' || strstr($host,'--')) ? $result = FALSE : NULL;
        ($host[0] == '.' || $host[strlen($host)-1] == '.' || strstr($host,'..')) ? $result = FALSE : NULL;
        (strstr($host, '.-') || strstr($host, '-.')) ? $result = FALSE : NULL;
        (strlen($host) < 4 || strlen($host) > 128) ? $result = FALSE : NULL;

        return $result;
}

function MailFormatBookGroup($group) {
			
	if( preg_match('/^([a-z0-9]{1,' . $this->limit['bookgrouplen'] . '})$/i',$group) ) {
		
		return TRUE;	
	
	} else {
		
		$this->error['result'] = $this->errorcode['85'];
	}	
}

function MailFormatDomain($domain) {
	
	$result		= FALSE;
	$domainregex	= '/^([a-z0-9\-]{1,63})\.([a-z]{2,3}\.)?([a-z]{2,4})$/i';
	
	(preg_match($domainregex, $domain)) ? $result = TRUE : NULL;
	($domain[0] == '-' || $domain[strlen($domain)-1] == '-' || strstr($domain, '--')) ? $result = FALSE : NULL;
        ($domain[0] == '.' || $domain[strlen($domain)-1] == '.' || strstr($domain, '..')) ? $result = FALSE : NULL;
        (strlen($domain) < 4 || strlen($domain) > 61) ? $result = FALSE : NULL;
	
	return $result;
}

function MailBookGroupIdContactGet($cid) {
		
	if( $this->DBQuery("SELECT mgroup FROM mailbook WHERE cid=" . $cid) ) {
			
		if( mysql_num_rows($this->db['result']) == 1 ) {
				
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
					
				$this->mail_book_group_id = $row['mgroup'];
				return TRUE;
			}
		}
	}
}

function MailBookGroupEveryoneIs($gid) {
	
	if( $this->DBQuery("SELECT mgroup FROM mailbookgroup WHERE mgid=" . $gid . " AND mgroup='Everyone'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			return TRUE;
		}
	}
}

function MailBookGroupMove($cidarr, $gid) {
			
	$cnt = 0;
	
	if( is_array($cidarr) && sizeof($cidarr) > 0 ) {
	
		if( $this->MailBookGroupIs($gid) || $this->MailBookGroupEveryoneIs($gid) ) {
					
			foreach($cidarr as $type => $typearr) {
				
				foreach($typearr as $cid => $cidid) {
							
					foreach($typearr as $cid => $id) {
				
						if( $this->MailBookContactIs($cid) ) {
													
							if( $this->MailBookGroupIdContactGet($cid) ) {
						
								if( $gid != $this->mail_book_group_id ) {
							
									if( !$this->MailBookGroupEveryoneIs($this->mail_book_group_id) ) {
								
										$this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount)-1 WHERE mgid=" . $this->mail_book_group_id);				
									}
									
									if( !$this->MailBookGroupEveryoneIs($gid) ) {
										
										$this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount)+1 WHERE mgid=" . $gid);
									}
									
									$this->DBQuery("UPDATE mailbook SET mgroup=" . $gid . " WHERE cid=" . $cid);			 
									$cnt++;
								}		 
							}
						}
					}
				}
			}
			
			if( $cnt > 0 ) {
				
				$this->MailCacheFunctionFlush('mailbookgroupview');				
				$this->error['result'] = $this->errorcode['88'];
				return TRUE;
			}
		}
	} else {
		
		$this->error['result'] = $this->errorcode['89'];
	}		
}
		
function MailBookGroupEveryoneGet() {
	
	if( $this->DBQuery("SELECT mgid FROM mailbookgroup WHERE mbox='" . $this->lp['login'] . "' AND mgroup='Everyone'") ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_book_group_everyone = $row['mgid'];
				return TRUE;
			}
		}
	}
}
								
function MailBookGroupDelete($gidarr) {
	
	$cnt = 0;
		
	if( is_array($gidarr) && sizeof($gidarr) > 0 ) {
	
		if( $this->MailBookGroupEveryoneGet() ) {
					
			foreach($gidarr as $type => $typearr) {
			
				foreach($typearr as $gid => $gidid) {
				
					if( $this->MailBookGroupIs($gid) ) {
								
						if( $this->DBQuery("DELETE FROM mailbookgroup WHERE mgid=" . $gid) ) {
					
							$this->DBQuery("UPDATE mailbook SET mgroup=" . $this->mail_book_group_everyone . " WHERE mbox='" . $this->lp['login'] . "' AND mgroup=" . $gid);
							$cnt++;
						}
					}
				}
			}
		}
	
		if( $cnt > 0 ) {
						
			$this->MailCacheFunctionFlush('mailbookgroupview');	
			$this->error['result'] = $this->errorcode['83'];		
			return TRUE;
		}
	} else {
		
		$this->error['result'] = $this->errorcode['84'];
	}		
}

function MailBookGroupCount() {
	
	if( $this->DBQuery("SELECT mgid FROM mailbookgroup WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		$this->mail_book_group_cnt = mysql_num_rows($this->db['result']);
		return TRUE;
	}	
}
	
function MailBookGroupRegister($group, $rdonly = 0) {
	
	if( $this->MailBookGroupCount() ) {
		
		if( ($this->mail_book_group_cnt + 1) <= $this->limit['max_book_group'] ) {
			
			if( $this->MailFormatBookGroup($group) ) {
		
				if( !$this->MailBookGroupIsByName($group) ) {
			
					if( $this->DBQuery("INSERT into mailbookgroup VALUES('','" . $this->lp['login'] . "','" . $group . "',0,'" . $rdonly . "')") ) {
				
						$this->MailCacheFunctionFlush('mailbookgroupview');			
						$this->error['result'] = str_replace('$group',$group,$this->errorcode['87']);			
						return TRUE;
					}
				}
			}
		} else {
			
			$this->error['result'] = $this->errorcode['114'];
		}
	} 
}
		
function MailBookGroupView() {
	
	$templateline = '';
	
	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
		
		if( $this->DBQuery("SELECT mgid,mgroup,mcount FROM mailbookgroup WHERE mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
			
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				  	
					$templateline .= '<option value="' . $row['mgid'] . '">' . $row['mgroup'] . ' (' . $row['mcount'] . ')</option>'; 		  		
				}
				
				$_SESSION['function'][__FUNCTION__]['data']	= $templateline;
				$_SESSION['function'][__FUNCTION__]['refresh'] 	= time() + $this->timeout['func_cache'];	
				$this->mail_book_group_view 			= $templateline;
			}
		}
	} else {
		
		$this->mail_book_group_view = $_SESSION['function'][__FUNCTION__]['data'];
	}	  					 
}

function MailBookContactDelete($cidarr) {
		
	$cnt = 0;
	
	if( is_array($cidarr) && sizeof($cidarr) > 0 ) {
			
		foreach($cidarr as $type => $typearr) {
			
			foreach($typearr as $cid => $cidid) {
				
				if( $this->MailBookContactIs($cid) ) {
				
					if( $this->MailBookGroupIdContactGet($cid) ) {
						
						if( $this->DBQuery("DELETE FROM mailbook WHERE cid=" . $cid) ) {
					
							if( $this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount)-1 WHERE mbox='" . $this->lp['login'] . "' AND mgroup='Everyone'") ) {
							
								if( !$this->MailBookGroupEveryoneIs($this->mail_book_group_id) ) {
								
									$this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount)-1 WHERE mgid=" . $this->mail_book_group_id . " AND mbox='" . $this->lp['login'] . "'");
								}
								$cnt++;
							}
						}
					}
				}
			}
		}
		
		if( $cnt > 0 ) {
			
			$this->MailCacheFunctionFlush('mailfilterprivatelist');
			$this->MailCacheFunctionFlush('mailbookminilist');				
			$this->MailCacheFunctionFlush('mailbookgroupview');
			$this->MailCacheFunctionFlush('mailbookexpresslist');	
			$this->error['result'] = $this->errorcode['81'];	
		}
	
	} else {
		
		$this->error['result'] = $this->errorcode['82'];
	}		
}

function MailBookImport($filearr, $format, $notify) {
	
	$server_main				= $this->server['main'];
	$this->mail_book_import_contactarr 	= array();
	$this->mail_book_import_count 		= 0;
	
	if( substr($filearr['file']['name'],-3) == substr($format,0,3) ) {
		
		if( $filearr['file']['size'] > 0 && $filearr['file']['error'] == 0 ) {
						
			if( $this->MailBookGroupEveryoneGet() ) {
								
				$importarr = file($filearr['file']['tmp_name']);
					
				switch($format) {
		
					case 'csvms':				
						$this->MailBookImportCSVMS($importarr);
						break;
				
					case 'csvnab':
						$this->MailBookImportNAB($importarr);
						break;
						
					case 'csveu':
						$this->MailBookImportCSVEU($importarr);
						break;
					
					default:
						$this->error['result'] = $this->errorcode['96'];
						break;	
				}
												
				if( sizeof($this->mail_book_import_contactarr) > 0 ) {
					
					foreach($this->mail_book_import_contactarr as $id => $contactarr) {
				
						if( $this->MailBookFormat($contactarr) ) {
								
							if( $notify == 1 ) {
								
								$sender 	= $this->lp['login'];
							 	$recipient 	= (isset($contactarr['pemail'])) ? $contactarr['pemail'] : $contactarr['bemail'];
								$name 		= $this->mail_contact_list['fname'] . ' ' . $this->mail_contact_list['lname'];
								include($this->tpl['php'] . '/book_import_notify_email_msg.tpl');
								include($this->tpl['php'] . '/book_import_notify_email_subject.tpl');
								mail($recipient,$this->MailRandomArrayString($templatesubject),$template,'From: ' . $sender . "\r\nContent-type: text/html; charset=iso-8859-1\r\nReturn-path: <" . $sender . ">\r\n");
							}
											
							$fields = '(';
						 	$values = '(';
										
							foreach($contactarr as $name => $value) {
			
								$fields .= $name . ',';
								$values .= '\'' . $value . '\',';
							}
					 	
							$fields .= 'mbox,mgroup,mreply,mxprs,';
							$values .= '\'' . $this->lp['login'] . '\',\'' . $this->mail_book_group_everyone . '\',\'0\',\'0\',';
							$fields = substr($fields,0,-1);
							$values = substr($values,0,-1);
							$fields .= ')';
							$values .= ')';
						
							if( $this->DBQuery("INSERT into mailbook " . $fields . " VALUES" . $values) ) {
			
								$this->mail_book_import_count++;
							}
						} 
					}
						
					if( $this->mail_book_import_count > 0 ) {
				
						$this->DBQuery("UPDATE mailbookgroup SET mcount=(mcount) + " . $this->mail_book_import_count . " WHERE mbox='" . $this->lp['login'] . "' AND mgroup='Everyone'");			
						$this->MailCacheFunctionFlush('mailbookminilist');
						$this->MailCacheFunctionFlush('mailfilterprivatelist');		   					   				
			   			$this->MailCacheFunctionFlush('mailbookgroupview');
					}
				}
			
			}
				
				$_SESSION['result'] = str_replace('$count',$this->mail_book_import_count,$this->errorcode['97']);
				header('Location: http://' . $this->server['main'] . '/login/addressbook');
				exit();
		} else {
		
			$this->error['result'] = $this->errorcode['98'];
		}
	} else {
		
		$this->error['result'] = $this->errorcode['99'];
	}
}

function MailBookImportCSVEU($importarr) {
	
	foreach($importarr as $id => $line) {
		
		$line = trim(addslashes(str_replace('"','',$line)));
		
		if( empty($line) ) continue;
			
		$contactarr = array();
		list($contactarr['pnname'],$contactarr['pemail'],$contactarr['pname'],$contactarr['pfname'],$contactarr['plname'],$contactarr['paddress'],$contactarr['pcity'],$contactarr['pstate'],$contactarr['pcountry'],$contactarr['pzip'],$contactarr['ptel'],$contactarr['pftel'],$contactarr['pctel'],$contactarr['purl'],$contactarr['bcompany'],$contactarr['bposition'],$contactarr['baddress'],$contactarr['bcity'],$contactarr['bstate'],$contactarr['bcountry'],$contactarr['bzip'],$contactarr['btel'],$contactarr['bftel'],$null,$contactarr['burl'],$null,$null,$null,$contactarr['notes']) = explode(',',$line);
		
		if( empty($contactarr['pfname']) && !empty($contactarr['pname']) ) {
					
			list($fname,$lname,$lname1,$lname2)	= explode(' ',$contactarr['pname']);
			$contactarr['pfname'] 			= $fname;
					
			if( empty($contactarr['plname']) ) {
						
				$contactarr['plname'] 		= trim($lname . ' ' . $lname1 . ' ' . $lname2);
			}
		
		} elseif( empty($contactarr['pfname']) && !empty($contactarr['pnname']) ) {
			
			list($fname,$lname,$lname1,$lname2) 	= explode(' ',$contactarr['pnname']);
			$contactarr['pfname'] 			= $fname;
					
			if( empty($contactarr['plname']) ) {
						
				$contactarr['plname'] 		= trim($lname . ' ' . $lname1 . ' ' . $lname2);
			}
		}
		
		list($contactarr['pemail'],$contactarr['bemail']) = explode(' ',$contactarr['pemail']);
		unset($contactarr['pnname']);
		unset($contactarr['pname']);
			
		if( !empty($contactarr['pfname']) && !empty($contactarr['pemail']) ) {
			
			if( !$this->MailFormatEmail($contactarr['pemail']) || $this->MailBookContactIsByEmail('pemail',$contactarr['pemail']) ) {
					
				continue;
			}
			
		} elseif( !empty($contactarr['bcompany']) && !empty($contactarr['bemail']) ) {
				
			if( !$this->MailFormatEmail($contactarr['bemail']) || $this->MailBookContactIsByEmail('bemail',$contactarr['bemail']) ) {
				
				continue;
			}
		} else {
			
			continue;
		}
		        
		if( isset($contactarr['pfname']) && !$this->MailFormatEmail($contactarr['pfname']) ) {
			
			$contactarr['pfname'] = ucwords(strtolower($contactarr['pfname']));
		
		} else {
		
			$contactarr['pfname'] = strtolower($contactarr['pfname']);
		}
			
		if( isset($contactarr['plname']) ) {
		
			$contactarr['plname'] = ucwords(strtolower($contactarr['plname']));
		}
		
		if( isset($contactarr['pemail']) ) {
			
			$contactarr['pemail'] = strtolower($contactarr['pemail']);
		}
		
		if( isset($contactarr['bemail']) ) {
			
			$contactarr['bemail'] = strtolower($contactarr['bemail']);
		}
		
		if( isset($contactarr['notes']) ) {
			
			$contactarr['notes'] = addslashes(trim($contactarr['notes']));
		}
		
		foreach($contactarr as $name => $value) {
			
			if( empty($value) ) {
				
				unset($contactarr[$name]);
			}
		}
		
		$this->mail_book_import_contactarr[] = $contactarr;	
	}
}

function MailBookImportNAB($importarr) {
	
	foreach($importarr as $id => $line) {
	
		list($name,$value) = explode(': ',trim(addslashes($line)));
	
		switch($name) {
			
			case 'givenName':
				$contactarr['pfname'] = $value;
				break;
				
			case 'sn':
				$contactarr['plname'] = $value;
				break;
			
			case 'cn':
				
				if( !isset($contactarr['pfname']) ) {
					
					list($fname,$lname,$lname1,$lname2) 	= explode(' ',$value);
					$contactarr['pfname'] 			= $fname;
					
					if( !isset($contactarr['plname']) ) {
						
						$contactarr['plname'] 		= trim($lname . ' ' . $lname1 . ' ' . $lname2);
					}
				}
				break;
						
			case 'mail':
				$contactarr['pemail'] 	= $value;
				break;
			
			case 'telephoneNumber':
				$contactarr['btel']	= $value;
				break;
			
			case 'homePhone':
				$contactarr['ptel'] 	= $value;
				break;
			
			case 'facsimileTelephoneNumber':
				$contactarr['pftel'] 	= $value;
				break;
			
			case 'pager':
				$contactarr['pptel'] 	= $value;
				break;
			
			case 'mobile':
				$contactarr['pctel']	= $value;
				break;
			
			case 'homePostalAddress':
				$contactarr['paddress']	= $value;
				break;
			
			case 'mozillaHomeLocalityName':
				$contactarr['pcity']	= $value;
				break;
			
			case 'mozillaHomeState':
				$contactarr['pstate']	= $value;
				break;
			
			case 'mozillaHomePostalCode':
				$contactarr['pzip']	= $value;
				break;
			
			case 'mozillaHomeCountryName':
				$contactarr['pcountry'] = $value;
				break;
			
			case 'postalAddress':
				$contactarr['baddress'] = $value;
				break;
				
			case 'l':
				$contactarr['bcity']	= $value;
				break;
			
			case 'st':
				$contactarr['bstate']	= $value;
				break;
			
			case 'postalCode':
				$contactarr['bzip']	= $value;
				break;
			
			case 'c':
				$contactarr['bcountry']	= $value;
				break;
			
			case 'title':
				$contactarr['bposition']= $value;
				break;
			
			case 'o':
				$contactarr['bcompany'] = $value;
				break;
			
			case 'workurl':
				$contactarr['burl'] 	= $value;
				break;
			
			case 'homeurl':
				$contactarr['purl'] 	= $value;
				break;
			
			case 'description':
				$contactarr['notes']	= $value;
				break;		
		}
				
		if( !empty($name) ) continue;
			
			if( isset($contactarr['pfname']) && isset($contactarr['pemail']) ) {
			
				if( !$this->MailFormatEmail($contactarr['pemail']) || $this->MailBookContactIsByEmail('pemail',$contactarr['pemail']) ) {
					
					unset($contactarr);
					continue;
			}
			
			} elseif( isset($contactarr['bcompany']) && isset($contactarr['bemail']) ) {
				
				if( !$this->MailFormatEmail($contactarr['bemail']) || $this->MailBookContactIsByEmail('bemail',$contactarr['bemail']) ) {
					
					unset($contactarr);
					continue;
				}
			} else {
			
				unset($contactarr);
				continue;
			}
		  
		       if( isset($contactarr['pfname']) && !$this->MailFormatEmail($contactarr['pfname']) ) {
			
				$contactarr['pfname'] = ucwords(strtolower($contactarr['pfname']));
		
			} else {
			
				$contactarr['pfname'] = strtolower($contactarr['pfname']);
			}
	
			if( isset($contactarr['plname']) ) {
		
				$contactarr['plname'] = ucwords(strtolower($contactarr['plname']));
			}
		
			if( isset($contactarr['pemail']) ) {
			
				$contactarr['pemail'] = strtolower($contactarr['pemail']);
			}
		
			if( isset($contactarr['bemail']) ) {
			
				$contactarr['bemail'] = strtolower($contactarr['bemail']);
			}
			
			if( isset($contactarr['notes']) ) {
				
				$contactarr['notes'] = addslashes(trim($contactarr['notes']));
			}
			
			foreach($contactarr as $name => $value) {
			
				if( empty($value) ) {
				
					unset($contactarr[$name]);
				}
			}
				
			$this->mail_book_import_contactarr[] = $contactarr;
			unset($contactarr);
	}
}

function MailBookExport($formatarr) {
	
	$templateline = '';
	
	foreach($formatarr as $format => $id) {
	
		$format = $format;
	}
	
	if( $format == 'outlook' || $format == 'netscape' || $format == 'eudora' || $format == 'text' ) {
			
		if( $format == 'outlook' || $format == 'text' ) {
		
			$templateline = "First Name,Last Name,Middle Name,Name,Nickname,E-mail Address,Home Street,Home City,Home Postal Code,Home State,Home Country/Region,Home Phone,Home Fax,Mobile Phone,Personal Web Page,Business Street,Business City,Business Postal Code,Business State,Business Country/Region,Business Web Page,Business Phone,Business Fax,Pager,Company,Job Title,Department,Office Location,Notes\r\n";
		}
	
		if( $this->DBQuery("SELECT * FROM mailbook WHERE mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
			
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					if( $format == 'outlook' || $format == 'text' ) {
					
						$templateline .= $row['pfname'] . ',' . $row['plname'] . ',' . $row['pmname'] . ',' 
							       . $row['pfname'] . ' ' . $row['plname'] . ',,' 
							       . $row['pemail'] . ',' . $row['paddress'] . ',' . $row['pcity'] . ',' 
							       . $row['pzip'] . ',' . $row['pstate'] . ',' . $row['pcountry'] . ',' 
							       . $row['ptel'] . ',' . $row['pftel'] . ',' . $row['pctel'] . ',' 
							       . $row['purl'] . ',' . $row['baddress'] . ',' . $row['bcity'] . ',' 
							       . $row['bzip'] . ',' . $row['bstate'] . ',' . $row['bcountry'] . ',' 
						       	       . $row['burl'] . ',' . $row['btel'] . ' ' . $row['btelext'] . ',' 
						       	       . $row['bftel'] . ',' . $row['pptel'] . ',' . $row['bcompany'] . ','
						       	       . $row['bposition'] . ',,,' . $row['notes'] . "\r\n"; 		
					
					} elseif( $format == 'netscape' ) {
							
						$templateline .= "dn: cn=" . $row['pfname'] . ' ' . $row['plname'] . ",mail=" . $row['pemail'] . "\r\n" 
							      . "objectclass: top\r\n" 
							      . "objectclass: person\r\n" 
							      . "objectclass: organizationalPerson\r\n"
							      . "objectclass: inetOrgPerson\r\n"
							      . "objectclass: mozillaAbPersonObsolete\r\n"
							      . "givenName: " . $row['pfname'] . "\r\n"
							      . "sn: " . $row['plname'] . "\r\n"
							      . "cn: " . $row['pfname'] . ' ' . $row['plname'] . "\r\n"
							      . "mail: " . $row['pemail'] . "\r\n"
							      . "modifytimestamp: 0Z\r\n"
							      . "telephoneNumber: " . $row['btel'] .  ' ' . $row['btelext'] . "\r\n"
							      . "homePhone: " . $row['ptel'] . "\r\n"
							      . "facsimileTelephoneNumber: " . $row['pftel'] . "\r\n"
							      . "pager: " . $row['pptel'] . "\r\n"
							      . "mobile: " . $row['pctel'] . "\r\n"
							      . "homePostalAddress: " . $row['paddress'] . "\r\n"
							      . "mozillaHomeLocalityName: " . $row['pcity'] . "\r\n"
							      . "mozillaHomeState: " . $row['pstate'] . "\r\n"
							      . "mozillaHomePostalCode: " . $row['pzip'] . "\r\n"
							      . "mozillaHomeCountryName: " . $row['pcountry'] . "\r\n"
							      . "postalAddress: " . $row['baddress'] . "\r\n"
							      . "l: " . $row['bcity'] . "\r\n"
							      . "st: " . $row['bstate'] . "\r\n"
							      . "postalCode: " . $row['bzip'] . "\r\n"
							      . "c: " . $row['bcountry'] . "\r\n"
							      . "title: " . $row['bposition'] . "\r\n"
							      . "o: " . $row['bcompany'] . "\r\n"
							      . "workurl: " . $row['burl'] . "\r\n"
							      . "homeurl: " . $row['purl'] . "\r\n"
							      . "description: " . $row['notes'] . "\r\n\r\n";
					
					} elseif( $format == 'eudora' ) {
							
						$templateline .= '"' . $row['pfname'] . ' ' . $row['plname'] . '","' . $row['pemail'] . ' ' . $row['bemail'] . 
								'","' . $row['pfname'] . ' ' . $row['plname'] . '","' . $row['pfname'] . '","' . $row['plname'] . '","' . $row['paddress'] . '","' . $row['pcity'] . 
								'","' . $row['pstate'] . '","' . $row['pcountry'] . '","' . $row['pzip'] . '","' . $row['ptel'] . 
								'","' . $row['pftel'] . '","' . $row['pctel'] . '","' . $row['purl'] . '","' . $row['bcompany'] . 
								'","' . $row['bposition'] . '","' . $row['baddress'] . '","' . $row['bcity'] . '","' . $row['bstate'] . 
								'","' . $row['bcountry'] . '","' . $row['bzip'] . '","' . $row['btel'] . ' ' . $row['btelext'] . 
								'","' . $row['bftel'] . '","","' . $row['burl'] . '","","","","' . $row['notes'] . '"' . "\r\n\r\n";
					}
				}
				
				header("Cache-control: private"); 
				header('Content-Type: force/download');
				header('Content-Disposition: attachment; filename="' . $format . '_export.csv"'); 
				header('Content-Length: ' . strlen($templateline));
				print($templateline);
				exit();		 
		      
			} else {
			
				$this->error['result'] = $this->errorcode['94'];
			}
		} 
	} else {
		
		$this->error['result'] = $this->errorcode['95'];
	}	     
}	
function MailBookImportCSVMS($importarr) {
	
	$importconv = array('First Name' => 'pfname', 'Last Name' => 'plname', 'Middle Name' => 'pmname','Name' => 'pname', 'Nickname' => 'pnname', 'E-mail Address' => 'pemail','Home Street' => 'paddress', 'Home City' => 'pcity', 'Home Postal Code' => 'pzip', 'Home State' => 'pstate','Home Country/Region' => 'pcountry', 'Home Phone' => 'ptel', 'Home Fax' => 'pftel', 'Mobile Phone' => 'pctel','Personal Web Page' => 'purl',
			     'Business Street' => 'baddress','Business City' => 'bcity','Business Postal Code' => 'bzip','Business State' => 'bstate','Business Country/Region' => 'bcountry', 'Business Web Page' => 'burl', 'Business Phone' => 'btel', 'Business Fax' => 'bftel', 'Pager' => 'pptel', 'Company' => 'bcompany', 'Job Title' => 'bposition', 'Department' => 'bdept', 'Office Location' => 'boffice','Notes' => 'notes');
	
	$contactdelim = trim($importarr[0]);
	
	foreach($importconv as $name => $var) {
		
		$contactdelim = str_replace($name,$var,$contactdelim);
	}
	
	$contactdelimarr = explode(',',$contactdelim);
	
	foreach($importarr as $id => $value) {
					
		if( $id == 0 || empty($value) ) continue;
		
		$contactarr 	= array();	
		$linearr 	= explode(',',$value);
		
		foreach($linearr as $id => $value) {
			
			if( !empty($value) ) {
			
				$contactarr[$contactdelimarr[$id]] = addslashes(trim($value));
			}
		}
		
		if( !isset($contactarr['pfname']) ) {
			
			if( isset($contactarr['pname']) ) {
			
				list($fname,$lname,$lname1,$lname2) 	= explode(' ',$contactarr['pname']);
				$contactarr['pfname'] 			= $fname;
			
				if( !isset($contactarr['plname']) ) {
				
					$contactarr['plname'] 		= trim($lname . ' ' . $lname1 . ' ' . $lname2);
				}
				
			} elseif( isset($contactarr['pnname']) ) {
			
				list($fname,$lname,$lname1,$lname2) 	= explode(' ',$contactarr['pnname']);
				$contactarr['pfname'] 			= $fname;
			
				if( !isset($contactarr['plname']) ) {
				
					$contactarr['plname'] 		= trim($lname . ' ' . $lname1 . ' ' . $lname2);
				}
			} 
		}
		
		if( isset($contactarr['pfname']) && isset($contactarr['pemail']) ) {
			
			if( !$this->MailFormatEmail($contactarr['pemail']) || $this->MailBookContactIsByEmail('pemail',$contactarr['pemail']) ) {
				
				continue;
			}
			
		} elseif( isset($contactarr['bcompany']) && isset($contactarr['bemail']) ) {
				
			if( !$this->MailFormatEmail($contactarr['bemail']) || $this->MailBookContactIsByEmail('bemail',$contactarr['bemail']) ) {
				
				continue;
			}
		} else {
			
			continue;
		}	
						
		unset($contactarr['pname']);
		unset($contactarr['pnname']);				
				
		if( isset($contactarr['pfname']) && !$this->MailFormatEmail($contactarr['pfname']) ) {
			
			$contactarr['pfname'] = ucwords(strtolower($contactarr['pfname']));
		
		} else {
		
			$contactarr['pfname'] = strtolower($contactarr['pfname']);
		}
						
		if( isset($contactarr['pmname']) ) {
		
			$contactarr['pmname'] = ucwords(strtolower($contactarr['pmname']));
		}
	
		if( isset($contactarr['plname']) ) {
		
			$contactarr['plname'] = ucwords(strtolower($contactarr['plname']));
		}
		
		if( isset($contactarr['pemail']) ) {
			
			$contactarr['pemail'] = strtolower($contactarr['pemail']);
		}
		
		if( isset($contactarr['bemail']) ) {
			
			$contactarr['bemail'] = strtolower($contactarr['bemail']);
		}
		
		if( isset($contactarr['notes']) ) {
			
			$contactarr['notes'] = addslashes(trim($contactarr['notes']));
		}
		
		$this->mail_book_import_contactarr[] = $contactarr;
	}
}

function MailBookContactIs($cid) {
	
	if( is_numeric($cid) ) {
		
		if( $this->DBQuery("SELECT cid FROM mailbook WHERE cid=" . $cid . " AND mbox='" . $this->lp['login'] . "'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				return TRUE;
			}
		}
	}
}

function MailAccountUpdate($mid, $accountarr) {
	
	if( $accountarr['saveto'] == 'new' ) {
		
		if( $this->MailFolderRegister($accountarr['newfolder']) ) {
	
			$accountarr['folder'] = $accountarr['newfolder'];
		
		} else {
		
			$accountarr['folder'] = 'Inbox';
		}
	
	} elseif( $accountarr['saveto'] == 'existant' ) {
		
		if( $this->MailFolderIsByName($accountarr['existantfolder']) ) {
			
			$accountarr['folder'] = $accountarr['existantfolder'];
		
		} else {
					
			$accountarr['folder'] = 'Inbox';
		}
	}

	if( $accountarr['auto'] != 1 ) {
		
		$accountarr['auto'] = 0;
	}
		
	if( isset($accountarr['name']) ) {
			
		$accountarr['name'] = ucwords(strtolower($accountarr['name']));
	}
	
	if( isset($accountarr['email']) ) {
		
		$accountarr['email'] = strtolower($accountarr['email']);
	}
	
	if( isset($accountarr['reply']) ) {
		
		$accountarr['reply'] = strtolower($accountarr['reply']);
	}
	
	if( isset($accountarr['host']) ) {
		
		$accountarr['host'] = strtolower($accountarr['host']);
	}
	
	unset($accountarr['newfolder']);
	unset($accountarr['existantfolder']);
	unset($accountarr['saveto']);
	
	$query = "UPDATE mailaccount SET ";

	foreach($accountarr as $name => $value) {
					
		$query .= $name . '=\'' . addslashes(trim($value)) . '\', ';
	}
	
	$query  = substr($query,0,-2);
	$query .= ' WHERE id=' . $mid . ' AND  mbox=\'' . $this->lp['login'] . '\'';
	
	if( $this->DBQuery($query) ) {
		
		$this->MailCacheFunctionFlush('mailaccountlist');	
		(!isset($accountarr['nick'])) ? $accountarr['nick'] = 'AKAMail' : NULL;
		$_SESSION['result'] = str_replace('$nick',$accountarr['nick'],$this->errorcode['33']);
		header('Location: https://' . $this->server['main'] . '/login/othermail');
		exit();
	}
}

function MailRefresh() {
	
	if( $this->DBQuery("SELECT id FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' AND auto='1'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			$result = $this->db['result'];
			
			while( $row = mysql_fetch_array($result, MYSQL_ASSOC) ) {
								
				$this->MailAccountRefresh($row['id']);
			}
			
			$this->MailMsgDeleteAll();
				
			if( $this->mail_account_refresh_cnt > 0 ) {

				$this->error['result'] = str_replace('$cntmsg', $this->mail_account_refresh_cnt, $this->errorcode['22']);
			}
		}
	}
}
		
function MailAccountList() {
		
	$templateline		= '';
	$templateselect 	= '';
	$templateaddress	= 'akalink.com,';
		
	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
			
		if( $this->DBQuery("SELECT id,nick,email,reply,host,color,folder,auto,rdonly,dflt FROM mailaccount WHERE mbox='" . $this->lp['login'] . "' ORDER BY rdonly DESC") ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
			
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
					$mid	= $row['id'];
					$mnick	= $row['nick'];
					$memail = $row['email'];
					$mreply = $row['reply'];
					$mhost 	= $row['host'];
					$mcolor = $row['color'];
					$mfolder= $row['folder'];
					$mauto 	= ($row['auto'] == 1) ? '<img src="/img/auto_chk_icon.jpg" width="16" height="15" alt="AKAMail will automatically check this account for new e-mail.">' : NULL;	
					$mdelete= ($row['rdonly'] == 1) ? '<img src="/img/btn_delete_dwn.jpg" width="51" height="13" border="0">' : '<input name="delete[' . $mid . ']" type="image"  src="/img/btn_delete_account.gif" width="51" height="13" border="0" onClick="return confirm(\'Are you sure you want to remove this POP account?\');">';
											
					include($this->tpl['php'] . '/account_list.tpl');
					$templateline .= $template;
					
					if( $row['dflt'] == 1 ) {
					
						$templateselect .= '<option selected value="' . $mid . '">' . $memail . ' (' . $mhost . ') - default</option>';
				
					} else {
				
						$templateselect .= '<option value="' . $mid . '">' . $memail . ' (' . $mhost . ')</option>';
					}
											
					$templateaddress .= $memail . ',';
					
					if( !empty($mreply) ) {
						
						$templateaddress .= $mreply . ',';
					}
				}
			} else {
			
				include($this->tpl['php'] . '/account_list_none.tpl');
				$templateline 		= $template;
				$templateselect 	= $this->lp['login'] . ' ( ' . $this->server['main'] . ' )';
				$templateaddress 	= $this->lp['login'];	
			}		
			
			$_SESSION['function'][__FUNCTION__]['data']['list'] 	= $templateline;
			$_SESSION['function'][__FUNCTION__]['data']['select'] 	= $templateselect;
			$_SESSION['function'][__FUNCTION__]['data']['address'] 	= $templateaddress;
			$_SESSION['function'][__FUNCTION__]['refresh'] 		= time() + $this->timeout['func_cache'];
			$this->mail_account_list				= $templateline;
			$this->mail_account_select_list 			= $templateselect;
			$this->mail_account_address_list 			= $templateaddress;	
		}
	} else {
		
		$this->mail_account_list		= $_SESSION['function'][__FUNCTION__]['data']['list'];
		$this->mail_account_select_list 	= $_SESSION['function'][__FUNCTION__]['data']['select'];
		$this->mail_account_address_list	= $_SESSION['function'][__FUNCTION__]['data']['address'];
	}
	
	return TRUE;
}

function MailMsgViewHighlightField($mid,$field) {

	$templateline = '';	
	$delim = (strpos(';',$field)) ? ';' : ',';
	$fieldarr = explode($delim,$field);
	
	foreach($fieldarr as $address) {
		
		$address = trim($address);
		 
		if( $this->MailFormatEmail($address) ) {
			
			if( !strstr($this->mail_account_address_list,$this->mail_email_match) ) {
						
				$templateline .= '<a href="http://' . $this->server['main'] . '/login/compose?mid=' . $mid. '&action=reply&to=' . urlencode($this->mail_email_match) . '">' . $this->mail_email_match . '</a>, ';
			
			} else {
				
				$templateline .= $this->mail_email_match . ', ';
			}
		}
	}
	
	if( empty($templateline) ) {
		
		return $this->lp['login'];
	}
	
	return substr($templateline,0,-2);
}
	
function MailMsgViewHighlightHeader($headerarr) {
	
	$templateline = '';
	
	if( is_array($headerarr) ) {
		
	foreach($headerarr as $header => $data) {
		
		if( strtolower($header) == 'date' ) continue;
		
		$header = ucwords($header);
						
		if( is_array($data) ) {
						
			foreach($data as $dataarr => $headerdata) {
									
				if( empty($headerdata) ) continue;
				
				$headerdata = htmlspecialchars(trim($headerdata));			
				include($this->tpl['php'] . '/view_header_highlight.tpl');
				$templateline .= $template;
			}
			
			continue;
		} 
		
		if( empty($data) ) continue;
		$headerdata = htmlspecialchars(trim($data));
		include($this->tpl['php'] . '/view_header_highlight.tpl');
		$templateline .= $template;
	}	
	
	$this->mail_msg_view_highlight_header = $templateline;
	return TRUE;
	
	}
}
			
function MailMsgViewDownload($mid) {
	
	$msgview = array();
	
	if( $this->MailMsgViewMsg($mid) ) {
					
		$msgview 		= $this->mail_msg_view_header;
		$msgview['mmsg'] 	= $this->mail_msg_view_msg['mmsg'];
		$msgview['userid'] 	= $this->lp['login'];
		$server_main		= $this->server['main'];
		include($this->tpl['php'] . '/view_save_desktop.tpl');
		header("Cache-control: private"); 
		header('Content-Type: force/download');
		header('Content-Disposition: attachment; filename="AKAMail-about ' . $msgview['msubject'] . '.html"');
		header('Content-Length: ' . strlen($template));
		print($template);
	}
		
	exit();
}

function MailMsgViewSelect($mid) {
	
	$this->mail_view_previous 	= 0;
	$this->mail_view_next 		= 0;
	$next 				= 0;

	if( $this->DBQuery("SELECT mid FROM mailbox WHERE mbox='" . $this->lp['login'] . "' AND mfolder='" . $_SESSION['folder_cur'] . "' AND  mdelete='0' ORDER BY " . $this->mail_list_sort) ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
				
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
			
				if( $row['mid'] != $mid && $next == 0 ) {
					
					$this->mail_view_previous = $row['mid'];
					continue;
				
				} elseif( $row['mid'] == $mid ) {
						
					$next = 1;
					continue;
				}
					
				$this->mail_view_next = $row['mid'];
				break;
			}
		}
	}				
}

function MailMsgViewAttach($mid,$file) {
	
	if( $this->MailMsgIs($mid) ) {
		
		$file = basename(urldecode($file));
		
		if( isset($this->mail_msg_view_attach[$file]) ) {
			
			list($user,$domain) = explode('@',$this->lp['login']);
			$filename = $this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download/' . $mid . $file ;
		
			if( is_file($filename) ) {
				 
				header("Cache-control: private"); 	
				header('Content-Type: force/download');
				header('Content-Disposition: attachment; filename="' . $file . '"'); 
				header('Content-Length: ' . $this->mail_msg_view_attach[$file]);
				
				if( ($fp = fopen($filename, 'r')) ) {
						
					fpassthru($fp);
					fclose($fp);
				}
			}
		}
	}
	exit();
}

function MailMsgViewHeader($mid) {
	
	if( $this->DBQuery("SELECT * FROM mailbox WHERE mid=" . $mid) ) {
		
		if( mysql_num_rows($this->db['result']) == 1 ) {
			
			if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$this->mail_msg_view_header = $row;
				return TRUE;
			}
		}
	}
}

function MailMsgViewMsg($mid) {
	
	$msgparse = array();
	$this->mail_msg_view_header = array();
	$this->mail_msg_view_msg = array();
	$this->mail_msg_view_contact = array();
	$this->mail_msg_view_attach = array();
	
	if( $this->MailMsgIs($mid) ) {
		
		if( $this->DBQuery("SELECT * FROM mailbox LEFT JOIN msgbox on mailbox.mid = msgbox.mid WHERE mailbox.mid=" . $mid) ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
			
				if( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
	                                
	                                $html_allow_tags = '<a><b><i><u><p><em><center><small><strong><br><table><td><tr><div><tbody><font><link><title><span><head><pre><hr><meta><img><object><embed><style>';
						
					$decoder = new Mail_mimeDecode(stripslashes($row['mheader']) . "\r\n\r\n" . stripslashes($row['mmsg']),"\r\n");
					$structure = $decoder->decode(array('include_bodies' => TRUE,'decode_bodies' => TRUE, 'decode_headers' => TRUE));
					$this->MailMsgViewHighlightHeader($structure->headers);
											
					if( sizeof($structure->parts[0]->parts) > 1 ) {
						
						foreach($structure->parts[0]->parts as $id => $arr ) {
							
							if( isset($arr->parts) ) {
								
								foreach($arr->parts as $id => $arr) {
										
									$tmparr[] = $arr;
								}
							} else {
								
								$tmparr[] = $arr;
							}
						}
						
						$tmparr = array_reverse($tmparr);
						
						unset($structure->parts[0]);
						
						foreach($tmparr as $id => $arr) {
							
							$structure->parts[] = $arr;
						}
						
						$structure->parts = array_reverse($structure->parts);
					}
																		
					if( !empty($structure->headers['from']) ) {
						
						$structure->headers['from'] = trim(str_replace('"','',$structure->headers['from']));	
						$this->mail_msg_view_header['mfrom'] = htmlspecialchars($structure->headers['from']);
					
						if( ($spos = strpos($structure->headers['from'],'<')) !== FALSE ) {
					
							if( ($epos = strpos($structure->headers['from'],'>',$spos)) !== FALSE ) {
								
								if( $structure->headers['from'][0] != '<' ) {
									
									$name = substr($structure->headers['from'],0,$spos - 1);								
									
									if( !empty($name) ) {
										
										list($fname,$lname,$lname1) = explode(' ',$name);
										
										if( !empty($lname1) ) {
										
											$this->mail_msg_view_contact['pmname'] = $lname;
											$this->mail_msg_view_contact['plname'] = $lname1;
											$this->mail_msg_view_contact['pfname'] = $fname;
									
										} elseif( !empty($lname) ) {
										
											$this->mail_msg_view_contact['plname'] = $lname;
											$this->mail_msg_view_contact['pfname'] = $fname;
									
										} else {
									
											$this->mail_msg_view_contact['pfname'] = $fname;	
										}
									}
								}						
							}
						}
						
						if( $this->MailFormatEmail($structure->headers['from']) ) {
							
							$this->mail_msg_view_contact['pemail'] = $this->mail_email_match;
							
							if( !strstr($this->mail_account_address_list,$this->mail_msg_view_contact['pemail']) ) {
								
								$this->mail_msg_view_header['mfrom'] = str_replace($this->mail_msg_view_contact['pemail'],'<a href="http://' . $this->server['main'] . '/login/compose/?mid=' . $mid . '&action=reply&to=' . urlencode($this->mail_msg_view_contact['pemail']) . '">' . $this->mail_msg_view_contact['pemail'] . '</a>',$this->mail_msg_view_header['mfrom']);				
							
								if( !isset($this->mail_msg_view_contact['pfname']) ) {
								
									$this->mail_msg_view_contact['pfname'] = $this->mail_msg_view_contact['pemail'];
								}
							
								if( !$this->MailBookContactIsByEmail('pemail',$this->mail_msg_view_contact['pemail']) ) {		
										
									if( !$this->MailBookContactIsByEmail('bemail',$this->mail_msg_view_contact['pemail']) ) {
								
										$this->mail_msg_view_contact['book'] = TRUE;
									}
								}
							}
						}
														
					}
					
					if( !empty($structure->headers['to']) ) {
						
						$this->mail_msg_view_header['mto'] = $this->MailMsgViewHighLightField($mid,$structure->headers['to']);
					}
					
					if( !empty($structure->headers['cc']) ) {
						
						$this->mail_msg_view_header['mcc'] = $this->MailMsgViewHighLightField($mid,$structure->headers['cc']);					
					}
					
					$this->mail_msg_view_header['msubject'] = htmlspecialchars(stripslashes($row['msubject']));		
					$this->mail_msg_view_header['mdate'] = date('D, F jS, Y g:i a T',$row['mdate']);
				
					 switch($row['mpriority']) {

                                                case 1:
                                                	include($this->tpl['php'] . '/view_high_priority.tpl');
                                                        $this->mail_msg_view_header['mpriority'] = $template;
                                                        break;
                                                case 5:
                                                       	include($this->tpl['php'] . '/view_low_priority.tpl');
                                                        $this->mail_msg_view_header['mpriority'] = $template;
                                                        break;
                                        }
                                        
					switch($row['mstatus']) {
					
						case 1:				
							if( $row['msign'] == 1 ) {
							
								$this->mail_msg_view_header['mstatus'] = ($row['mread'] == 0) ? '<img src="/img/icons/mailboxes/ico_email_unread_signature.gif" alt="Indicates that this is a new E-Mail." width="18" height="18" onMouseOver="window.status=\'Indicates that this is a new E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">' : '<img src="/img/icons/mailboxes/ico_email_read_signature.gif" alt="Indicates that you have already read this E-Mail." width="18" height="18" onMouseOver="window.status=\'Indicates that you have already read this E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
							} else {			
								$this->mail_msg_view_header['mstatus'] = ($row['mread'] == 0) ? '<img src="/img/icons/mailboxes/ico_new_mail_unread.gif" alt="Indicates that this is a new E-Mail." width="16" height="13" onMouseOver="window.status=\'Indicates that this is a new E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">' : '<img src="/img/icons/mailboxes/ico_new_mail_read.gif" alt="Indicates that you have already read this E-Mail." width="17" height="14" onMouseOver="window.status=\'Indicates that you have already read this E-Mail.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
							}
							break;
							
						case 2:
							$this->mail_msg_view_header['mstatus'] = '<img src="/img/icons/mailboxes/ico_reply.gif" alt="You have replied to this E-Mail already." width="16" height="16" onMouseOver="window.status=\'You have replied to this E-Mail already.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
							break;
						case 3:
							$this->mail_msg_view_header['mstatus'] = '<img src="/img/icons/mailboxes/ico_forward.gif" alt="You have forwarded this E-Mail to another person." width="16" height="16" onMouseOver="window.status=\'You have forwarded this E-Mail to another person.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
							break;
					
						case 4:
							$this->mail_msg_view_header['mstatus'] = '<img src="/img/icons/mailboxes/ico_flagged.gif" alt="Indicates that this E-mail his flagged for Review." width="19" height="16" onMouseOver="window.status=\'Indicates that this E-mail his flagged for Review.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
							break;
						
						case 5:
							$this->mail_msg_view_header['mstatus'] = '<img src="/img/icons/mailboxes/ico_appointment.gif" alt="Indicates that this E-mail is an Appointment." width="16" height="16" onMouseOver="window.status=\'Indicates that this E-mail is an Appointment.\'; return true;" onMouseOut="window.status=\'\'; return true;">';	
							break;
					}
					
					if( sizeof($structure->parts) > 1 ) {
						
						list($user,$domain) = explode('@',$this->lp['login']);
						$contentidarr = array();
						$attachfile = '';
						$dldir = $this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download';
						$httphref = 'http://' . $this->server['main'] . '/login/view/?mid=' . $mid . '&file=';
						$cnt = 0;
							
						for($i=1,$max=sizeof($structure->parts); $i<$max; $i++) {
							
							$file = '';
							$filesize = 0;
							$size = 0;
							
							if( strstr($structure->parts[$i]->headers['content-type'],'application/x-pkcs7-signature') ) continue;
							if( strstr($structure->parts[$i]->headers['content-type'],'application/pgp-signature') ) continue;
						
							if( !empty($structure->parts[$i]->ctype_parameters['name']) ) {
								
								$file = $structure->parts[$i]->ctype_parameters['name'];
							
							} elseif( !empty($structure->parts[$i]->d_parameters['filename']) ) {
								
								$file = $structure->parts[$i]->d_parameters['filename'];
							}
						
							if( empty($file) ) continue;
							
							$file = basename($file);
							$filesize = strlen($structure->parts[$i]->body);
							if( $filesize == 0 ) continue;
							$size = ($filesize > 1048576) ? round($filesize / 1024 / 1024,2) . ' MB' : round($filesize / 1024,2) . ' KB';
							$location = '<a href="' . $httphref . urlencode($file) . '">' . htmlspecialchars($file) . '</a>';								
							if( isset($structure->parts[$i]->headers['content-id']) ) $contentidarr[$mid . $file] = $structure->parts[$i]->headers['content-id'];
							
							if( !is_file($dldir . '/' . $mid . $file) ) {
								
								if( ($fp = fopen($dldir . '/' . $mid . $file,'w')) ) {
										
									flock($fp,2);
									fwrite($fp,$structure->parts[$i]->body,$filesize);
									flock($fp,3);
									fclose($fp);
								}	
							}
							
							$ext = strtolower(substr($file,strpos($file,'.')+1,strlen($file)));	
							
							switch($ext) {
					
								case 'bmp':
									$icon = '<img src="/img/icons/attachments/ico_attachment_bmp.gif" width="54" height="51" border="0">';
									break;	
			
								case 'exe':	
									$icon = '<img src="/img/icons/attachments/ico_attachment_exe.gif" width="52" height="55" border="0">';
									break;
					
								case 'gif':
									$icon = '<img src="/img/icons/attachments/ico_attachment_gif.gif" width="44" height="55" border="0">';
									break;
					
								case 'jpeg': case 'jpg':
									$icon = '<img src="/img/icons/attachments/ico_attachment_jpg.gif" width="45" height="53" border="0">';
									break;
							
								case 'avi': case 'mov': case 'divx': case 'qt':
								case 'mpeg': case 'mpg': case 'mpe': case 'movie': case 'wmv':
									$icon = '<img src="/img/icons/attachments/ico_attachment_movie.gif" width="46" height="53" border="0">';
									break;
					
								case 'mp3': case 'mp2': case 'mp1':  case 'cda': case 'wav': case 'mid': case 'midi':
								case 'aif': case 'aiff': case 'wma': case 'ram': case 'ra': case 'rm': case 'snd':
								case 'au': 
									$icon = '<img src="/img/icons/attachments/ico_attachment_audio.gif" width="46" height="27" border="0">';
									break;
					
								case 'pdf':
									$icon = '<img src="/img/icons/attachments/ico_attachment_pdf.gif" width="46" height="54" border="0">';
									break;
					
								case 'ppt':
									$icon = '<img src="/img/icons/attachments/ico_attachment_powerpoint.gif" width="52" height="52" border="0">';
									break;
					
								case 'rtf': case 'doc': case 'txt':
									$icon = '<img src="/img/icons/attachments/ico_attachment_worddoc.gif" width="51" height="49" border="0">';
									break;
						
								case 'xls':
									$icon = '<img src="/img/icons/attachments/ico_attachment_xls.gif" width="54" height="50" border="0">';
									break;
					
								case 'psd':
									$icon = '<img src="/img/icons/attachments/ico_attachment_psd.gif" width="56" height="52" border="0">';
									break;
					
								case 'zip': case 'rar': case 'arj': case 'bz2':
								case 'gz': case 'tgz': case 'tar': case 'ace':
									$icon = '<img src="/img/icons/attachments/ico_attachment_archive.gif" width="54" height="50" border="0">';
									break;
					
								case 'swf': case 'fla':
									$icon = '<img src="/img/icons/attachments/ico_attachment_fla.gif" width="43" height="53" border="0">';
									break;
					
								case 'htm': case 'html':
									$icon = '<img src="/img/icons/attachments/ico_attachment_html.gif" width="56" height="53" border="0">';
									break;
					
								case 'php': case 'php3': case 'php4': case 'cgi': case 'css':
								case 'js': case 'pl': case 'perl': case 'shtml': case 'python':
								case 'asp': case 'jsp': case 'sh': case 'bash': 
								case 'c': case 'h': case 'xml':
									$icon = '<img src="/img/icons/attachments/ico_attachment_script.gif" width="49" height="55" border="0">';
									break;
					
								default:
									$icon = '<img src="/img/icons/attachments/ico_attachment_unknown.gif" width="51" height="63" border="0">';
									break;
							}
							
							if( !isset($contentidarr[$mid . $file]) ) {
														
								$cnt++;
								$icon = '<a href="' . $httphref . urlencode($file) . '">' . $icon . '</a>';									
								$this->mail_msg_view_attach[$file] = $filesize;
								include($this->tpl['php'] . '/view_attach_file.tpl');
								$attachfile .= $template;
							}
						}				
						
						if( $cnt > 0 ) {
							
							include($this->tpl['php'] . '/view_attach.tpl');
							$this->mail_msg_list_attach = $template;
							unset($attachfile);
							unset($template);
						}
					}
													
					if( isset($structure->body) ) {
	
						if( strstr(strtolower($structure->headers['content-type']),'plain') || $structure->headers['content-type'] == 'text'  || (strtolower($structure->ctype_primary) == 'text' && strtolower($structure->ctype_secondary) == 'plain') ) {
							
							$msgparse['text'] = $structure->body;
						
						} elseif( strstr(strtolower($structure->headers['content-type']),'html') || (strtolower($structure->ctype_primary) == 'text' && strtolower($structure->ctype_secondary) == 'html') ) {
							
							$msgparse['html'] = $structure->body;
						}
					
					} elseif( isset($structure->parts[0]->body) ) { 
						
						if( !isset($structure->parts[0]->ctype_parameters['name']) && !isset($structure->parts[0]->d_parameters['filename'])  ) {
											
							if( strstr(strtolower($structure->parts[0]->headers['content-type']),'plain') || (strtolower($structure->parts[0]->ctype_primary) == 'text' && strtolower($structure->parts[0]->ctype_secondary) == 'plain') ) {
						
								$msgparse['text'] = $structure->parts[0]->body;
						
							} elseif( strstr(strtolower($structure->parts[0]->headers['content-type']),'html') || (strtolower($structure->parts[0]->ctype_primary) == 'text' && strtolower($structure->parts[0]->ctype_secondary) == 'html') ) {
						
								$msgparse['html'] = $structure->parts[0]->body;
							}
						}
						
						if( !isset($structure->parts[1]->ctype_parameters['name']) && !isset($structure->parts[1]->d_parameters['filename'])  ) {
								
							if( isset($structure->parts[1]->body) ) {
						
								if( strstr(strtolower($structure->parts[1]->headers['content-type']),'plain') || (strtolower($structure->parts[1]->ctype_primary) == 'text' && strtolower($structure->parts[1]->ctype_secondary) == 'plain') ) {
						
									$msgparse['text'] = $structure->parts[1]->body;
							
								} elseif( strstr(strtolower($structure->parts[1]->headers['content-type']),'html') || (strtolower($structure->parts[1]->ctype_primary) == 'text' && strtolower($structure->parts[1]->ctype_secondary) == 'html') ) {
						
									$msgparse['html'] = $structure->parts[1]->body;
								}
							}
						}
						
					} elseif( isset($structure->parts[0]->parts[0]->body) ) { 
						
						if( !isset($structure->parts[0]->parts[0]->ctype_parameters['name']) && !isset($structure->parts[0]->parts[0]->d_parameters['filename'])  ) {
							
							if( strstr(strtolower($structure->parts[0]->parts[0]->headers['content-type']),'plain') || (strtolower($structure->parts[0]->parts[0]->ctype_primary) == 'text' && strtolower($structure->parts[0]->parts[0]->ctype_secondary) == 'plain') ) {
						
								$msgparse['text'] = $structure->parts[0]->parts[0]->body;
						
							} elseif( strstr(strtolower($structure->parts[0]->parts[0]->headers['content-type']),'html') || (strtolower($structure->parts[0]->parts[0]->ctype_primary) == 'text' && strtolower($structure->parts[0]->parts[0]->ctype_secondary) == 'html') ) {
						
								$msgparse['html'] = $structure->parts[0]->parts[0]->body;
							}
						}
						
						if( !isset($structure->parts[0]->parts[1]->ctype_parameters['name']) && !isset($structure->parts[0]->parts[1]->d_parameters['filename'])  ) {
							
							if( isset($structure->parts[0]->parts[1]->body) ) {
						
								if( strstr(strtolower($structure->parts[0]->parts[1]->headers['content-type']),'plain') || (strtolower($structure->parts[0]->parts[1]->ctype_primary) == 'text' && strtolower($structure->parts[0]->parts[1]->ctype_secondary) == 'plain') ) {
						
									$msgparse['text'] = $structure->parts[0]->parts[1]->body;
							
								} elseif( strstr(strtolower($structure->parts[0]->parts[1]->headers['content-type']),'html') || (strtolower($structure->parts[0]->parts[1]->ctype_primary) == 'text' && strtolower($structure->parts[0]->parts[1]->ctype_secondary) == 'html') ) {
						
									$msgparse['html'] = $structure->parts[0]->parts[1]->body;
								}
							}
						}
						
					} elseif( !isset($structure->body) ) {
						
						$msgparse['text'] = '';
					}				
					
					if( isset($msgparse['text']) ) {
						
						$this->mail_msg_view_msg['mmsgtext'] = nl2br(@htmlspecialchars(wordwrap(trim($msgparse['text'])), 100,"\n"));
					}
					
					if( isset($msgparse['html']) ) {
						
						$this->MailMsgStripBackground($msgparse['html']);
						$this->mail_msg_view_msg['mmsghtml']= trim(strip_tags($msgparse['html'],$html_allow_tags));
						
						if( sizeof($contentidarr) > 0 ) {
							
							$this->mail_msg_view_msg['mmsghtml'] = $this->MailMsgStripInsert($this->mail_msg_view_msg['mmsghtml'],$contentidarr);
						}
						
						$this->mail_msg_view_msg['mmsghtml'] = $this->MailMsgStripBug($this->mail_msg_view_msg['mmsghtml']);
						$this->mail_msg_view_msg['mmsghtml'] = $this->MailMsgStripMailto($this->mail_msg_view_msg['mmsghtml']);
					}
					
					unset($msgparse);
				
					if( $this->mail_option_list['blockmedia'] == 1 ) {
					
						if( isset($this->mail_msg_view_msg['mmsghtml']) ) {
											
							$this->mail_msg_view_msg['mmsghtml'] = $this->MailMsgStripImage($this->mail_msg_view_msg['mmsghtml']);						
							$this->mail_msg_view_msg['mmsghtml'] = $this->MailMsgStripFlash($this->mail_msg_view_msg['mmsghtml']);								 
							$this->mail_msg_view_msg['mmsghtml'] = strip_tags($this->mail_msg_view_msg['mmsghtml'],'<a><b><p><i><u><em><center><small><strong><br><table><td><tr><div><tbody><font><link><title><span><head><pre><hr><meta><img><style>');
								
							if( stristr($this->mail_msg_view_msg['mmsghtml'],'<img') ) {
							
								include($this->tpl['php']  . '/view_blockmedia.tpl');
								$this->mail_msg_view_header['blockmedia'] = $template;
							}
						}
					}
					
					if( $this->mail_option_list['recvformat'] == 0 ) {
						
						if( isset($this->mail_msg_view_msg['mmsgtext']) ) {
								
							$this->mail_msg_view_msg['mmsg'] = $this->mail_msg_view_msg['mmsgtext'];
						
						} elseif( isset($this->mail_msg_view_msg['mmsghtml']) ) {
							
							$this->mail_msg_view_msg['mmsg'] = nl2br(@htmlspecialchars(wordwrap(trim(strip_tags($this->mail_msg_view_msg['mmsghtml']))),100,"\n"));	
						
						}
					} else {
						
						if( isset($this->mail_msg_view_msg['mmsghtml']) ) {
							
							$this->mail_msg_view_msg['mmsg'] = $this->mail_msg_view_msg['mmsghtml'];
						
						} elseif( isset($this->mail_msg_view_msg['mmsgtext']) ) {
							
							$this->mail_msg_view_msg['mmsg'] = $this->mail_msg_view_msg['mmsgtext'];
						}
					}
				}
			 return TRUE;
			}
		}
	}
}

function MailMsgStripFlash($buffer) {

	 $eof = 0;
	 $epos = 0;
						 
	 while( $eof != 1 ) {
						 	
		if( ($spos = @strpos(strtolower($buffer),'<object',$epos)) !== FALSE ) {
						 	
			if( ($mpos = strpos(strtolower($buffer),'<embed',$spos)) !== FALSE ) {
						 			
				$mpos += strlen('<embed');
					
				if( ($epos = strpos(strtolower($buffer),'</object>',$mpos)) !== FALSE ) {
					
					$epos += strlen('</object>');			
					$object = substr($buffer,$mpos,$epos - $mpos);
					
					if( ($ospos = strpos(strtolower($object),'height=')) !== FALSE ) {
						
						$ospos += strlen('height=');
						
						if( ($oepos = strpos(strtolower($object),' ',$ospos)) !== FALSE || ($oepos = strpos(strtolower($object),'>',$ospos)) !== FALSE ) {
								
							$height = substr($object,$ospos,$oepos - $ospos);
						}
					} else {
						
						$height = '100';
					}
					
					if( ($ospos = strpos(strtolower($object),'width=')) !== FALSE ) {
						
						$ospos += strlen('width=');
						
						if( ($oepos = strpos(strtolower($object),' ',$ospos)) !== FALSE || ($oepos = strpos(strtolower($object),'>',$ospos)) !== FALSE ) {
								
							$width = substr($object,$ospos,$oepos - $ospos);
						}
					} else {
						
						$width = '100';
					}
					
					$buffer = substr_replace($buffer,'<img src="/img/blockedimage.gif" height=' . $height . ' width=' . $width . '>',$spos,$epos - $spos);		
				} 
			} else {
				
				$epos = $spos + strlen('<object');
			}

		} else {
					 		
			 $eof = 1;		
		}
	}
	
	return $buffer;
}
 

function MailMsgStripInsert($buffer,$contentidarr) {
	
	list($user,$domain) = explode('@',$this->lp['login']);
	$dlhref = 'http://' . $this->server['main'] . '/data/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download';		
	$epos = 0;

	foreach($contentidarr as $file => $contentid) {
		
		$contentid = substr($contentid,1,-1);
		
		if( ($spos = @strpos($buffer,'cid:' . $contentid,$epos)) !== FALSE ) {
			
			$buffer = substr_replace($buffer,$dlhref . '/' . $file,$spos,($spos + strlen('cid:' . $contentid)) - $spos);
			$epos = $spos + strlen($contentid);
		}
	}
	
	return $buffer;	
}
function MailMsgStripBug($buffer) {
	
	 $eof = 0;
	 $epos = 0;
						 
	 while( $eof != 1 ) {
						 	
		if( ($spos = @strpos(strtolower($buffer),'<img',$epos)) !== FALSE ) {
					
			if( ($epos = strpos(strtolower($buffer),'>',$spos)) !== FALSE ) {
				
				$epos += 1;				
				$img = strtolower(substr($buffer,$spos,$epos - $spos));
				
				if( !strstr($img,'jpg') && !strstr($img,'jpeg') && !strstr($img,'gif') && !strstr($img,'png') ) {
					
					$buffer = substr_replace($buffer,'',$spos,$epos - $spos);
					
				} elseif( $this->MailFormatEmail($img) ) {
					
					$buffer = substr_replace($buffer,'',$spos,$epos - $spos);
				
				} elseif( strstr($img,'height="1"') || strstr($img,'height=1 ') || strstr($img,'width="1"') ||
				 	  strstr($img,'width=1 ') ) {
				 	  	
				 	$buffer = substr_replace($buffer,'',$spos,$epos - $spos);
				 }
					
			} else {
				
				$epos = $spos + strlen('<img');
			}
		} else {
					 		
			 $eof = 1;		
		}
	}
	
	return $buffer;
}

function MailFilterTitleTag($buffer) {
	
	$wordarr	= array();
	$title		= '';
	
	if( ($spos = strpos($buffer,'<title')) !== FALSE ) {
		
		if( ($epos = strpos($buffer,'</title>',$spos)) !== FALSE ) {
			
			$epos 		+= strlen('</title>');
			$title 		= substr($buffer,$spos,$epos - $spos);
			$wordarr	= file($this->tpl['php'] . '/filter_msg_title.tpl');
			
			foreach($wordarr as $id => $word) {
				
				$word = trim(strtolower($word));
				
				if( strstr($title,$word) ) {
					
					return TRUE;
				}
			}
		}
	}
}

function MailMsgStripBackground($buffer) {

	if( ($spos = strpos(strtolower($buffer),'<body')) !== FALSE ) {
		
		if( ($mpos = strpos(strtolower($buffer),'background=',$spos)) !== FALSE ) {
						
			if( ($epos = strpos(strtolower($buffer),'>',$mpos)) !== FALSE ) {
				
				$mpos += strlen('background=');
				$this->mail_msg_view_msg_body = str_replace('"','',substr($buffer,$mpos,$epos - $mpos));
				
			} elseif( ($epos = strpos(strtolower($buffer),' ',$mpos)) !== FALSE ) {
				
				$mpos += strlen('background=');
				$this->mail_msg_view_msg_body = str_replace('"','',substr($buffer,$mpos,$epos - $mpos));
			}
			
			if( isset($_SERVER['HTTPS']) ) {
				
				$this->mail_msg_view_msg_body = str_replace('http','https',$this->mail_msg_view_msg_body);		
			}
		}
	}
}

function MailMsgStripImage($buffer) {
	
	 $eof = 0;
	 $epos = 0;
						 
	 while( $eof != 1 ) {
						 	
		if( ($spos = @strpos(strtolower($buffer),'<img',$epos)) !== FALSE ) {
					
			if( ($mpos = strpos(strtolower($buffer),'src=',$spos)) !== FALSE ) {
								
				$mpos += strlen('src=');
				
				$aepos = strpos(strtolower($buffer),' ',$mpos);
				$bepos = strpos(strtolower($buffer),'>',$mpos);
				$epos = ($aepos > $bepos) ? $bepos : $aepos;
				$buffer = substr_replace($buffer,'/img/blockedimage.gif',$mpos,$epos - $mpos);
						
			} else {
				
				$epos = $spos + strlen('<img');
			}
		} else {
					 		
			 $eof = 1;		
		}
	}
	
	return $buffer;
}
function MailMsgStripMailto($buffer) {
	
	 $eof = 0;
	 $epos = 0;
						 
	 while( $eof != 1 ) {
						 	
		if( ($spos = @strpos(strtolower($buffer),'href="mailto:',$epos)) !== FALSE ) {
			
			$spos += strlen('href="');
			
			if( ($epos = strpos(strtolower($buffer),'">',$spos)) !== FALSE ) {
				
				$email = urlencode(substr($buffer,$spos + strlen('mailto:'),$epos - ($spos + strlen('mailto:'))));
				$buffer = substr_replace($buffer,'/login/compose?to=' . $email,$spos,$epos - $spos);
							
			} else {
				
				$epos = $spos + strlen('mailto:');
			}
		} else {
					 		
			 $eof = 1;		
		}
	}
	
	return $buffer;
}
function MailDirDataRegister() {
	
	list($user,$domain) = explode('@',$this->lp['login']);
	
	if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user) ) {
		
		if( !is_dir($this->path['data'] . '/' . $domain) ) {
		
			mkdir($this->path['data'] . '/' . $domain,0700);
		}
			
		if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0]) ) {
		
			mkdir($this->path['data'] . '/' . $domain . '/' . $user[0],0700);
		}
	
		if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1]) ) {
		
			mkdir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1],0700);
		}	
	
		if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user) ) {
		
			mkdir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user,0700);
		}
		
		if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download') ) {
		
			mkdir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download',0700);
		}
		
		if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload') ) {
		
			mkdir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload',0700);
		}
		
		if( !is_dir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/signature') ) {
		
			mkdir($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/signature',0700);
		}
	}
	
	return TRUE;
}		

function MailMsgViewInclude($mid,$action) {
	
	if( !isset($_POST['compose']['editmode']) ) {
		
		$_POST['compose']['editmode'] 	= $this->mail_option_list['sendformat'];
	}
	
	$oldformat 				= $this->mail_option_list['recvformat'];
	$this->mail_option_list['recvformat'] 	= $_POST['compose']['editmode'];
		 
	if( $this->MailMsgViewMsg($mid) ) {
		
		$this->mail_option_list['recvformat'] 	= $oldformat;
		unset($this->error['result']);		
		$allto = '';
		$allcc = '';
		$tolim = (strpos(';',$this->mail_msg_view_header['mto'])) ? ';' : ',';
		$cclim = (strpos(';',$this->mail_msg_view_header['mcc'])) ? ';' : ',';
		$toarr = explode($tolim,trim(strtolower($this->mail_msg_view_header['mto'])));
		$ccarr = explode($cclim,trim(strtolower($this->mail_msg_view_header['mcc'])));
	
		foreach($toarr as $address) {
	
			$address = trim($address);
			
			if( $this->MailFormatEmail($address) ) {
						
				if( !strstr($this->mail_account_address_list,$address) ) {
									
					$allto .= $this->mail_email_match . ';';
				}
			}
		}
	
		foreach($ccarr as $address) {
			
			$address = trim($address);
			
			if( $this->MailFormatEmail($address) ) {
				
				if(  !strstr($this->mail_account_address_list,$address) ) {
					
					$ccto .= $this->mail_email_match . ';';
				}
			}
		}
		
		$allto = substr($allto,0,-1);
		$allcc = substr($ccto,0,-1);
			
		if( $_POST['compose']['editmode'] == 1 ) {
	
			$replyheader = '<DIV style="FONT: 10pt arial">Original Message</DIV>' .
        			       '<DIV style="BACKGROUND: #e4e4e4; FONT: 10pt arial; fontcolor: black"><B>From:</B> ' . 
        			       $this->mail_msg_view_header['mfrom'] . '</DIV>' . 
        			       '<DIV style="FONT: 10pt arial"><B>To:</B> ' . $this->mail_msg_view_header['mto'] . '</DIV>';
        			       
        		if( isset($this->mail_msg_view_header['mcc']) ) {
        			       	
        	 		$replyheader .=  '<DIV style="FONT: 10pt arial"><B>To:</B> ' . $this->mail_msg_view_header['mcc'] . '</DIV>';
        		}
        			      
        		$replyheader .= '<DIV style="FONT: 10pt arial"><B>Sent:</B> ' . $this->mail_msg_view_header['mdate'] . '</DIV>' .
        			       	'<DIV style="FONT: 10pt arial"><B>Subject:</B> ' . $this->mail_msg_view_header['msubject'] . '</DIV>' .
        			       	'<DIV><BR></DIV>';
        		
        		if( $action != 'send' ) {
        				       
        			$this->mail_msg_view_msg['mmsg'] = '<BR><BR>' . $replyheader . '<BR><BR>' . $this->mail_msg_view_msg['mmsg'];
        		}
        		
		} elseif( $_POST['compose']['editmode'] == 0 ) {
		
			$replyheader = "Original Message\n" . 
				       "From: " . $this->mail_msg_view_header['mfrom'] . "\n" .
				       "To: " . $this->mail_msg_view_header['mto'] . "\n";
			
			 if( isset($this->mail_msg_view_header['mcc']) ) {
        			       	
        		 	$replyheader .= "Cc: " . $this->mail_msg_view_header['mcc'] . "\n";
           		 }
					
			$replyheader .= "Sent: " . $this->mail_msg_view_header['mdate'] . "\n" . 
				        "Subject: " . $this->mail_msg_view_header['msubject'] . "\n";
			
			if( $action != 'send' ) {
				
				$this->mail_msg_view_msg['mmsg'] = "\n\n\n" . $replyheader . "\n\n" . $this->mail_msg_view_msg['mmsg'];
			}
		}
					
		switch($action) {
			
			case 'reply':
				
				$_POST['compose']['to'] 	= $this->mail_msg_view_contact['pemail'];
				
				if( !stristr(substr($this->mail_msg_view_header['msubject'],0,4),'Re') ) {
					
					$_POST['compose']['subject'] 	= 'Re: ' . $this->mail_msg_view_header['msubject'];		
				
				} else {
				
					$_POST['compose']['subject']	= $this->mail_msg_view_header['msubject'];
				}
				
				break;
						
			case 'replyall':
				
				$_POST['compose']['to'] 	= $this->mail_msg_view_contact['pemail'] . ';' . $allto;
				$_POST['compose']['cc'] 	= $allcc;
				
				if( !stristr(substr($this->mail_msg_view_header['msubject'],0,4),'Re') ) {
					
					$_POST['compose']['subject'] 	= 'Re: ' . $this->mail_msg_view_header['msubject'];		
				
				} else {
					
					$_POST['compose']['subject']	= $this->mail_msg_view_header['msubject'];
				}
				
				break;
			
			case 'send':
				
				if( !isset($_SESSION['attach']['send'][$mid]) ) {
					
					if( isset($this->mail_msg_view_attach) ) {
					
						list($user,$domain) = explode('@',$this->lp['login']);
				
						if( isset($_SESSION['attach']) ) {
					
							unset($_SESSION['attach']);
						}
							
						$_SESSION['attach']['size'] = 0;
					
						foreach($this->mail_msg_view_attach as $file => $size) {
								
							$_SESSION['attach']['file'][][basename($file)] = $size;					
							$_SESSION['attach']['size'] += $size;
							copy($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download/' . $mid . basename($file),$this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' .  basename($file));
						}
						
						$_SESSION['attach']['send'][$mid] = TRUE;
					}
				}	
				
				$_POST['compose']['to'] 	= $allto;
				$_POST['compose']['subject'] 	= $this->mail_msg_view_header['msubject'];
				break;
								
			case 'forward':
				
				if( !isset($_SESSION['attach']['forward'][$mid]) ) {
					
					if( isset($this->mail_msg_view_attach) ) {
					
						list($user,$domain) = explode('@',$this->lp['login']);
				
						if( isset($_SESSION['attach']) ) {
					
							unset($_SESSION['attach']);
						}
							
						$_SESSION['attach']['size'] = 0;
					
						foreach($this->mail_msg_view_attach as $file => $size) {
								
							$_SESSION['attach']['file'][][basename($file)] 	= $size;					
							$_SESSION['attach']['size'] 			+= $size;
							copy($this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/download/' . $mid . basename($file),$this->path['data'] . '/' . $domain . '/' . $user[0] . '/' . $user[0] . $user[1] . '/' . $user . '/upload/' .  basename($file));
						}
						
						$_SESSION['attach']['forward'][$mid] = TRUE;
					}
				}
				if( !stristr(substr($this->mail_msg_view_header['msubject'],0,4),'Fw') ) {
					
					$_POST['compose']['subject'] 	= 'Fw: ' . $this->mail_msg_view_header['msubject'];		
				
				} else {
					
					$_POST['compose']['subject'] 	= $this->mail_msg_view_header['msubject'];		
				}
				break;
		}
	}
}	
		
function MailBookMiniList() {

	$templateline = '';
	
	if( !isset($_SESSION['function'][__FUNCTION__]) || $_SESSION['function'][__FUNCTION__]['refresh'] < time() ) {
		 						
		if( $this->DBQuery("SELECT pfname,pmname,plname,pemail,bcompany,bemail FROM mailbook WHERE mbox='" . $this->lp['login'] . "' ORDER BY " . $this->addrbook['sort']) ) {
		
			if( mysql_num_rows($this->db['result']) > 0 ) {
			
				while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
					
					if( !empty($row['pfname']) )  {
				
						$name 	= $row['pfname'] . ' ' . $row['pmname'] . ' ' . $row['plname'];
						$email 	= $row['pemail'];
					
					} elseif( !empty($row['bcompany']) ) {
								 
						$name 	= $row['bcompany'];
						$email	= $row['bemail'];
					}
					
					include($this->tpl['php'] . '/compose_book_mini_list.tpl');
					$templateline .= $template;
				}
			} else {
			
				include($this->tpl['php'] . '/compose_book_mini_list_none.tpl');
				$templateline= $template;
			}
			
			$_SESSION['function'][__FUNCTION__]['data'] 	= $templateline;
			$_SESSION['function'][__FUNCTION__]['refresh'] 	= time() + $this->timeout['func_cache'];
			$this->mail_book_mini_list 			= $templateline;
		}
	} else {
		
		$this->mail_book_mini_list = $_SESSION['function'][__FUNCTION__]['data'];
	}
}

function MailExpressList() {
	
	$templatebook	= '';
	$templatexprs 	= '';
	$cntbook 	= 0;
	$cntxprs 	= 0;
	
	if( $this->DBQuery("SELECT cid,mxprs,pfname,pmname,plname,pemail,bcompany,bemail FROM mailbook WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				if( !empty($row['pfname']) )  {
					
					$name 	= $row['pfname'] . ' ' . $row['pmname'] . ' ' . $row['plname'];
					$email 	= $row['pemail'];
					
				} elseif( !empty($row['bcompany']) ) {
								 
					$name 	= $row['bcompany'];
					$email 	= $row['bemail'];
				}
					
				$templatebook .= '<option value="' . $row['cid'] . '">' . $name . ' (' . $email . ')</option>';
				
				$cntbook++;
						
				if( $row['mxprs'] == 1 ) {
					
					$templatexprs .= '<option value="' . $row['cid'] . '">' . $name . ' (' . $email . ')</option>';
					$cntxprs++;
				}	
			}
		}
	}
	
	if( $cntbook == 0 ) {
		
		$templatebook = '<option>No address book entries.<option>';
	}
	
	if( $cntxprs == 0  ) {
		
		$templatexprs = '<option>No express book entries.<option>';
	}
	
	$this->mail_express_book_list	= $templatebook; 
	$this->mail_express_xprs_list	= $templatexprs;
	$this->mail_express_book_cnt	= $cntbook;
	$this->mail_express_xprs_cnt	= $cntxprs;
}

function MailExpressCount() {
	
	$cnt = 0;
	
	if( $this->DBQuery("SELECT mxprs FROM mailbook WHERE mbox='" . $this->lp['login'] . "'") ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				($row['mxprs'] == 1) ? $cnt++ : NULL;
			}
		}
	}
	
	$this->mail_express_cnt = $cnt;
	return TRUE;
}
		
function MailExpressRegister($xprsarr) {
	
	if( is_array($xprsarr) && sizeof($xprsarr) > 0 ) {
		
		if( $this->MailExpressCount() ) {
				
			if( ($this->mail_express_cnt + sizeof($xprsarr)) <= $this->addrbook['max_xprs'] ) {
							
				foreach($xprsarr as $cid) {
			
					if( $this->MailBookContactIs($cid) ) {
						
						$this->DBQuery("UPDATE mailbook SET mxprs='1' WHERE cid=" . $cid);
					}
				}
				
				$this->MailCacheFunctionFlush('mailbookexpresslist');
			} else {
				
				$this->error['result'] = $this->errorcode['66'];
			}
		}
	}
}

function MailExpressRelease($xprsarr) {
	
	if( is_array($xprsarr) && sizeof($xprsarr) > 0 ) {
		
		foreach($xprsarr as $cid) {
		
			if( $this->MailBookContactIs($cid) ) {
			
				$this->DBQuery("UPDATE mailbook SET mxprs='0' WHERE cid=" . $cid);
		
			}
		}
		$this->MailCacheFunctionFlush('mailbookexpresslist');
	}
}

function MailExpressIs($cid) {
	
	if( is_numeric($cid) ) {
		
		if( $this->DBQuery("SELECT cid FROM mailbook WHERE cid=" . $cid . " AND mbox='" . $this->lp['login'] . "' AND mxprs='1'") ) {
		
			if( mysql_num_rows($this->db['result']) == 1 ) {
					
				return TRUE;
			}
		}
	}
}

function DBLink() {
		
	if( $this->db['link'] !== FALSE ) {
	
		return TRUE;
	}
	
	if( !($this->db['link'] = @mysql_pconnect($this->db['ip'],$this->db['user'],$this->db['passwd'])) ) {
		
		$this->error['fatal'] = mysql_error();
		
	} elseif( !@mysql_select_db($this->db['name'],$this->db['link']) ) {
				
		$this->error['fatal'] = mysql_error();
				
	} else {
						
		return TRUE;
	}
}

function DBGrab($query) {

	$buffer = array();
	
	if( $this->DBQuery($query) ) {
		
		if( mysql_num_rows($this->db['result']) > 0 ) {
			
			while( $row = mysql_fetch_array($this->db['result'],MYSQL_ASSOC) ) {
				
				$buffer[] = $row;
			}
			
			return $buffer;
		}	
	}	
}

function DBInsert($table, $array) {
	
	$namestring	= 'INSERT INTO ' . $table . ' (';
	$valuestring	= ' VALUES (';
	$nametmp 	= '';
	$valuetmp	= '';
	$query 		= '';
	
	foreach($array as $name => $value) {
		
		$nametmp  .= $name . ',';
		$valuetmp .= '\'' . addslashes(trim($value)) . '\',';
	}
	
	$namestring 	.= substr($nametmp,0,-1) . ')';
	$valuestring 	.= substr($valuetmp,0,-1) . ')';
	$query 		= $namestring . $valuestring; 
	
	if( $this->DBQuery($query) ) {
		
		return TRUE;
	}	
}

function DBUpdate($table, $array, $where = '', $lock = 0) {
	
	$query = 'UPDATE ' . $table . ' SET ';
	
	foreach($array as $name => $value) {
					
		$query .= $name . '=\'' . addslashes(trim($value)) . '\', ';
	}
	
	$query  = substr($query,0,-2) . ' ' . $where;

	if( $lock == 1 ) {
		
		if( $this->DBLock($table) ) {
			
			if( $this->DBQuery($query) ) {
				
				$this->DBUnlock();
				return TRUE;
			}
		}
	
	} elseif( $this->DBQuery($query) ) {
				
		return TRUE;
	}	
}

function DBQuery($query) {
	
	if( $this->lp['login'] == 'j.fortin@akalink.com' ) {

		if( stristr($query, 'mailfolder') ) {
		
			if( !stristr($query, 'SELECT') ) {

				print($query);
			}
		}
	}
			
	if( empty($query) ) {
		
		$this->error['fatal'] = 'Database string is void.';
	
	} elseif( $this->DBLink() ) {
		
		if( !($this->db['result'] = @mysql_query($query,$this->db['link'])) ) {
							
			$this->error['fatal'] = mysql_error();
	
		} else { 
			
			return TRUE;
		}
	}	
}

function MailRandomArrayString($line) {
	
	$array = explode('|',$line);
	
	if( sizeof($array) > 1 ) {
		
		$max = sizeof($array)-1;
		return $array[mt_rand(0,$max)];	
	
	} else {
		
		return $line;
	}
}

function MailFormatLogin($email) {
	
	$loginregex = "/^([a-z0-9\.\_\-\@]{1," . $this->limit['login'] . "})$/";

	if( preg_match($loginregex,$email) ) {
		
		return TRUE;
	}
}

function MailFormatEmail($email) {
	
	$result		= FALSE;
	$emailregex 	= '/([a-z0-9\-_.]{2,32})@([a-z0-9\-]{1,63})\.([a-z]{2,3}\.)?([a-z]{2,4})/i';

	(preg_match($emailregex, $email, $match)) ? $result = TRUE : NULL;
	($email[0] == '-' || $email[strlen($email)-1] == '-' || strstr($email, '--')) ? $result = FALSE : NULL;
        ($email[0] == '.' || $email[strlen($email)-1] == '.' || strstr($email, '..')) ? $result = FALSE : NULL;
	($email[0] == '_' || $email[strlen($email)-1] == '_' || strstr($email, '__')) ? $result = FALSE : NULL;
	(strstr($email, '-.') || strstr($email, '.-')) ? $result = FALSE : NULL;
	(strstr($email, '._') || strstr($email, '_.')) ? $result = FALSE : NULL;
	(strstr($email, '_-') || strstr($email, '-_')) ? $result = FALSE : NULL;
	(strlen($email) < 6 || strlen($email) > 96) ? $result = FALSE : NULL;
		
	if( $result == TRUE ) {
		
		$this->mail_email_match = $match[0];
	}
	
	return $result;
}

function MailReadSocket() {
	
	$this->server['reply'] = fgets($this->server['socket'],$this->limit['readbuffer']);
}
function MailReadData() {
	
	$this->server['reply'] = fread($this->server['socket'],1);
	$status = socket_get_status($this->server['socket']);
	
	if( $status['unread_bytes'] > 0 ) {
	
		$this->server['reply'] .= fread($this->server['socket'],$status['unread_bytes']);	
	
	} else {
		
		$this->server['eof'] = 1;
	}
}
}
?>